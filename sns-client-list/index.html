<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Client List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://esm.sh; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com; img-src 'self' data: blob: https://*.supabase.co; font-src 'self'; frame-src https://js.stripe.com;" />
  <script>
  // Mobile redirect for SNS Client List
  (function () {
    const isMobile = window.matchMedia("(max-width: 820px)").matches;
    const isAlreadyMobilePage = window.location.pathname.endsWith("/mobile.html");
    if (isMobile && !isAlreadyMobilePage) {
      // Keep same folder, just swap to mobile.html
      window.location.replace("./mobile.html");
    }
  })();
</script>
  <link rel="stylesheet" href="/styles.css" />

  <style>
    html, body { height: 100%; }
    body { margin:0; min-height: 100vh; background: radial-gradient(circle at top, #342067, #050315 55%, #020010); color:#f4f0ff;
           font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    *, *::before, *::after { box-sizing: border-box; }

    .wrap{
      width: min(1600px, calc(100% - 32px));
      margin: 0 auto;
      padding: 3rem 0 4rem;
    }

    .toprow { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; }
    h1 { margin:0; letter-spacing:.18em; text-transform:uppercase; }
    .sub { color:#bdb7ff; margin-top:.6rem; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .95rem; border-radius:999px;
            border:1px solid rgba(129,118,255,.35); background: rgba(9,6,34,.65); color:#d9d3ff; font-size:.85rem; }

    .top-actions{ display:flex; align-items:center; justify-content:flex-end; gap:.6rem; flex-wrap:wrap; }
    .top-actions .pill{ margin:0; }

    .card {
      margin-top: 1.75rem;
      background: rgba(9, 6, 34, 0.9);
      border: 1px solid rgba(130, 106, 255, 0.3);
      border-radius: 28px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(16px);
      padding: 1.25rem 1.25rem 1.1rem;
    }

    /* Buttons */
    .btn {
      border-radius:999px;
      padding:.65rem 1.05rem;
      border:1px solid rgba(129,118,255,.35);
      background: rgba(15, 10, 55, 0.8);
      color:#f4f0ff;
      cursor:pointer;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.78rem;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
      white-space:nowrap;
    }
    .btn:hover { transform: translateY(-1px); border-color:#b37cff; box-shadow:0 0 0 1px rgba(179,124,255,.35); filter:brightness(1.05); }
    .btn:active { transform: translateY(1px); }

    .btn-soft{ background: rgba(15, 10, 55, 0.55); border-color: rgba(129,118,255,.28); }
    .btn-primary{ background: rgba(179,124,255,.18); border-color: rgba(179,124,255,.45); }
    .btn-primary:hover{ border-color:#b37cff; box-shadow:0 0 0 1px rgba(179,124,255,.35); }
    .btn-danger { border-color: rgba(255,98,98,.45); }
    .btn-danger:hover { border-color:#ff6262; box-shadow:0 0 0 1px rgba(255,98,98,.25); }

    /* Icon button */
    .icon-btn{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(129,118,255,.35);
      background: rgba(15, 10, 55, 0.70);
      color: #d9d3ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
      user-select: none;
    }
    .icon-btn:hover{ transform: translateY(-1px); border-color:#b37cff; box-shadow:0 0 0 1px rgba(179,124,255,.35); filter:brightness(1.05); }
    .icon-btn:active{ transform: translateY(1px); }
    .icon-btn svg{ width: 18px; height: 18px; opacity: .95; }

    /* Toolbar */
    .toolbar-grid{
      display: grid;
      grid-template-columns: auto auto;
      justify-content: space-between;
      gap: .85rem 1rem;
      align-items: start;
      margin-bottom: 1rem;
      padding-bottom: .9rem;
      border-bottom: 1px solid rgba(129,118,255,.14);
    }
    .toolgroup{ display:flex; flex-direction:column; gap:.5rem; }
    .toolgroup-right{ justify-self:end; text-align:right; }
    .toolrow{ display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }
    .tooltitle{ color:#cfc8ff; font-size:.78rem; letter-spacing:.12em; text-transform:uppercase; }

    @media (max-width: 780px){
      .toolbar-grid{ grid-template-columns: 1fr; }
      .toolgroup-right{ justify-self:start; text-align:left; }
    }

    /* Inputs */
    .input{
      padding:.7rem 1rem;
      border-radius:999px;
      border:1px solid rgba(129,118,255,.35);
      background: rgba(9,6,34,.95);
      color:#f4f0ff;
      outline:none;
      width: min(520px, 100%);
    }
    .input:focus{ border-color:#9c88ff; box-shadow:0 0 0 1px rgba(156,136,255,.55); }

    /* Table */
    table { width:100%; border-collapse: collapse; }
    th, td { padding: .85rem .6rem; border-bottom: 1px solid rgba(129,118,255,.18); color:#e9e5ff; font-size:.92rem; text-align:left; vertical-align: middle; }
    th { color:#cfc8ff; font-size:.78rem; letter-spacing:.12em; text-transform:uppercase; }
    .muted { color:#bdb7ff; font-size:.85rem; }

    /* Status */
    .tag{
      display:inline-flex; align-items:center; gap:.45rem;
      border-radius:999px; padding:.42rem .7rem;
      border:1px solid rgba(129,118,255,.28);
      background: rgba(15, 10, 55, 0.55);
      font-size:.76rem; letter-spacing:.10em; text-transform:uppercase;
      color:#e9e5ff;
    }
    .dot{ width:10px; height:10px; border-radius:999px; box-shadow: 0 0 0 2px rgba(255,255,255,.06); display:inline-block; }
    .dot-green{ background:#6cffb0; }
    .dot-blue{ background:#7bb8ff; }
    .dot-yellow{ background:#ffd45a; }
    .dot-red{ background:#ff6262; }
    .dot-gray{ background: rgba(255,255,255,.18); }

    /* Row hover animation */
    tbody tr{ transition: transform .10s ease, background .12s ease; }
    tbody tr:hover{ transform: translateY(-1px); background: rgba(196,181,253,.05); }

    /* Messages */
    .err { margin-top:.8rem; color:#ff9494; font-size:.9rem; display:none; }
    .ok  { margin-top:.8rem; color:#7af9c4; font-size:.9rem; display:none; }

    /* Modal */
    .modal{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 1rem;
      z-index: 9999;
    }
    .modal.open{ display:flex; }
    .modal-card{
      width: min(920px, 100%);
      border-radius: 26px;
      border: 1px solid rgba(130, 106, 255, 0.35);
      background: rgba(9, 6, 34, 0.95);
      box-shadow: 0 30px 90px rgba(0,0,0,.75);
      backdrop-filter: blur(16px);
      padding: 1.2rem 1.2rem 1rem;
      position: relative;
      animation: pop .14s ease-out;
    }
    @keyframes pop{ from{ transform: translateY(10px) scale(.985); opacity: .0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    .modal-title{ margin:0; letter-spacing:.14em; text-transform:uppercase; font-size:1rem; }
    .modal-sub{ margin:.55rem 0 0; color:#bdb7ff; font-size:.9rem; line-height:1.45; }

    .close{
      position:absolute; top: 14px; right: 14px;
      width: 36px; height: 36px;
      border-radius: 999px;
      border: 1px solid rgba(129,118,255,.28);
      background: rgba(15, 10, 55, 0.55);
      color: #f4f0ff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease, filter .12s ease;
    }
    .close:hover{ transform: translateY(-1px); border-color: rgba(179,124,255,.55); filter: brightness(1.08); }
    .close:active{ transform: translateY(1px); }
    .close svg{ width: 16px; height: 16px; opacity: .9; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: .75rem .85rem; margin-top: 1rem; }
    @media (max-width: 820px){ .grid{ grid-template-columns: 1fr; } }

    .kv{
      border-radius: 18px;
      border: 1px solid rgba(129,118,255,.18);
      background: rgba(15, 10, 55, 0.40);
      padding: .75rem .85rem;
    }
    .k{ color:#cfc8ff; font-size:.72rem; letter-spacing:.12em; text-transform:uppercase; margin-bottom:.35rem; }
    .v{ color:#f4f0ff; font-size:.95rem; word-break: break-word; }

    /* Login overlay */
    .overlay { position:fixed; inset:0; background: rgba(0,0,0,.55); backdrop-filter: blur(8px);
               display:flex; align-items:center; justify-content:center; padding: 1rem; z-index: 9999; }
    .login-card { width: min(520px, 100%); background: rgba(9, 6, 34, 0.95); border: 1px solid rgba(130, 106, 255, 0.35);
                  border-radius: 28px; box-shadow: 0 25px 90px rgba(0, 0, 0, 0.75); padding: 1.75rem 1.5rem 1.4rem; position: relative; }
    .login-title { margin:0; letter-spacing:.16em; text-transform:uppercase; font-size:1.05rem; }
    .login-sub { margin:.6rem 0 1.1rem; color:#bdb7ff; line-height:1.45; font-size:.9rem; }
    .field label { display:block; margin:.7rem 0 .35rem; font-size:.78rem; color:#d5cffc; letter-spacing:.1em; text-transform:uppercase; }
    .field input { width:100%; border-radius: 999px; border: 1px solid rgba(129,118,255,.35); background: rgba(9,6,34,.95);
                   color:#f4f0ff; padding:.75rem 1rem; outline:none; padding-right: 3rem; }
    .field input:focus { border-color:#9c88ff; box-shadow:0 0 0 1px rgba(156,136,255,.55); }
    .login-actions { display:flex; gap:.7rem; justify-content:space-between; align-items:center; margin-top: 1.1rem; flex-wrap:wrap; }
    .tiny { font-size:.8rem; color:#9ea0d7; }
    .login-close{ position:absolute; top: 14px; right: 14px; width: 36px; height: 36px; border-radius: 999px;
                  border: 1px solid rgba(129,118,255,.28); background: rgba(15, 10, 55, 0.55); color: #f4f0ff;
                  display:flex; align-items:center; justify-content:center; cursor:pointer;
                  transition: transform .08s ease, border-color .12s ease, filter .12s ease; }
    .login-close:hover{ transform: translateY(-1px); border-color: rgba(179,124,255,.55); filter: brightness(1.08); }
    .login-close:active{ transform: translateY(1px); }
    .login-close svg{ width: 16px; height: 16px; opacity: .9; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toprow">
      <div>
        <h1>SNS CLIENT LIST</h1>
        <div class="sub">Admin-only client registry</div>
      </div>

      <div class="top-actions">
        <span class="pill" id="whoami">Not signed in</span>

        <a class="icon-btn" href="/sns-admin/index.html" title="Back to Admin" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>

    <div class="card" id="adminCard" style="display:none;">
      <div class="toolbar-grid">
        <div class="toolgroup">
          <div class="tooltitle">Subscription</div>
          <div class="toolrow">
            <button class="btn btn-soft" data-filter="all" id="fAll">All</button>
            <button class="btn btn-soft" data-filter="active" id="fActive">Active</button>
            <button class="btn btn-soft" data-filter="trialing" id="fTrialing">Trialing</button>
            <button class="btn btn-soft" data-filter="inactive" id="fInactive">Inactive</button>
            <button class="btn btn-soft" data-filter="never" id="fNever">Never Purchased</button>
          </div>
        </div>

        <div class="toolgroup toolgroup-right">
          <div class="tooltitle">Manage</div>
          <div class="toolrow">
            <button class="btn btn-primary" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="toolgroup">
          <div class="tooltitle">Search</div>
          <div class="toolrow">
            <input id="searchBox" class="input" type="text" placeholder="Search name, business, email, phone..." />
          </div>
        </div>

        <div class="toolgroup toolgroup-right">
          <div class="tooltitle">Summary</div>
          <div class="toolrow">
            <span class="pill" id="summaryPill">0 clients</span>
          </div>
        </div>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:190px;">Subscription</th>
              <th>Name</th>
              <th>Business</th>
              <th style="width:190px;">Phone</th>
              <th style="width:210px; text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="muted" id="meta" style="margin-top:.8rem;"></div>

      <div class="muted" style="margin-top:.8rem;">© 2025 kxsaku · Built from the homelab.</div>
    </div>
  </div>

  <div class="overlay" id="loginOverlay" style="display:none;">
    <div class="login-card">
      <button class="login-close" id="loginCloseBtn" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>

      <h2 class="login-title">Admin login</h2>
      <p class="login-sub">Sign in to view the client registry.</p>

      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" placeholder="Email">
      </div>

      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••">
      </div>

      <div class="login-actions">
        <span class="tiny" id="loginHint"></span>
        <button class="btn" id="loginBtn">Sign in</button>
      </div>

      <div class="err" id="loginErr" style="display:none;"></div>
    </div>
  </div>

  <div class="modal" id="detailsModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <button class="close" id="closeModalBtn" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>

      <h3 class="modal-title" id="detailsTitle">Client details</h3>
      <p class="modal-sub" id="detailsSub"></p>

      <div class="grid" id="detailsGrid"></div>

      <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top: 1rem; flex-wrap:wrap;">
        <button class="btn btn-soft" id="copyJsonBtn" type="button">Copy JSON</button>
        <button class="btn btn-primary" id="closeModalBtn2" type="button">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" integrity="sha384-0cJhvyxOncqJDixLuJRbH99K17F1B6DH3D8aUBlsJlsgiqRZQpQ1EUFWdgscplLu" crossorigin="anonymous"></script>

  <script>
    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const ADMIN_EMAIL = "brandon.sns@pm.me";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const adminCard = document.getElementById("adminCard");
    const whoami = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");

    const errBox = document.getElementById("errBox");
    const okBox = document.getElementById("okBox");
    const rowsEl = document.getElementById("rows");
    const metaEl = document.getElementById("meta");
    const summaryPill = document.getElementById("summaryPill");

    const searchBox = document.getElementById("searchBox");
    const refreshBtn = document.getElementById("refreshBtn");

    const loginOverlay = document.getElementById("loginOverlay");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass  = document.getElementById("loginPass");
    const loginBtn   = document.getElementById("loginBtn");
    const loginErr   = document.getElementById("loginErr");
    const loginHint  = document.getElementById("loginHint");
    const loginCloseBtn = document.getElementById("loginCloseBtn");

    const detailsModal = document.getElementById("detailsModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const closeModalBtn2 = document.getElementById("closeModalBtn2");
    const detailsTitle = document.getElementById("detailsTitle");
    const detailsSub = document.getElementById("detailsSub");
    const detailsGrid = document.getElementById("detailsGrid");
    const copyJsonBtn = document.getElementById("copyJsonBtn");

    let allClients = [];
    let currentFilter = "all";
    let selectedClientForCopy = null;

    function showErr(msg){ errBox.style.display = "block"; errBox.textContent = msg || "Unknown error"; okBox.style.display = "none"; }
    function showOk(msg){ okBox.style.display = "block"; okBox.textContent = msg || "OK"; errBox.style.display = "none"; }
    function clearMsgs(){ errBox.style.display = "none"; okBox.style.display = "none"; errBox.textContent = ""; okBox.textContent = ""; }

    function fmtDate(ts){ if (!ts) return "—"; const d = new Date(ts * 1000); return d.toLocaleString([], { year:"numeric", month:"short", day:"2-digit" }); }
    function fmtMoney(amountCents, currency){
      if (amountCents == null) return "—";
      const cur = (currency || "usd").toUpperCase();
      const dollars = Number(amountCents) / 100;
      try { return new Intl.NumberFormat(undefined, { style:"currency", currency: cur }).format(dollars); }
      catch { return `${dollars.toFixed(2)} ${cur}`; }
    }
    function fmtAge(createdTs){
      if (!createdTs) return "—";
      const ms = Date.now() - (createdTs * 1000);
      const days = Math.max(0, Math.floor(ms / 86400000));
      if (days < 1) return "Today";
      if (days === 1) return "1 day";
      if (days < 30) return `${days} days`;
      const months = Math.floor(days / 30);
      if (months === 1) return "1 month";
      if (months < 24) return `${months} months`;
      const years = Math.floor(months / 12);
      return years === 1 ? "1 year" : `${years} years`;
    }

    function normalize(s){ return (s || "").toString().trim(); }
    function includesCI(hay, needle){ return normalize(hay).toLowerCase().includes(normalize(needle).toLowerCase()); }

    function getCategory(client){
      const cat = normalize(client?.subscription?.category).toLowerCase();
      if (["active","trialing","inactive","never"].includes(cat)) return cat;

      const st = normalize(client?.subscription?.status).toLowerCase();
      if (st === "active") return "active";
      if (st === "trialing") return "trialing";

      const hasStripe = !!(client?.subscription?.stripe_customer_id || client?.subscription?.stripe_subscription_id);
      const hasPaid = (client?.subscription?.total_paid_cents ?? null) != null && Number(client.subscription.total_paid_cents) > 0;
      if (hasStripe || hasPaid) return "inactive";
      return "never";
    }

    function statusTag(client){
      const cat = getCategory(client);
      if (cat === "active")   return `<span class="tag"><span class="dot dot-green"></span>Active</span>`;
      if (cat === "trialing") return `<span class="tag"><span class="dot dot-yellow"></span>Trialing</span>`;
      if (cat === "inactive") return `<span class="tag"><span class="dot dot-red"></span>Inactive</span>`;
      return `<span class="tag"><span class="dot dot-gray"></span>Never Purchased</span>`;
    }

    async function callEdge(fnName, payload = {}){
      const { data: sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) throw new Error("Not logged in.");

      let res;
      try{
        res = await fetch(`${SUPABASE_URL}/functions/v1/${fnName}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
      }catch(fetchErr){
        // Most common causes: missing Edge Function deployment, network/CORS error, adblock, or blocked third-party requests.
        throw new Error(fetchErr?.message || "NetworkError when attempting to fetch resource.");
      }
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error || "Request failed");
      return j;
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll("\"","&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    function render(){
      const q = normalize(searchBox.value);
      let list = allClients.slice();

      if (currentFilter !== "all") list = list.filter(c => getCategory(c) === currentFilter);

      if (q){
        list = list.filter(c => {
          const p = c.profile || c;
          return (
            includesCI(p.full_name, q) ||
            includesCI(p.business_name, q) ||
            includesCI(p.email, q) ||
            includesCI(p.phone, q)
          );
        });
      }

      rowsEl.innerHTML = list.map(c => {
        const p = c.profile || c;
        const id = p.user_id || c.user_id || "";
        const name = normalize(p.full_name) || normalize(p.name) || "—";
        const biz  = normalize(p.business_name) || "—";
        const phone = normalize(p.phone) || "—";

        return `
          <tr>
            <td>${statusTag(c)}</td>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(biz)}</td>
            <td>${escapeHtml(phone)}</td>
            <td style="text-align:right;">
              <button class="btn btn-primary" data-view="${escapeAttr(id)}">View</button>
            </td>
          </tr>
        `;
      }).join("");

      summaryPill.textContent = `${list.length} client${list.length === 1 ? "" : "s"}`;
      metaEl.textContent = allClients.length ? `Loaded ${allClients.length} total. Filter: ${currentFilter.toUpperCase()}` : "";
    }

    function openModal(client){
      selectedClientForCopy = client;
      const p = client.profile || client;
      const cat = getCategory(client).toUpperCase();
      const st = normalize(client?.subscription?.status).toUpperCase() || cat;

      detailsTitle.textContent = "Client details";
      detailsSub.textContent = `${normalize(p.full_name) || "Client"} · ${cat} (${st})`;

      const sub = client.subscription || {};
      const fields = [
        ["Subscription category", cat],
        ["Stripe status", normalize(sub.status) || "—"],
        ["Subscription started", fmtDate(sub.created_ts)],
        ["Next payment due", fmtDate(sub.current_period_end_ts)],
        ["Total paid (lifetime)", fmtMoney(sub.total_paid_cents, sub.currency)],
        ["Subscription age", fmtAge(sub.created_ts)],

        ["Full name", normalize(p.full_name) || "—"],
        ["Business name", normalize(p.business_name) || "—"],
        ["Phone", normalize(p.phone) || "—"],
        ["Email", normalize(p.email) || "—"],

        ["Business location", normalize(p.business_location) || normalize(p.location) || "—"],
        ["Address", normalize(p.address) || "—"],
        ["City", normalize(p.city) || "—"],
        ["State", normalize(p.state) || "—"],
        ["ZIP", normalize(p.zip) || "—"],

        ["User ID", normalize(p.user_id || client.user_id) || "—"],
        ["Stripe customer id", normalize(sub.stripe_customer_id) || "—"],
        ["Stripe subscription id", normalize(sub.stripe_subscription_id) || "—"],
      ];

      detailsGrid.innerHTML = fields.map(([k,v]) => `
        <div class="kv">
          <div class="k">${escapeHtml(k)}</div>
          <div class="v">${escapeHtml(v)}</div>
        </div>
      `).join("");

      detailsModal.classList.add("open");
      detailsModal.setAttribute("aria-hidden","false");
    }

    function closeModal(){
      detailsModal.classList.remove("open");
      detailsModal.setAttribute("aria-hidden","true");
      selectedClientForCopy = null;
    }

    rowsEl.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-view]");
      if (!btn) return;
      const id = btn.getAttribute("data-view");
      const client = allClients.find(c => {
        const p = c.profile || c;
        return (p.user_id || c.user_id) === id;
      });
      if (client) openModal(client);
    });

    closeModalBtn.addEventListener("click", closeModal);
    closeModalBtn2.addEventListener("click", closeModal);
    detailsModal.addEventListener("click", (e) => { if (e.target === detailsModal) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && detailsModal.classList.contains("open")) closeModal(); });

    copyJsonBtn.addEventListener("click", async () => {
      if (!selectedClientForCopy) return;
      try { await navigator.clipboard.writeText(JSON.stringify(selectedClientForCopy, null, 2)); showOk("Copied client JSON to clipboard."); }
      catch { showErr("Copy failed (browser blocked clipboard)." ); }
    });

    document.querySelectorAll("[data-filter]").forEach(b => {
      b.addEventListener("click", () => { currentFilter = b.getAttribute("data-filter"); render(); });
    });

    searchBox.addEventListener("input", render);
    refreshBtn.addEventListener("click", () => loadClients(true));

    async function loadClients(force=false){
      clearMsgs();
      metaEl.textContent = force ? "Refreshing…" : "Loading…";
      rowsEl.innerHTML = "";

      try{
        const resp = await callEdge("admin-client-list", {});
        const list = Array.isArray(resp?.clients) ? resp.clients : [];
        allClients = list;
        render();
        metaEl.textContent = `Last sync: ${new Date().toLocaleString()}`;
      }catch(e){
        metaEl.textContent = "";
        showErr((e?.message || String(e)) + " — This page requires the Edge Function: admin-client-list.");
      }
    }

    async function ensureAdminOrShowLogin(){
      const { data: sess } = await sb.auth.getSession();
      const s = sess?.session;

      if (!s){ showLogin(); return; }

      const email = (s.user?.email || "").toLowerCase();
      if (email !== ADMIN_EMAIL.toLowerCase()){
        whoami.textContent = `Forbidden: ${s.user?.email || "unknown"}`;
        logoutBtn.style.display = "inline-flex";
        logoutBtn.onclick = async () => { await sb.auth.signOut(); location.reload(); };
        showErr("Forbidden. This page is admin-only.");
        return;
      }

      whoami.textContent = `Signed in: ${s.user.email}`;
      logoutBtn.style.display = "inline-flex";
      logoutBtn.onclick = async () => { await sb.auth.signOut(); location.reload(); };

      adminCard.style.display = "block";
      await loadClients(false);
    }

    function showLogin(){
      loginOverlay.style.display = "flex";
      loginErr.style.display = "none";
      loginHint.textContent = "";
      adminCard.style.display = "none";
      logoutBtn.style.display = "none";
      whoami.textContent = "Not signed in";
    }

    function hideLogin(){ loginOverlay.style.display = "none"; }

    loginCloseBtn.addEventListener("click", () => { location.href = "/sns/index.html"; });

    loginBtn.addEventListener("click", async () => {
      loginErr.style.display = "none";
      loginHint.textContent = "Signing in…";
      try{
        const email = normalize(loginEmail.value).toLowerCase();
        const pass  = normalize(loginPass.value);
        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if (error) throw error;
        hideLogin();
        loginHint.textContent = "";
        await ensureAdminOrShowLogin();
      }catch(e){
        loginHint.textContent = "";
        loginErr.style.display = "block";
        loginErr.textContent = e?.message || String(e);
      }
    });

    ensureAdminOrShowLogin();
  </script>
</body>
</html>
