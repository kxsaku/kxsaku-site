<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Client List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://esm.sh; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com; img-src 'self' data: blob: https://*.supabase.co; font-src 'self'; frame-src https://js.stripe.com; frame-ancestors 'none';" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <script>
  // Mobile redirect for SNS Client List
  (function () {
    const isMobile = window.matchMedia("(max-width: 820px)").matches;
    const isAlreadyMobilePage = window.location.pathname.endsWith("/mobile.html");
    if (isMobile && !isAlreadyMobilePage) {
      // Keep same folder, just swap to mobile.html
      window.location.replace("./mobile.html");
    }
  })();
</script>
  <link rel="stylesheet" href="/styles.css" />

  <style>
    /* ===========================================
       SNS Client List - Enhanced Page Styles
       =========================================== */

    /* Page entry animations */
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes scaleInBounce {
      0% { opacity: 0; transform: scale(0.9); }
      70% { transform: scale(1.02); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes pop {
      from { transform: translateY(10px) scale(.985); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    /* Page header enhanced */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .page-header h1 {
      margin: 0;
      font-size: 1.5rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      animation: slideInLeft 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .page-header .sub {
      margin-top: 0.4rem;
      animation: slideInLeft 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 50ms;
    }

    .page-header-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    /* Admin panel card enhanced */
    .admin-panel {
      background: linear-gradient(165deg, rgba(15, 10, 45, 0.95), rgba(8, 5, 28, 0.90));
      border: 1px solid rgba(130, 106, 255, 0.25);
      border-radius: 28px;
      box-shadow:
        0 25px 80px rgba(0, 0, 0, 0.55),
        0 0 0 1px rgba(255, 255, 255, 0.03) inset,
        0 1px 0 rgba(255, 255, 255, 0.05) inset;
      padding: 1.5rem;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
      animation-delay: 100ms;
    }

    .admin-panel::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: radial-gradient(ellipse 600px 200px at 30% 0%, rgba(179, 124, 255, 0.12), transparent);
      pointer-events: none;
    }

    /* Enhanced toolbar grid */
    .toolbar-grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .toolgroup {
      background: linear-gradient(180deg, rgba(10, 6, 32, 0.6), rgba(8, 5, 28, 0.5));
      border: 1px solid rgba(129, 118, 255, 0.12);
      border-radius: 18px;
      padding: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .toolgroup:hover {
      border-color: rgba(129, 118, 255, 0.22);
    }

    .tooltitle {
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(189, 183, 255, 0.75);
      margin-bottom: 0.65rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(129, 118, 255, 0.1);
    }

    .toolrow {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* Enhanced search input */
    .input {
      width: min(520px, 100%);
      border-radius: 999px;
      border: 1px solid rgba(129, 118, 255, 0.3);
      background: linear-gradient(180deg, rgba(10, 6, 32, 0.95), rgba(8, 5, 28, 0.98));
      color: var(--color-text-primary);
      padding: 0.8rem 1.15rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
    }

    .input::placeholder { color: rgba(189, 183, 255, 0.4); }
    .input:hover { border-color: rgba(129, 118, 255, 0.45); }
    .input:focus {
      border-color: rgba(179, 124, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(179, 124, 255, 0.15), 0 4px 20px rgba(0, 0, 0, 0.2);
      background: rgba(12, 8, 36, 0.98);
    }

    /* Enhanced tag styling */
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.38rem 0.75rem;
      border: 1px solid rgba(129, 118, 255, 0.28);
      background: linear-gradient(180deg, rgba(15, 10, 55, 0.6), rgba(12, 8, 45, 0.55));
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: #e9e5ff;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .tag:hover { transform: scale(1.03); }

    /* Dot colors enhanced */
    .dot-blue { background: #7bb8ff; box-shadow: 0 0 8px rgba(123, 184, 255, 0.5); }
    .dot-gray { background: rgba(255, 255, 255, 0.25); }
    .dot-green { box-shadow: 0 0 8px rgba(108, 255, 176, 0.5); }
    .dot-yellow { box-shadow: 0 0 8px rgba(255, 212, 90, 0.5); }
    .dot-red { box-shadow: 0 0 8px rgba(255, 98, 98, 0.5); }

    /* Enhanced table wrapper */
    .table-wrapper {
      border-radius: 20px;
      border: 1px solid rgba(129, 118, 255, 0.15);
      overflow: hidden;
      background: linear-gradient(180deg, rgba(10, 6, 32, 0.5), rgba(8, 5, 28, 0.4));
      position: relative;
      z-index: 1;
    }

    /* Table row animations */
    tbody tr {
      transition:
        transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.2s ease,
        box-shadow 0.2s ease;
      animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    tbody tr:nth-child(1) { animation-delay: 0ms; }
    tbody tr:nth-child(2) { animation-delay: 30ms; }
    tbody tr:nth-child(3) { animation-delay: 60ms; }
    tbody tr:nth-child(4) { animation-delay: 90ms; }
    tbody tr:nth-child(5) { animation-delay: 120ms; }
    tbody tr:nth-child(6) { animation-delay: 150ms; }
    tbody tr:nth-child(7) { animation-delay: 180ms; }
    tbody tr:nth-child(8) { animation-delay: 210ms; }
    tbody tr:nth-child(9) { animation-delay: 240ms; }
    tbody tr:nth-child(10) { animation-delay: 270ms; }

    tbody tr:hover {
      transform: translateX(3px);
      background: rgba(179, 124, 255, 0.06);
    }

    /* Enhanced modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(3, 1, 15, 0.75);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9999;
    }
    .modal.open { display: flex; }

    .modal-card {
      width: min(920px, 100%);
      border-radius: 28px;
      border: 1px solid rgba(130, 106, 255, 0.35);
      background: linear-gradient(170deg, rgba(18, 12, 48, 0.98), rgba(10, 6, 32, 0.99));
      box-shadow:
        0 30px 100px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.03) inset,
        0 1px 0 rgba(255, 255, 255, 0.05) inset;
      backdrop-filter: blur(20px);
      padding: 1.5rem;
      position: relative;
      animation: scaleInBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
      overflow: hidden;
    }

    .modal-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 150px;
      background: radial-gradient(ellipse 400px 150px at 30% 0%, rgba(179, 124, 255, 0.15), transparent);
      pointer-events: none;
    }

    .modal-title {
      position: relative;
      margin: 0;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 1.05rem;
    }

    .modal-sub {
      position: relative;
      margin: 0.6rem 0 0;
      color: rgba(189, 183, 255, 0.75);
      font-size: 0.9rem;
      line-height: 1.45;
    }

    .close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 1px solid rgba(129, 118, 255, 0.25);
      background: rgba(15, 10, 45, 0.6);
      color: #f4f0ff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition:
        transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1),
        border-color 0.2s ease,
        background 0.2s ease;
      z-index: 1;
    }

    .close:hover {
      transform: scale(1.08) rotate(90deg);
      border-color: rgba(179, 124, 255, 0.45);
      background: rgba(20, 15, 55, 0.8);
    }

    .close:active { transform: scale(0.95) rotate(90deg); }
    .close svg { width: 16px; height: 16px; opacity: 0.9; }

    /* Modal detail grid enhanced */
    .grid {
      position: relative;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem 0.85rem;
      margin-top: 1.25rem;
    }
    @media (max-width: 820px) { .grid { grid-template-columns: 1fr; } }

    .kv {
      border-radius: 16px;
      border: 1px solid rgba(129, 118, 255, 0.18);
      background: linear-gradient(180deg, rgba(15, 10, 55, 0.45), rgba(10, 6, 32, 0.4));
      padding: 0.85rem 1rem;
      transition: border-color 0.2s ease, transform 0.15s ease;
    }

    .kv:hover {
      border-color: rgba(129, 118, 255, 0.32);
      transform: translateY(-1px);
    }

    .k {
      color: rgba(207, 200, 255, 0.8);
      font-size: 0.70rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 0.4rem;
    }

    .v {
      color: #f4f0ff;
      font-size: 0.95rem;
      word-break: break-word;
      line-height: 1.4;
    }

    /* Enhanced button micro-interactions */
    .btn {
      transition:
        transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1),
        box-shadow 0.2s ease,
        border-color 0.2s ease,
        background 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 24px rgba(179, 124, 255, 0.35);
    }

    /* Pill enhanced */
    .pill {
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .pill:hover {
      transform: scale(1.02);
    }

    /* Footer styling */
    .page-footer {
      margin-top: 1.5rem;
      text-align: center;
      font-size: 0.82rem;
      color: rgba(189, 183, 255, 0.45);
      animation: slideInUp 0.5s ease both;
      animation-delay: 300ms;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Page Header -->
    <header class="page-header">
      <div>
        <h1>SNS CLIENT LIST</h1>
        <div class="sub">Admin-only client registry</div>
      </div>

      <div class="page-header-actions">
        <span class="pill" id="whoami">Not signed in</span>

        <a class="icon-btn" href="/sns-admin/index.html" title="Back to Admin" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </header>

    <!-- Main Admin Panel -->
    <div class="admin-panel" id="adminCard" style="display:none;">
      <div class="toolbar-grid">
        <div class="toolgroup">
          <div class="tooltitle">Subscription</div>
          <div class="toolrow">
            <button class="btn btn-soft" data-filter="all" id="fAll">All</button>
            <button class="btn btn-soft" data-filter="active" id="fActive">Active</button>
            <button class="btn btn-soft" data-filter="trialing" id="fTrialing">Trialing</button>
            <button class="btn btn-soft" data-filter="inactive" id="fInactive">Inactive</button>
            <button class="btn btn-soft" data-filter="never" id="fNever">Never Purchased</button>
          </div>
        </div>

        <div class="toolgroup toolgroup-right">
          <div class="tooltitle">Manage</div>
          <div class="toolrow">
            <button class="btn btn-primary" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="toolgroup">
          <div class="tooltitle">Search</div>
          <div class="toolrow">
            <input id="searchBox" class="input" type="text" placeholder="Search name, business, email, phone..." />
          </div>
        </div>

        <div class="toolgroup toolgroup-right">
          <div class="tooltitle">Summary</div>
          <div class="toolrow">
            <span class="pill" id="summaryPill">0 clients</span>
          </div>
        </div>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <!-- Table Section -->
      <div class="table-wrapper">
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:190px;">Subscription</th>
                <th>Name</th>
                <th>Business</th>
                <th style="width:190px;">Phone</th>
                <th style="width:210px; text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>

      <div class="muted" id="meta" style="margin-top:1rem;"></div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
      © 2025 kxsaku · Built from the homelab.
    </footer>
  </div>

  <div class="overlay" id="loginOverlay" style="display:none;">
    <div class="login-card">
      <button class="login-close" id="loginCloseBtn" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>

      <h2 class="login-title">Admin login</h2>
      <p class="login-sub">Sign in to view the client registry.</p>

      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" placeholder="Email">
      </div>

      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••">
      </div>

      <div class="login-actions">
        <span class="tiny" id="loginHint"></span>
        <button class="btn" id="loginBtn">Sign in</button>
      </div>

      <div class="err" id="loginErr" style="display:none;"></div>
    </div>
  </div>

  <div class="modal" id="detailsModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <button class="close" id="closeModalBtn" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>

      <h3 class="modal-title" id="detailsTitle">Client details</h3>
      <p class="modal-sub" id="detailsSub"></p>

      <div class="grid" id="detailsGrid"></div>

      <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top: 1rem; flex-wrap:wrap;">
        <button class="btn btn-soft" id="copyJsonBtn" type="button">Copy JSON</button>
        <button class="btn btn-primary" id="closeModalBtn2" type="button">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" integrity="sha384-0cJhvyxOncqJDixLuJRbH99K17F1B6DH3D8aUBlsJlsgiqRZQpQ1EUFWdgscplLu" crossorigin="anonymous"></script>

  <script>
    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const ADMIN_EMAIL = "brandon.sns@pm.me";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const adminCard = document.getElementById("adminCard");
    const whoami = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");

    const errBox = document.getElementById("errBox");
    const okBox = document.getElementById("okBox");
    const rowsEl = document.getElementById("rows");
    const metaEl = document.getElementById("meta");
    const summaryPill = document.getElementById("summaryPill");

    const searchBox = document.getElementById("searchBox");
    const refreshBtn = document.getElementById("refreshBtn");

    const loginOverlay = document.getElementById("loginOverlay");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass  = document.getElementById("loginPass");
    const loginBtn   = document.getElementById("loginBtn");
    const loginErr   = document.getElementById("loginErr");
    const loginHint  = document.getElementById("loginHint");
    const loginCloseBtn = document.getElementById("loginCloseBtn");

    const detailsModal = document.getElementById("detailsModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const closeModalBtn2 = document.getElementById("closeModalBtn2");
    const detailsTitle = document.getElementById("detailsTitle");
    const detailsSub = document.getElementById("detailsSub");
    const detailsGrid = document.getElementById("detailsGrid");
    const copyJsonBtn = document.getElementById("copyJsonBtn");

    let allClients = [];
    let currentFilter = "all";
    let selectedClientForCopy = null;

    function showErr(msg){ errBox.style.display = "block"; errBox.textContent = msg || "Unknown error"; okBox.style.display = "none"; }
    function showOk(msg){ okBox.style.display = "block"; okBox.textContent = msg || "OK"; errBox.style.display = "none"; }
    function clearMsgs(){ errBox.style.display = "none"; okBox.style.display = "none"; errBox.textContent = ""; okBox.textContent = ""; }

    function fmtDate(ts){ if (!ts) return "—"; const d = new Date(ts * 1000); return d.toLocaleString([], { year:"numeric", month:"short", day:"2-digit" }); }
    function fmtMoney(amountCents, currency){
      if (amountCents == null) return "—";
      const cur = (currency || "usd").toUpperCase();
      const dollars = Number(amountCents) / 100;
      try { return new Intl.NumberFormat(undefined, { style:"currency", currency: cur }).format(dollars); }
      catch { return `${dollars.toFixed(2)} ${cur}`; }
    }
    function fmtAge(createdTs){
      if (!createdTs) return "—";
      const ms = Date.now() - (createdTs * 1000);
      const days = Math.max(0, Math.floor(ms / 86400000));
      if (days < 1) return "Today";
      if (days === 1) return "1 day";
      if (days < 30) return `${days} days`;
      const months = Math.floor(days / 30);
      if (months === 1) return "1 month";
      if (months < 24) return `${months} months`;
      const years = Math.floor(months / 12);
      return years === 1 ? "1 year" : `${years} years`;
    }

    function normalize(s){ return (s || "").toString().trim(); }
    function includesCI(hay, needle){ return normalize(hay).toLowerCase().includes(normalize(needle).toLowerCase()); }

    function getCategory(client){
      const cat = normalize(client?.subscription?.category).toLowerCase();
      if (["active","trialing","inactive","never"].includes(cat)) return cat;

      const st = normalize(client?.subscription?.status).toLowerCase();
      if (st === "active") return "active";
      if (st === "trialing") return "trialing";

      const hasStripe = !!(client?.subscription?.stripe_customer_id || client?.subscription?.stripe_subscription_id);
      const hasPaid = (client?.subscription?.total_paid_cents ?? null) != null && Number(client.subscription.total_paid_cents) > 0;
      if (hasStripe || hasPaid) return "inactive";
      return "never";
    }

    function statusTag(client){
      const cat = getCategory(client);
      if (cat === "active")   return `<span class="tag"><span class="dot dot-green"></span>Active</span>`;
      if (cat === "trialing") return `<span class="tag"><span class="dot dot-yellow"></span>Trialing</span>`;
      if (cat === "inactive") return `<span class="tag"><span class="dot dot-red"></span>Inactive</span>`;
      return `<span class="tag"><span class="dot dot-gray"></span>Never Purchased</span>`;
    }

    async function callEdge(fnName, payload = {}){
      const { data: sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) throw new Error("Not logged in.");

      let res;
      try{
        res = await fetch(`${SUPABASE_URL}/functions/v1/${fnName}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
      }catch(fetchErr){
        // Most common causes: missing Edge Function deployment, network/CORS error, adblock, or blocked third-party requests.
        throw new Error(fetchErr?.message || "NetworkError when attempting to fetch resource.");
      }
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error || "Request failed");
      return j;
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll("\"","&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    function render(){
      const q = normalize(searchBox.value);
      let list = allClients.slice();

      if (currentFilter !== "all") list = list.filter(c => getCategory(c) === currentFilter);

      if (q){
        list = list.filter(c => {
          const p = c.profile || c;
          return (
            includesCI(p.full_name, q) ||
            includesCI(p.business_name, q) ||
            includesCI(p.email, q) ||
            includesCI(p.phone, q)
          );
        });
      }

      rowsEl.innerHTML = list.map(c => {
        const p = c.profile || c;
        const id = p.user_id || c.user_id || "";
        const name = normalize(p.full_name) || normalize(p.name) || "—";
        const biz  = normalize(p.business_name) || "—";
        const phone = normalize(p.phone) || "—";

        return `
          <tr>
            <td>${statusTag(c)}</td>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(biz)}</td>
            <td>${escapeHtml(phone)}</td>
            <td style="text-align:right;">
              <button class="btn btn-primary" data-view="${escapeAttr(id)}">View</button>
            </td>
          </tr>
        `;
      }).join("");

      summaryPill.textContent = `${list.length} client${list.length === 1 ? "" : "s"}`;
      metaEl.textContent = allClients.length ? `Loaded ${allClients.length} total. Filter: ${currentFilter.toUpperCase()}` : "";
    }

    function openModal(client){
      selectedClientForCopy = client;
      const p = client.profile || client;
      const cat = getCategory(client).toUpperCase();
      const st = normalize(client?.subscription?.status).toUpperCase() || cat;

      detailsTitle.textContent = "Client details";
      detailsSub.textContent = `${normalize(p.full_name) || "Client"} · ${cat} (${st})`;

      const sub = client.subscription || {};
      const fields = [
        ["Subscription category", cat],
        ["Stripe status", normalize(sub.status) || "—"],
        ["Subscription started", fmtDate(sub.created_ts)],
        ["Next payment due", fmtDate(sub.current_period_end_ts)],
        ["Total paid (lifetime)", fmtMoney(sub.total_paid_cents, sub.currency)],
        ["Subscription age", fmtAge(sub.created_ts)],

        ["Full name", normalize(p.full_name) || "—"],
        ["Business name", normalize(p.business_name) || "—"],
        ["Phone", normalize(p.phone) || "—"],
        ["Email", normalize(p.email) || "—"],

        ["Business location", normalize(p.business_location) || normalize(p.location) || "—"],
        ["Address", normalize(p.address) || "—"],
        ["City", normalize(p.city) || "—"],
        ["State", normalize(p.state) || "—"],
        ["ZIP", normalize(p.zip) || "—"],

        ["User ID", normalize(p.user_id || client.user_id) || "—"],
        ["Stripe customer id", normalize(sub.stripe_customer_id) || "—"],
        ["Stripe subscription id", normalize(sub.stripe_subscription_id) || "—"],
      ];

      detailsGrid.innerHTML = fields.map(([k,v]) => `
        <div class="kv">
          <div class="k">${escapeHtml(k)}</div>
          <div class="v">${escapeHtml(v)}</div>
        </div>
      `).join("");

      detailsModal.classList.add("open");
      detailsModal.setAttribute("aria-hidden","false");
    }

    function closeModal(){
      detailsModal.classList.remove("open");
      detailsModal.setAttribute("aria-hidden","true");
      selectedClientForCopy = null;
    }

    rowsEl.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-view]");
      if (!btn) return;
      const id = btn.getAttribute("data-view");
      const client = allClients.find(c => {
        const p = c.profile || c;
        return (p.user_id || c.user_id) === id;
      });
      if (client) openModal(client);
    });

    closeModalBtn.addEventListener("click", closeModal);
    closeModalBtn2.addEventListener("click", closeModal);
    detailsModal.addEventListener("click", (e) => { if (e.target === detailsModal) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && detailsModal.classList.contains("open")) closeModal(); });

    copyJsonBtn.addEventListener("click", async () => {
      if (!selectedClientForCopy) return;
      try { await navigator.clipboard.writeText(JSON.stringify(selectedClientForCopy, null, 2)); showOk("Copied client JSON to clipboard."); }
      catch { showErr("Copy failed (browser blocked clipboard)." ); }
    });

    document.querySelectorAll("[data-filter]").forEach(b => {
      b.addEventListener("click", () => { currentFilter = b.getAttribute("data-filter"); render(); });
    });

    searchBox.addEventListener("input", render);
    refreshBtn.addEventListener("click", () => loadClients(true));

    async function loadClients(force=false){
      clearMsgs();
      metaEl.textContent = force ? "Refreshing…" : "Loading…";
      rowsEl.innerHTML = "";

      try{
        const resp = await callEdge("admin-client-list", {});
        const list = Array.isArray(resp?.clients) ? resp.clients : [];
        allClients = list;
        render();
        metaEl.textContent = `Last sync: ${new Date().toLocaleString()}`;
      }catch(e){
        metaEl.textContent = "";
        showErr((e?.message || String(e)) + " — This page requires the Edge Function: admin-client-list.");
      }
    }

    async function ensureAdminOrShowLogin(){
      const { data: sess } = await sb.auth.getSession();
      const s = sess?.session;

      if (!s){ showLogin(); return; }

      const email = (s.user?.email || "").toLowerCase();
      if (email !== ADMIN_EMAIL.toLowerCase()){
        whoami.textContent = `Forbidden: ${s.user?.email || "unknown"}`;
        logoutBtn.style.display = "inline-flex";
        logoutBtn.onclick = async () => { await sb.auth.signOut(); location.reload(); };
        showErr("Forbidden. This page is admin-only.");
        return;
      }

      whoami.textContent = `Signed in: ${s.user.email}`;
      logoutBtn.style.display = "inline-flex";
      logoutBtn.onclick = async () => { await sb.auth.signOut(); location.reload(); };

      adminCard.style.display = "block";
      await loadClients(false);
    }

    function showLogin(){
      loginOverlay.style.display = "flex";
      loginErr.style.display = "none";
      loginHint.textContent = "";
      adminCard.style.display = "none";
      logoutBtn.style.display = "none";
      whoami.textContent = "Not signed in";
    }

    function hideLogin(){ loginOverlay.style.display = "none"; }

    loginCloseBtn.addEventListener("click", () => { location.href = "/sns/index.html"; });

    // Enter key support for login
    loginPass.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); loginBtn.click(); }
    });
    loginEmail.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); loginBtn.click(); }
    });

    loginBtn.addEventListener("click", async () => {
      loginErr.style.display = "none";
      loginHint.textContent = "Signing in…";
      try{
        const email = normalize(loginEmail.value).toLowerCase();
        const pass  = normalize(loginPass.value);
        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if (error) throw error;
        hideLogin();
        loginHint.textContent = "";
        await ensureAdminOrShowLogin();
      }catch(e){
        loginHint.textContent = "";
        loginErr.style.display = "block";
        loginErr.textContent = e?.message || String(e);
      }
    });

    ensureAdminOrShowLogin();
  </script>
</body>
</html>
