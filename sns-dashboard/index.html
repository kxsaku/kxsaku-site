<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
  (function () {
    const forceDesktop = localStorage.getItem("sns_force_desktop") === "1";
    if (forceDesktop) return;

    const isMobile = window.matchMedia("(max-width: 820px)").matches;
    if (isMobile && !location.pathname.endsWith("/sns-dashboard/mobile.html")) {
      location.replace("/sns-dashboard/mobile.html");
    }
  })();
</script>

  <link rel="stylesheet" href="/styles.css" />
<style>
  :root{
    --bg0:#050315;
    --bg1:#0a0524;
    --card: rgba(10, 6, 32, .62);
    --card2: rgba(10, 6, 32, .40);
    --border: rgba(140, 130, 255, .20);
    --border2: rgba(255,255,255,.10);
    --text:#f4f0ff;
    --muted: rgba(244,240,255,.72);
    --muted2: rgba(244,240,255,.55);
    --glow: rgba(125, 95, 255, .22);
    --shadow: 0 22px 80px rgba(0,0,0,.55);
    --radius: 20px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    min-height:100vh;
    color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1100px 420px at 50% -120px, rgba(120,95,255,.35), transparent 60%),
      radial-gradient(900px 520px at 20% 10%, rgba(70,35,160,.30), transparent 55%),
      radial-gradient(circle at top, #342067, #050315 55%, #020010);
  }

  .wrap{ max-width: 1120px; margin: 0 auto; padding: 44px 18px 64px; }

  .top{
    display:flex; justify-content:space-between; align-items:flex-start;
    gap:16px; flex-wrap:wrap; margin-bottom: 14px;
  }

  h1{
    margin:0;
    font-size: 14px;
    letter-spacing:.20em;
    text-transform:uppercase;
  }

  .muted{ color: var(--muted); }
  .mutedSm{ color: var(--muted2); font-size: 12px; }

  .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap: 18px; margin-top: 18px; }
  @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }

  .card{
    position:relative;
    background: linear-gradient(180deg, rgba(12,8,36,.70), rgba(8,5,28,.50));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(16px);
    overflow:hidden;
  }
  .card:before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(520px 220px at 18% 0%, var(--glow), transparent 55%);
    pointer-events:none;
    opacity:.9;
  }
  .card > *{ position:relative; z-index:1; }

  .cardHeader{
    display:flex; justify-content:space-between; align-items:flex-start;
    gap:14px; flex-wrap:wrap;
    margin-bottom: 12px;
  }

  .cardTitle{
    font-size: 12px;
    letter-spacing:.14em;
    text-transform:uppercase;
    color: var(--muted2);
  }

  .cardStatus{
    margin-top: 6px;
    font-size: 13px;
    color: var(--muted);
  }

  .divider{
    height:1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
    margin: 12px 0 14px;
  }

  /* Pills */
  .pillrow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 10px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:7px 10px;
    border-radius:999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size: 12.5px;
    color: rgba(244,240,255,.86);
    line-height:1;
  }
  .pill strong{
    font-weight:700;
    color: rgba(244,240,255,.95);
  }

  /* Buttons */
  .btn{
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(160,150,255,.32);
    background:
      linear-gradient(180deg, rgba(140,125,255,.22), rgba(110,95,255,.10));
    color: var(--text);
    cursor:pointer;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-size: 12px;
    transition: transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
    box-shadow: 0 10px 24px rgba(0,0,0,.22);
  }
  .btn:hover{
    transform: translateY(-1px);
    border-color: rgba(190,180,255,.45);
    box-shadow: 0 14px 34px rgba(0,0,0,.28);
  }
  .btn:active{ transform: translateY(0px); }
  .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

  .btnGhost{
    background: rgba(255,255,255,.05);
    border-color: rgba(255,255,255,.14);
    box-shadow:none;
  }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 14px;
  }

  @media (max-width: 520px){
    .row .btn{ width:100%; }
  }

  /* Inquiry detail layout (replaces <pre>) */
  .inqMeta{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 14px;
  }
  @media (max-width: 620px){
    .inqMeta{ grid-template-columns: 1fr; }
  }

  .kv{
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
  }
  .kv .k{
    font-size: 11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color: var(--muted2);
    margin-bottom: 6px;
  }
  .kv .v{
    font-size: 13px;
    color: rgba(244,240,255,.92);
    word-break: break-word;
  }

  .note{
    margin-top: 12px;
    line-height:1.5;
    color: var(--muted);
    font-size: 13px;
  }

  /* --------------------------
   Page + card animations
-------------------------- */

/* Respect accessibility */
@media (prefers-reduced-motion: reduce){
  *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}

/* Subtle background drift */
@keyframes bgFloat {
  0%   { background-position: 50% 0%, 20% 10%, 0% 0%; }
  50%  { background-position: 52% 6%, 18% 14%, 0% 0%; }
  100% { background-position: 50% 0%, 20% 10%, 0% 0%; }
}

/* Top header fades in */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Cards “pop in” */
@keyframes cardIn {
  from { opacity: 0; transform: translateY(14px) scale(.985); filter: blur(6px); }
  to   { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
}

/* Soft highlight sweep across cards */
@keyframes sheen {
  0%   { transform: translateX(-120%) rotate(12deg); opacity: 0; }
  15%  { opacity: .22; }
  40%  { opacity: .10; }
  100% { transform: translateX(140%) rotate(12deg); opacity: 0; }
}

/* Pills gently appear */
@keyframes pillIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Apply bg drift to body */
body{
  animation: bgFloat 14s ease-in-out infinite;
}

/* Animate header + grid on load */
.top{
  animation: fadeUp .55s ease both;
}

/* Cards animate in with stagger */
.card{
  opacity: 0;
  animation: cardIn .65s cubic-bezier(.2,.9,.2,1) both;
}
.card:nth-child(1){ animation-delay: .10s; }
.card:nth-child(2){ animation-delay: .22s; }

/* Add a sheen layer on cards */
.card::after{
  content:"";
  position:absolute;
  top:-40%;
  left:-30%;
  width: 40%;
  height: 180%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,.10),
    transparent
  );
  filter: blur(1px);
  pointer-events:none;
  opacity: 0;
  transform: translateX(-120%) rotate(12deg);
  animation: sheen 4.8s ease-in-out infinite;
  animation-delay: 1.2s; /* lets the initial card-in finish */
}

/* Pills animate in when visible (simple: animate whenever rendered) */
.pillrow .pill{
  opacity: 0;
  animation: pillIn .45s ease both;
}
.pillrow .pill:nth-child(1){ animation-delay: .35s; }
.pillrow .pill:nth-child(2){ animation-delay: .42s; }
.pillrow .pill:nth-child(3){ animation-delay: .49s; }
.pillrow .pill:nth-child(4){ animation-delay: .56s; }

/* Make the cards feel more “alive” on hover */
.card:hover{
  transform: translateY(-2px);
  border-color: rgba(190,180,255,.32);
  box-shadow: 0 26px 95px rgba(0,0,0,.62);
}
.card{
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}

/* Dynamic content fade-in */
@keyframes contentIn{
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fadeIn{
  animation: contentIn .35s ease both;
}

/* --------------------------
   Client Chat (Dashboard)
-------------------------- */

.chatWrap{
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height: 420px;
}

.chatTop{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  flex-wrap:wrap;
}

.chatMeta{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top: 8px;
}

.chatTag{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  border-radius:999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  font-size: 12px;
  color: rgba(244,240,255,.86);
  line-height:1;
  white-space:nowrap;
}
.chatDot{
  width:9px; height:9px;
  border-radius:999px;
  display:inline-block;
  box-shadow: 0 0 0 2px rgba(255,255,255,.06);
  background: rgba(255,255,255,.18);
}
.chatDot.on{ background: rgba(108,255,176,.95); }
.chatDot.new{
  background: rgba(179,124,255,.95);
  box-shadow: 0 0 18px rgba(179,124,255,.35);
  animation: chatPulse 1.5s ease-in-out infinite;
}
@keyframes chatPulse{
  0%{ filter: brightness(1); }
  50%{ filter: brightness(1.35); }
  100%{ filter: brightness(1); }
}

.chatBody{
  position:relative;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  border-radius: 16px;
  padding: 12px;
  height: 340px;
  overflow:auto;
  scroll-behavior:smooth;
}

.chatMsg{
  max-width: 82%;
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(10, 6, 32, .45);
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
  margin: 8px 0;
}
.chatMsg.me{
  margin-left:auto;
  background: linear-gradient(180deg, rgba(140,125,255,.20), rgba(10, 6, 32, .45));
  border-color: rgba(160,150,255,.22);
}
.chatMsg.them{
  margin-right:auto;
  background: linear-gradient(180deg, rgba(90,160,255,.12), rgba(10, 6, 32, .45));
  border-color: rgba(90,160,255,.16);
}
.chatMsg.deleted{
  border-color: rgba(255,98,98,.28);
  background: rgba(10, 6, 32, .30);
}

.chatText{
  white-space: pre-wrap;
  line-height: 1.35;
  font-size: 13.5px;
  color: rgba(244,240,255,.92);
}

.chatFoot{
  margin-top: 8px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  font-size: 11.5px;
  color: rgba(244,240,255,.55);
}

.chatTools{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

.chatMiniBtn{
  padding:6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: rgba(244,240,255,.86);
  cursor:pointer;
  font-size: 11px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.chatMiniBtn:hover{ border-color: rgba(190,180,255,.35); }

.chatComposer{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}

.chatInput{
  flex: 1 1 280px;
  border-radius: 14px;
  border: 1px solid rgba(160,150,255,.32);
  background: rgba(255,255,255,.05);
  padding: 10px 12px;
  color: rgba(244,240,255,.92);
  outline:none;
  min-height: 44px;
  max-height: 120px;
  resize: none;
}

.chatJump{
  position:absolute;
  right: 10px;
  bottom: 10px;
  opacity: 0;
  pointer-events:none;
  transform: translateY(6px);
  transition: opacity .12s ease, transform .12s ease;
}
.chatJump.on{
  opacity: 1;
  pointer-events:auto;
  transform: translateY(0);
}



</style>

</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>SNS Client Dashboard</h1>
        <div id="who" class="muted" style="margin-top:6px;"></div>
      </div>
      <button id="logout" class="btn">Logout</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Most Recent Inquiry</div>
            <div id="inqStatus" class="cardStatus">Loading…</div>
          </div>

          <button id="viewHistory" class="btn btnGhost">View Inquiry History</button>
        </div>

        <div class="divider"></div>

        <div id="inqBox"></div>
      </div>


      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Subscription</div>
            <div id="subState" class="cardStatus">Loading…</div>
          </div>
        </div>

        <div class="pillrow">
          <div class="pill" id="subStatus"><strong>Status</strong>: —</div>
          <div class="pill" id="payStatus"><strong>Payment</strong>: —</div>
          <div class="pill" id="paidAmount"><strong>Paid</strong>: —</div>
          <div class="pill" id="periodEnd"><strong>Period End</strong>: —</div>
        </div>

        <div class="row">
          <button id="subscribeBtn" class="btn">Subscribe</button>
          <button id="manageBtn" class="btn btnGhost" style="display:none;">Manage My Subscription</button>
        </div>

        <div class="note">
          Your Network. Fortified.
        </div>
      </div>

      <div class="card">
  <div class="cardHeader">
    <div>
      <div class="cardTitle">Client Chat</div>
      <div id="chatState" class="cardStatus">Loading…</div>
      <div id="chatTyping" class="mutedSm" style="margin-top:6px; display:none;">Admin is typing…</div>


      <div class="chatMeta">
        <div class="chatTag"><span id="chatOnlineDot" class="chatDot"></span><span id="chatOnlineText">Offline</span></div>
        <div class="chatTag"><span id="chatUnreadDot" class="chatDot"></span><span id="chatUnreadText">No new messages</span></div>
      </div>
    </div>

    <div class="row" style="margin-top:0;">
      <button id="chatRefresh" class="btn btnGhost">Refresh</button>
    </div>
  </div>

  <div class="divider"></div>

  <div class="chatWrap">
    <div class="chatTop">
      <div class="mutedSm">Search only inside this chat:</div>
      <input id="chatSearch" class="search" style="margin-top:0;" placeholder="Search messages…" />
    </div>

    <div id="chatBody" class="chatBody">
      <div id="chatJump" class="chatJump">
        <button id="chatJumpBtn" class="btn btnGhost">Jump to newest</button>
      </div>
    </div>

    <div class="chatComposer">
      <textarea id="chatInput" class="chatInput" placeholder="Type a message… (Enter = send, Shift+Enter = newline)"></textarea>
      <button id="chatSend" class="btn">Send</button>
    </div>

    <div class="mutedSm" id="chatHint"></div>
  </div>
</div>


    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });
    const FN_BASE = `${SUPABASE_URL}/functions/v1`;

    const who = document.getElementById("who");
    const logoutBtn = document.getElementById("logout");

    const inqStatus = document.getElementById("inqStatus");
    const inqBox = document.getElementById("inqBox");
    const viewHistory = document.getElementById("viewHistory");

    const subState = document.getElementById("subState");
    const subscribeBtn = document.getElementById("subscribeBtn");
    const manageBtn = document.getElementById("manageBtn");
    const elSubStatus  = document.getElementById("subStatus");
    const elPayStatus  = document.getElementById("payStatus");
    const elPeriodEnd  = document.getElementById("periodEnd");
    const elPaidAmount = document.getElementById("paidAmount");

    // --------------------
    // Client Chat elements
    // --------------------
    const chatState = document.getElementById("chatState");
    const chatBody = document.getElementById("chatBody");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const chatRefresh = document.getElementById("chatRefresh");
    const chatSearch = document.getElementById("chatSearch");
    const chatHint = document.getElementById("chatHint");
    const chatTyping = document.getElementById("chatTyping");

    let chatTypingHideTimer = null;
    let chatTypingSendTimer = null;
    let chatTypingOn = false;


    const chatOnlineDot = document.getElementById("chatOnlineDot");
    const chatOnlineText = document.getElementById("chatOnlineText");
    const chatUnreadDot = document.getElementById("chatUnreadDot");
    const chatUnreadText = document.getElementById("chatUnreadText");

    const chatJump = document.getElementById("chatJump");
    const chatJumpBtn = document.getElementById("chatJumpBtn");

    let chatThreadId = null;
    let chatMessages = [];
    let chatRealtimeSub = null;
    let chatSearchQ = "";



    async function requireUser() {
      const { data: { session } } = await sb.auth.getSession();
      const user = session?.user;

      if (!user) {
        window.location.href = "/sns-login/";
        return null;
      }

      who.textContent = user.email;
      return user;
    }

    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      window.location.href = "/sns-login/";
    });

    function fmtDate(iso){
      try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
    }

    async function loadInquiry(email){
      const { data, error } = await sb
        .from("inquiries")
        .select("created_at,contact_name,business_name,location,services,timeline,budget,goals,phone")
        .eq("email", email)
        .order("created_at", { ascending:false })
        .limit(1);

      if (error) {
        inqStatus.textContent = "Could not load inquiry.";
        inqBox.innerHTML = "";
        return;
      }

      if (!data || !data[0]) {
        inqStatus.textContent = "No inquiries found for your email yet.";
        inqBox.innerHTML = "";
        return;
      }

      const r = data[0];
      inqStatus.textContent = "Loaded";
      inqBox.innerHTML = `
        <div class="pillrow" style="margin-top:0;">
          <div class="pill"><strong>Submitted</strong>: ${fmtDate(r.created_at)}</div>
        </div>

        <div style="margin-top:12px;" class="inqMeta">
          <div class="kv"><div class="k">Contact</div><div class="v">${r.contact_name || "—"}</div></div>
          <div class="kv"><div class="k">Business</div><div class="v">${r.business_name || "—"}</div></div>
          <div class="kv"><div class="k">Location</div><div class="v">${r.location || "—"}</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v">${r.phone || "—"}</div></div>
          <div class="kv" style="grid-column:1 / -1;"><div class="k">Services</div><div class="v">${(r.services || []).join(", ") || "—"}</div></div>
          <div class="kv"><div class="k">Timeline</div><div class="v">${r.timeline || "—"}</div></div>
          <div class="kv"><div class="k">Budget</div><div class="v">${r.budget || "—"}</div></div>
        </div>
      `;

      inqBox.classList.remove("fadeIn");
      void inqBox.offsetWidth;
      inqBox.classList.add("fadeIn");


    }

    viewHistory.addEventListener("click", () => {
      // Uses your existing inquiry view page
      window.location.href = "/sns-inquiry-history/index.html";
    });

    async function loadSubscription() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.access_token) return; // not logged in; requireUser() handles redirect

      const { data: resp, error } = await sb.functions.invoke("get-billing-status", {
        headers: { Authorization: `Bearer ${session.access_token}` }
      });

      if (error) {
        subState.innerHTML = `<div class="muted">Could not load subscription.</div>`;
        console.error("get-billing-status error:", error);
        return;
      }

      const sub = resp?.subscription ?? null;

      if (!sub) {
        subState.innerHTML = `<div class="muted">No subscription record found yet.</div>`;
        elSubStatus.textContent = "Status: —";
        elPayStatus.textContent = "Payment: —";
        elPaidAmount.textContent = "Paid: —";
        elPeriodEnd.textContent = "Current Period End: —";
        manageBtn.style.display = "none";
        return;
      }

      const statusRaw = (sub.status || "unknown").toString();
      const statusPretty = statusRaw.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());

      const paymentRaw = (sub.last_payment_status || "unknown").toString();
      const paymentPretty = paymentRaw.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());

      const paid = (sub.last_payment_amount != null)
        ? `$${Number(sub.last_payment_amount).toFixed(2)}`
        : "—";

      const periodEnd = sub.current_period_end
        ? new Date(sub.current_period_end).toLocaleString()
        : "—";

      elSubStatus.textContent = `Status: ${statusPretty}`;
      elPayStatus.textContent = `Payment: ${paymentPretty}`;
      elPaidAmount.textContent = `Paid: ${paid}`;
      elPeriodEnd.textContent = `Current Period End: ${periodEnd}`;

      const activeish = ["active","trialing","past_due","unpaid"].includes(statusRaw);
      manageBtn.style.display = activeish ? "inline-flex" : "none";

      subState.innerHTML = `<div class="muted">${
        statusRaw === "active" ? "Subscription is active."
        : statusRaw === "trialing" ? "Trial is active."
        : statusRaw === "past_due" ? "Payment is past due — update billing to restore service."
        : "No active subscription."
      }</div>`;
    }



    async function callFn(name, body) {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.access_token) throw new Error("Not logged in.");

      const { data, error } = await sb.functions.invoke(name, {
        body: body || {},
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (error) throw new Error(error.message || "Edge function error");
      return data;
    }

    function chatStopRealtime(){
  try{
    if (chatRealtimeSub){
      sb.removeChannel(chatRealtimeSub);
      chatRealtimeSub = null;
    }
  }catch(_){}
}

let chatMarkReadCooldown = false;

async function chatMarkRead(){
  if (!chatThreadId) return;
  if (document.visibilityState !== "visible") return;

  // simple throttle to avoid spamming updates
  if (chatMarkReadCooldown) return;
  chatMarkReadCooldown = true;
  setTimeout(() => { chatMarkReadCooldown = false; }, 900);

  try{
    await callFn("client-chat-mark-read", { thread_id: chatThreadId });
  }catch(_){
    // silent on purpose (read receipts should never break chat UI)
  }
}


function chatStartRealtime(){
  chatStopRealtime();
  if (!chatThreadId) return;

  chatRealtimeSub = sb
    .channel(`chat:${chatThreadId}`)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "chat_messages",
      filter: `thread_id=eq.${chatThreadId}`,
    }, (payload) => {
      const m = payload.new;
      if (!m?.id) return;

      const msg = {
        id: m.id,
        sender_role: m.sender_role,
        body: m.body,
        created_at: m.created_at,
        edited: !!m.edited_at,
        deleted: !!m.deleted_at,
        reply_to_message_id: m.reply_to_message_id ?? null,
      };

      if (chatMessages.some(x => x.id === msg.id)) return;

      const wasNear = chatNearBottom();

      chatMessages.push(msg);
      chatRender();

      if (wasNear){
        requestAnimationFrame(() => { chatBody.scrollTop = chatBody.scrollHeight; });
      } else {
        setUnread(true);
      }

      // If an admin message arrived and the client is viewing the chat, mark read
      if (msg.sender_role === "admin" && wasNear) {
        chatMarkRead();
      }

    })
    .on("postgres_changes", {
      event: "UPDATE",
      schema: "public",
      table: "chat_messages",
      filter: `thread_id=eq.${chatThreadId}`,
    }, (payload) => {
      const m = payload.new;
      if (!m?.id) return;

      const idx = chatMessages.findIndex(x => x.id === m.id);
      if (idx === -1) return;

      chatMessages[idx] = {
        ...chatMessages[idx],
        body: m.body,
        edited: !!m.edited_at,
        deleted: !!m.deleted_at,
      };

      chatRender();
    })
    .on("broadcast", { event: "typing" }, (payload) => {
      const p = payload?.payload || {};
      if (p.role !== "admin") return;

      chatTyping.style.display = p.on ? "block" : "none";

      clearTimeout(chatTypingHideTimer);
      chatTypingHideTimer = setTimeout(() => {
        chatTyping.style.display = "none";
      }, 1600);
    })
    .subscribe();
}

function chatSendTyping(on){
  if (!chatRealtimeSub) return;
  if (chatTypingOn === on) return;
  chatTypingOn = on;

  chatRealtimeSub.send({
    type: "broadcast",
    event: "typing",
    payload: { role: "client", on: !!on },
  });
}


    // --------------------
    // Client Chat helpers
    // --------------------
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function chatFmt(iso){
      try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
    }

    function chatNearBottom(){
      return (chatBody.scrollHeight - chatBody.scrollTop - chatBody.clientHeight) < 120;
    }

    function chatUpdateJump(){
      chatJump.classList.toggle("on", !chatNearBottom() && chatMessages.length > 0);
    }

    chatBody.addEventListener("scroll", chatUpdateJump);
    chatJumpBtn.addEventListener("click", () => {
      chatBody.scrollTop = chatBody.scrollHeight;
    });

    function chatRender(){
      const q = (chatSearchQ || "").trim().toLowerCase();
      const view = !q ? chatMessages : chatMessages.filter(m => (m.body || "").toLowerCase().includes(q));

      // keep the jump button usable
      const wasNear = chatNearBottom();

      // Remove jump container first render-safe
      chatBody.innerHTML = `
        <div id="chatJump" class="chatJump">
          <button id="chatJumpBtn" class="btn btnGhost">Jump to newest</button>
        </div>
      `;

      // Re-bind jump controls after reset
      const _jump = chatBody.querySelector("#chatJump");
      const _jumpBtn = chatBody.querySelector("#chatJumpBtn");
      _jumpBtn.addEventListener("click", () => { chatBody.scrollTop = chatBody.scrollHeight; });
      chatBody.addEventListener("scroll", () => {
        const near = (chatBody.scrollHeight - chatBody.scrollTop - chatBody.clientHeight) < 120;
        _jump.classList.toggle("on", !near && view.length > 0);
      });

      if (!view.length){
        const empty = document.createElement("div");
        empty.className = "mutedSm";
        empty.style.padding = "8px 2px";
        empty.textContent = q ? "No matches in this chat." : "No messages yet.";
        chatBody.appendChild(empty);
        return;
      }

      view.forEach(m => {
        const div = document.createElement("div");
        const who = m.sender_role === "client" ? "me" : "them";
        const isDeleted = !!m.deleted;

        div.className = `chatMsg ${who} ${isDeleted ? "deleted" : ""}`;

        const body = isDeleted ? "Deleted Message" : (m.body || "");
        div.innerHTML = `
          <div class="chatText">${esc(body)}</div>
          <div class="chatFoot">
            <div>${esc(chatFmt(m.created_at))}${m.edited ? " · Edited" : ""}</div>
            <div class="chatTools">
              ${m.sender_role === "client" && !isDeleted ? `<button class="chatMiniBtn" data-act="edit" data-id="${esc(m.id)}">Edit</button>` : ``}
              ${m.sender_role === "client" && !isDeleted ? `<button class="chatMiniBtn" data-act="delete" data-id="${esc(m.id)}">Delete</button>` : ``}
              <button class="chatMiniBtn" data-act="reply" data-id="${esc(m.id)}">Reply</button>
            </div>
          </div>
        `;
        chatBody.appendChild(div);
      });

      // Restore scroll position behavior
      if (wasNear) {
        requestAnimationFrame(() => { chatBody.scrollTop = chatBody.scrollHeight; });
      }
    }

    let replyToId = null;

    chatBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-act]");
      if (!btn) return;

      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");

      if (act === "reply") {
        replyToId = id;
        chatHint.textContent = `Replying to message ${id.slice(0,8)}… (send to attach reply)`;
        chatInput.focus();
        return;
      }

      if (act === "edit") {
        const m = chatMessages.find(x => x.id === id);
        if (!m || m.deleted) return;

        const next = prompt("Edit your message:", m.body || "");
        if (next == null) return;

        try {
          const j = await callFn("client-chat-edit", { message_id: id, body: next });
          if (j?.message) {
            const idx = chatMessages.findIndex(x => x.id === id);
            if (idx !== -1) chatMessages[idx] = { ...chatMessages[idx], ...j.message, edited: true };
            chatRender();
          } else {
            await chatLoadHistory();
          }
        } catch (e2) {
          chatHint.textContent = e2?.message || String(e2);
        }
        return;
      }

      if (act === "delete") {
        if (!confirm("Delete this message? It will show as 'Deleted Message'.")) return;

        try {
          const j = await callFn("client-chat-delete", { message_id: id });
          if (j?.message) {
            const idx = chatMessages.findIndex(x => x.id === id);
            if (idx !== -1) chatMessages[idx] = { ...chatMessages[idx], ...j.message, deleted: true, body: "Deleted Message" };
            chatRender();
          } else {
            await chatLoadHistory();
          }
        } catch (e2) {
          chatHint.textContent = e2?.message || String(e2);
        }
        return;
      }
    });

    async function chatLoadHistory(){
      chatState.textContent = "Loading…";
      try{
        const j = await callFn("client-chat-history", { limit: 200 });
        chatThreadId = j.thread_id || null;
        chatMessages = Array.isArray(j.messages) ? j.messages : [];
        chatState.textContent = "Ready";
        chatRender();
        chatStartRealtime();
        requestAnimationFrame(() => { chatBody.scrollTop = chatBody.scrollHeight; });
        chatMarkRead();

      }catch(e){
        chatState.textContent = "Chat unavailable.";
        chatHint.textContent = e?.message || String(e);
      }
    }

    async function chatSendMsg(){
      const text = (chatInput.value || "").trim();
      if (!text) return;

      chatSend.disabled = true;
      try{
        const j = await callFn("client-chat-send", { body: text, reply_to_message_id: replyToId });
        replyToId = null;
        chatHint.textContent = "";
        chatInput.value = "";
        chatSendTyping(false);

        if (j?.message) {
          chatMessages.push(j.message);
          chatRender();
          requestAnimationFrame(() => { chatBody.scrollTop = chatBody.scrollHeight; });
        } else {
          await chatLoadHistory();
        }
      }catch(e){
        chatHint.textContent = e?.message || String(e);
      }finally{
        chatSend.disabled = false;
      }
    }

    chatBody.addEventListener("scroll", () => {
  if (chatNearBottom()){
    if (chatUnreadDot.classList.contains("new")) setUnread(false);
    chatMarkRead();
  }
});

window.addEventListener("focus", () => {
  if (chatNearBottom()) chatMarkRead();
});

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && chatNearBottom()) chatMarkRead();
});


    chatSend.addEventListener("click", chatSendMsg);
    chatInput.addEventListener("keydown", (e) => {
      chatSendTyping(true);
      clearTimeout(chatTypingSendTimer);
      chatTypingSendTimer = setTimeout(() => chatSendTyping(false), 900);

      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        chatSendTyping(false);
        chatSendMsg();
      }
    });


    chatRefresh.addEventListener("click", chatLoadHistory);
    chatSearch.addEventListener("input", () => {
      chatSearchQ = chatSearch.value || "";
      chatRender();
    });

    // Presence indicators (client-side: shows only if YOU are online)
    // Admin-only view of client online is on the admin chat page.
    function setClientOnline(on){
      chatOnlineDot.classList.toggle("on", !!on);
      chatOnlineText.textContent = on ? "Online" : "Offline";
    }

    // Unread indicator (client-side: “new” just for UI feedback)
    function setUnread(hasNew){
      chatUnreadDot.classList.toggle("new", !!hasNew);
      chatUnreadText.textContent = hasNew ? "New message" : "No new messages";
    }





    subscribeBtn.addEventListener("click", async () => {
      subscribeBtn.disabled = true;
      try {
        const j = await callFn("create-checkout-session");
        if (!j.url) throw new Error("No checkout URL returned.");
        window.location.href = j.url;
      } catch (e) {
        alert(e.message || String(e));
        subscribeBtn.disabled = false;
      }
    });

    manageBtn.addEventListener("click", async () => {
      manageBtn.disabled = true;
      try {
        const j = await callFn("create-portal-session");
        if (!j.url) throw new Error("No portal URL returned.");
        window.location.href = j.url;
      } catch (e) {
        alert(e.message || String(e));
        manageBtn.disabled = false;
      }
    });

    const user = await requireUser();
    if (user) {
      await loadInquiry(user.email);

      try {
        await loadSubscription(user.id);
      } catch (e) {
        console.error("loadSubscription failed:", e);

        // Hard-fail UI so it doesn't sit on Loading forever
        subState.innerHTML = `<div class="muted">Subscription unavailable.</div>`;
        elSubStatus.textContent = "Status: Unknown";
        elPayStatus.textContent = "Payment: —";
        elPaidAmount.textContent = "Paid: —";
        elPeriodEnd.textContent = "Current Period End: —";
        manageBtn.style.display = "none";
      }
            // Init chat
      setClientOnline(true);
      await chatLoadHistory();
    }

    

  </script>
</body>
</html>
