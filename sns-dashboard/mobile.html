<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://esm.sh; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com; img-src 'self' data: blob: https://*.supabase.co; font-src 'self'; frame-src https://js.stripe.com;" />
  <title>SNS · Dashboard</title>

  <link rel="stylesheet" href="/styles.css" />
  <style>
  /* =============================================
     SNS Dashboard Mobile - Page-specific styles
     Uses /styles.css for base components
     ============================================= */

  /* Mobile-specific variables */
  :root {
    --mobile-max: 640px;
    --mobile-stroke: rgba(196, 181, 253, .18);
    --mobile-stroke2: rgba(196, 181, 253, .28);
    --mobile-glass: rgba(10, 6, 28, .42);
    --mobile-glass2: rgba(12, 8, 34, .62);
    --mobile-accent2: #f973e2;
    --mobile-accent3: #5eead4;
  }

  /* Mobile body with animated gradient background */
  body {
    background: radial-gradient(1200px 800px at 25% 20%, rgba(179,124,255,.18), transparent 60%),
                radial-gradient(900px 650px at 85% 10%, rgba(94,234,212,.10), transparent 55%),
                radial-gradient(1100px 900px at 70% 80%, rgba(249,115,226,.12), transparent 55%),
                linear-gradient(180deg, #060214, #03010b);
    overflow-x: hidden;
  }

  /* Full-bleed animated background */
  .bg {
    position: fixed;
    inset: 0;
    z-index: -2;
    pointer-events: none;
    overflow: hidden;
  }
  .bg .glow {
    position: absolute;
    inset: -20%;
    background:
      radial-gradient(circle at 20% 25%, rgba(179,124,255,.22), transparent 55%),
      radial-gradient(circle at 85% 15%, rgba(94,234,212,.12), transparent 55%),
      radial-gradient(circle at 60% 80%, rgba(249,115,226,.14), transparent 55%);
    filter: blur(10px);
    animation: glowFloat 16s ease-in-out infinite alternate;
    opacity: .9;
  }
  @keyframes glowFloat {
    from { transform: translate3d(0,0,0) scale(1); }
    to { transform: translate3d(-18px, 12px, 0) scale(1.03); }
  }
  .bg .lines {
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      135deg,
      rgba(255,255,255,.045) 0px,
      rgba(255,255,255,.045) 1px,
      transparent 1px,
      transparent 90px
    );
    opacity: .18;
    -webkit-mask-image: linear-gradient(to bottom, #000 0%, #000 45%, transparent 100%);
    mask-image: linear-gradient(to bottom, #000 0%, #000 45%, transparent 100%);
    animation: lineDrift 22s linear infinite;
  }
  @keyframes lineDrift {
    from { transform: translate3d(0,0,0); }
    to { transform: translate3d(-140px, 140px, 0); }
  }
  .bg .dots {
    position: absolute;
    inset: 0;
    background-image:
      radial-gradient(rgba(255,255,255,.20) 1px, transparent 1px),
      radial-gradient(rgba(255,255,255,.10) 1px, transparent 1px);
    background-size: 140px 140px, 220px 220px;
    background-position: 0 0, 40px 80px;
    opacity: .20;
    -webkit-mask-image: linear-gradient(to bottom, #000 0%, #000 50%, transparent 100%);
    mask-image: linear-gradient(to bottom, #000 0%, #000 50%, transparent 100%);
    animation: dotFloat 28s ease-in-out infinite alternate;
  }
  @keyframes dotFloat {
    from { transform: translate3d(0,0,0); }
    to { transform: translate3d(18px, -10px, 0); }
  }
  .bg .vignette {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 50% 0%, rgba(0,0,0,.08), rgba(0,0,0,.64) 62%, rgba(0,0,0,.78));
    z-index: 1;
  }

  /* Mobile layout wrap override */
  .wrap {
    width: min(var(--mobile-max), calc(100% - 1.25rem));
    margin: 0 auto;
    padding: 0;
  }

  /* Mobile sticky header */
  .topnav {
    position: sticky;
    top: 0;
    z-index: 60;
    padding: .9rem 0;
    backdrop-filter: blur(14px);
    background: linear-gradient(180deg, rgba(3,1,11,.78), rgba(3,1,11,.22));
    border-bottom: 1px solid rgba(196,181,253,.10);
  }
  .navrow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: .7rem;
    min-width: 0;
  }
  .mark {
    width: 42px;
    height: 42px;
    border-radius: 14px;
    display: grid;
    place-items: center;
    box-shadow: 0 18px 50px rgba(0,0,0,.45);
    flex: 0 0 auto;
  }
  .mark img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 12px;
  }
  .brandText {
    min-width: 0;
  }
  .brand strong {
    display: block;
    font-size: .88rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    line-height: 1.05;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70vw;
  }
  .brand span {
    display: block;
    color: var(--color-text-muted2);
    font-size: .82rem;
    line-height: 1.1;
    margin-top: .18rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70vw;
  }

  /* Mobile button overrides */
  .btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 42px;
    padding: 0 16px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--mobile-stroke);
    background: rgba(0,0,0,.18);
    color: var(--color-text-primary);
    text-decoration: none;
    font-weight: 800;
    font-size: .78rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    box-shadow: 0 12px 40px rgba(0,0,0,.32);
    backdrop-filter: blur(10px);
    transition: transform .14s ease, border-color .14s ease, filter .14s ease, background .14s ease;
    will-change: transform;
    overflow: hidden;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }
  .btn::after {
    content: "";
    position: absolute;
    inset: -40% -60%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-60%) rotate(10deg);
    opacity: 0;
    transition: transform .55s ease, opacity .18s ease;
  }
  .btn:active {
    transform: translateY(0);
    filter: brightness(1.03);
  }
  .btn.primary {
    background: linear-gradient(90deg, rgba(179,124,255,.92), rgba(249,115,226,.72));
    border-color: rgba(255,255,255,.18);
  }

  /* Ghost button variant */
  .btnGhost {
    background: rgba(255,255,255,.05);
    border-color: rgba(255,255,255,.14);
    box-shadow: none;
  }

  /* Icon button (hamburger) */
  .iconBtn {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 1px solid var(--mobile-stroke);
    background: rgba(0,0,0,.18);
    backdrop-filter: blur(10px);
    box-shadow: 0 12px 40px rgba(0,0,0,.28);
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: transform .14s ease, border-color .14s ease, filter .14s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .iconBtn:active { transform: translateY(0); filter: brightness(1.04); }
  .iconBtn svg { opacity: .92; }

  /* Slide-down menu */
  .menu {
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    z-index: 80;
    transform: translateY(-110%);
    transition: transform .24s cubic-bezier(.2,.9,.2,1);
    padding: 0.95rem 0 .9rem;
    backdrop-filter: blur(16px);
    background: linear-gradient(180deg, rgba(3,1,11,.92), rgba(3,1,11,.58));
    border-bottom: 1px solid rgba(196,181,253,.14);
  }
  .menu.open { transform: translateY(0); }

  .menuHeader {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    padding-bottom: .75rem;
    border-bottom: 1px solid rgba(196,181,253,.10);
  }

  .menuLinks {
    display: grid;
    gap: .55rem;
    padding-top: .85rem;
  }
  .menuLinks a {
    text-decoration: none;
    color: var(--color-text-muted);
    font-size: .80rem;
    letter-spacing: .14em;
    text-transform: uppercase;
    padding: .8rem .95rem;
    border-radius: 16px;
    border: 1px solid rgba(196,181,253,.10);
    background: rgba(196,181,253,.04);
    transition: transform .14s ease, border-color .14s ease, filter .14s ease, background .14s ease, color .14s ease;
  }
  .menuLinks a:active {
    transform: translateY(0);
    border-color: rgba(196,181,253,.22);
    filter: brightness(1.04);
    color: var(--color-text-primary);
  }
  .menuLinks a.active {
    background: rgba(179,124,255,.16);
    border-color: rgba(179,124,255,.26);
    color: var(--color-text-primary);
  }

  .menuActions {
    margin-top: .85rem;
    display: grid;
    gap: .65rem;
  }
  .menuActions .btn { width: 100%; }

  .scrim {
    position: fixed;
    inset: 0;
    z-index: 70;
    background: rgba(0,0,0,.55);
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s ease;
  }
  .scrim.open {
    opacity: 1;
    pointer-events: auto;
  }

  /* Mobile cards override */
  .card {
    border-radius: var(--radius-xl);
    border: 1px solid rgba(196,181,253,.16);
    background: linear-gradient(180deg, rgba(10,6,28,.52), rgba(10,6,28,.30));
    box-shadow: var(--shadow-md);
    padding: 1.15rem 1.05rem;
    text-align: left;
    transition: transform .16s ease, border-color .16s ease, filter .16s ease;
    will-change: transform;
    margin-top: 0;
  }
  .card:active {
    transform: translateY(0);
    border-color: rgba(196,181,253,.26);
    filter: brightness(1.03);
  }
  .card h3 {
    margin: 0;
    font-size: .90rem;
    letter-spacing: .12em;
    text-transform: uppercase;
  }
  .card p {
    margin: .55rem 0 0;
    color: var(--color-text-muted);
    line-height: 1.65;
    font-size: .98rem;
  }

  /* Inquiry detail layout */
  .inqMeta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 14px;
  }
  @media (max-width: 620px) {
    .inqMeta { grid-template-columns: 1fr; }
  }

  .kv {
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
  }
  .kv .k {
    font-size: 11px;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--color-text-muted2);
    margin-bottom: 6px;
  }
  .kv .v {
    font-size: 13px;
    color: rgba(244,240,255,.92);
    word-break: break-word;
  }

  .note {
    margin-top: 12px;
    line-height: 1.5;
    color: var(--color-text-muted);
    font-size: 13px;
  }

  /* Footer */
  footer {
    padding: 2.6rem 0 2.2rem;
    border-top: 1px solid rgba(196,181,253,.10);
    color: var(--color-text-muted2);
    text-align: center;
  }
  footer a {
    color: var(--color-text-muted);
    text-decoration: none;
    border-bottom: 1px solid rgba(196,181,253,.22);
  }
  footer a:active {
    color: var(--color-text-primary);
    border-bottom-color: rgba(196,181,253,.38);
  }

  /* ===== Dashboard mobile fitting overrides ===== */
  .dashWrap {
    width: min(720px, calc(100% - 1.25rem));
    margin: 0 auto;
    padding: 1.15rem 0 3.25rem;
    margin-top: .65rem;
  }

  .top {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: .75rem;
    margin-bottom: 14px;
  }
  .top h1 {
    margin: 0;
    font-size: clamp(1.35rem, 6vw, 1.8rem);
    line-height: 1.1;
  }
  #logout.btn {
    width: 100%;
    justify-content: center;
  }

  .grid {
    grid-template-columns: 1fr !important;
    gap: .9rem !important;
  }

  .card {
    padding: 1rem 0.95rem !important;
    border-radius: 22px !important;
  }
  .cardTitle {
    font-size: .82rem !important;
    letter-spacing: .14em !important;
  }

  .cardActions {
    grid-template-columns: 1fr !important;
    gap: .65rem !important;
  }
  .cardActions .btn {
    width: 100%;
    justify-content: center;
  }

  .row {
    display: flex;
    flex-wrap: wrap;
    gap: .55rem !important;
    margin-top: 14px;
  }

  .muted, .card, .row, .line, .value {
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  table {
    width: 100%;
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>

  <div class="scrim" id="scrim" aria-hidden="true"></div>

  <aside class="menu" id="menu" aria-label="Mobile Menu" aria-hidden="true">
    <div class="wrap">
      <div class="menuHeader">
        <div class="brand" style="gap:.65rem;">
          <div class="mark" style="width:40px;height:40px;border-radius:14px;">
            <img src="/assets/sns-logo-purple.png" alt="Saku Network Solutions logo">
          </div>
          <div class="brandText">
            <strong>SAKU NETWORK SOLUTIONS</strong>
            <span>Network infrastructure, done clean.</span>
          </div>
        </div>

        <button class="iconBtn" id="closeMenu" aria-label="Close menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="rgba(244,240,255,.92)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <nav class="menuLinks" aria-label="Primary">
        <a href="/home/">Home</a>
        <a href="/sns/">Services</a>
        <a href="/credibility/">Credibility</a>
        <a href="/resources/">Resources</a>
        <a href="/contact/">Contact</a>
      </nav>

      <div class="menuActions">
        <a class="btn" href="/sns-login/">Client Login</a>

        <!-- Desktop preference -->
        <a class="btn" href="#" id="viewDesktop">View Desktop Site</a>
      </div>
    </div>
  </aside>

  <!-- Top nav -->
  <header class="topnav">
    <div class="wrap">
      <div class="navrow">
        <div class="brand">
          <div class="mark">
            <img src="/assets/sns-logo-purple.png" alt="Saku Network Solutions logo">
          </div>
          <div class="brandText">
            <strong>SAKU NETWORK SOLUTIONS</strong>
            <span>Network infrastructure, done clean.</span>
          </div>
        </div>

        <button class="iconBtn" id="openMenu" aria-label="Open menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(244,240,255,.92)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div class="dashWrap">
    <div class="top">
      <div>
        <h1>SNS Client Dashboard</h1>
        <div id="who" class="muted" style="margin-top:6px;"></div>
      </div>
      <button id="logout" class="btn">Logout</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Most Recent Inquiry</div>
            <div id="inqStatus" class="cardStatus">Loading…</div>
          </div>

          <button id="viewHistory" class="btn btnGhost">View Inquiry History</button>
        </div>

        <div class="divider"></div>

        <div id="inqBox"></div>
      </div>


      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Subscription</div>
            <div id="subState" class="cardStatus">Loading…</div>
          </div>
        </div>

        <div class="pillrow">
          <div class="pill" id="subStatus"><strong>Status</strong>: —</div>
          <div class="pill" id="payStatus"><strong>Payment</strong>: —</div>
          <div class="pill" id="paidAmount"><strong>Paid</strong>: —</div>
          <div class="pill" id="periodEnd"><strong>Period End</strong>: —</div>
        </div>

        <div class="row">
          <button id="subscribeBtn" class="btn">Subscribe</button>
          <button id="manageBtn" class="btn btnGhost" style="display:none;">Manage My Subscription</button>
        </div>

        <div class="note">
          Your Network. Fortified.
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });


    const who = document.getElementById("who");
    const logoutBtn = document.getElementById("logout");

    const inqStatus = document.getElementById("inqStatus");
    const inqBox = document.getElementById("inqBox");
    const viewHistory = document.getElementById("viewHistory");

    const subState = document.getElementById("subState");
    const subscribeBtn = document.getElementById("subscribeBtn");
    const manageBtn = document.getElementById("manageBtn");
    const elSubStatus  = document.getElementById("subStatus");
    const elPayStatus  = document.getElementById("payStatus");
    const elPeriodEnd  = document.getElementById("periodEnd");
    const elPaidAmount = document.getElementById("paidAmount");


    async function requireUser() {
      // First try to get existing session
      let { data: { session } } = await sb.auth.getSession();

      // If we have a session but the token might be stale, refresh it
      if (session) {
        const { data: refreshData, error: refreshError } = await sb.auth.refreshSession();
        if (!refreshError && refreshData.session) {
          session = refreshData.session;
        }
      }

      const user = session?.user;

      if (!user) {
        window.location.href = "/sns-login/";
        return null;
      }

      who.textContent = user.email;
      return user;
    }


    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      window.location.href = "/sns-login/";
    });

    function fmtDate(iso){
      try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
    }

    async function loadInquiry(email){
      const { data, error } = await sb
        .from("inquiries")
        .select("created_at,contact_name,business_name,location,services,timeline,budget,goals,phone")
        .eq("email", email)
        .order("created_at", { ascending:false })
        .limit(1);

      if (error) {
        inqStatus.textContent = "Could not load inquiry.";
        inqBox.innerHTML = "";
        return;
      }

      if (!data || !data[0]) {
        inqStatus.textContent = "No inquiries found for your email yet.";
        inqBox.innerHTML = "";
        return;
      }

      const r = data[0];
      inqStatus.textContent = "Loaded";
      inqBox.innerHTML = `
        <div class="pillrow" style="margin-top:0;">
          <div class="pill"><strong>Submitted</strong>: ${fmtDate(r.created_at)}</div>
        </div>

        <div style="margin-top:12px;" class="inqMeta">
          <div class="kv"><div class="k">Contact</div><div class="v">${r.contact_name || "—"}</div></div>
          <div class="kv"><div class="k">Business</div><div class="v">${r.business_name || "—"}</div></div>
          <div class="kv"><div class="k">Location</div><div class="v">${r.location || "—"}</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v">${r.phone || "—"}</div></div>
          <div class="kv" style="grid-column:1 / -1;"><div class="k">Services</div><div class="v">${(r.services || []).join(", ") || "—"}</div></div>
          <div class="kv"><div class="k">Timeline</div><div class="v">${r.timeline || "—"}</div></div>
          <div class="kv"><div class="k">Budget</div><div class="v">${r.budget || "—"}</div></div>
        </div>
      `;

      inqBox.classList.remove("fadeIn");
      void inqBox.offsetWidth;
      inqBox.classList.add("fadeIn");


    }

    viewHistory.addEventListener("click", () => {
      // Uses your existing inquiry view page
      window.location.href = "/sns-inquiry-history/index.html";
    });

    async function loadSubscription(userId) {
      // Pull subscription snapshot from the Edge Function
      let resp;
      try {
        resp = await callFn("get-billing-status");
      } catch (e) {
        console.error("get-billing-status failed:", e);

        // Safe UI fallback
        subState.innerHTML = `<div class="muted">Subscription unavailable.</div>`;
        elSubStatus.textContent = "Status: Unknown";
        elPayStatus.textContent = "Payment: —";
        elPaidAmount.textContent = "Paid: —";
        elPeriodEnd.textContent = "Current Period End: —";
        manageBtn.style.display = "none";
        return;
      }

      const sub = resp?.subscription ?? null;

      // No subscription record yet
      if (!sub) {
        subState.innerHTML = `<div class="muted">No subscription record found yet.</div>`;
        elSubStatus.textContent = "Status: —";
        elPayStatus.textContent = "Payment: —";
        elPaidAmount.textContent = "Paid: —";
        elPeriodEnd.textContent = "Current Period End: —";
        manageBtn.style.display = "none";
        return;
      }

      // Normalize + present
      const statusRaw = (sub.status || "unknown").toString();
      const statusPretty = statusRaw.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());

      const paymentRaw = (sub.last_payment_status || "unknown").toString();
      const paymentPretty = paymentRaw.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());

      const paid = (sub.last_payment_amount != null)
        ? `$${Number(sub.last_payment_amount).toFixed(2)}`
        : "—";

      const periodEnd = sub.current_period_end
        ? new Date(sub.current_period_end).toLocaleString()
        : "—";

      elSubStatus.textContent = `Status: ${statusPretty}`;
      elPayStatus.textContent = `Payment: ${paymentPretty}`;
      elPaidAmount.textContent = `Paid: ${paid}`;
      elPeriodEnd.textContent = `Current Period End: ${periodEnd}`;

      const activeish = ["active", "trialing", "past_due", "unpaid"].includes(statusRaw);
      manageBtn.style.display = activeish ? "inline-flex" : "none";

      subState.innerHTML = `<div class="muted">${
        statusRaw === "active" ? "Subscription is active."
        : statusRaw === "trialing" ? "Trial is active."
        : statusRaw === "past_due" ? "Payment is past due — update billing to restore service."
        : "No active subscription."
      }</div>`;
    }



    async function callFn(name, body) {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.access_token) throw new Error("Not logged in.");

      const { data, error } = await sb.functions.invoke(name, {
        body: body || {},
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (error) throw new Error(error.message || "Edge function error");
      return data;
    }




    subscribeBtn.addEventListener("click", async () => {
      subscribeBtn.disabled = true;
      try {
        const j = await callFn("create-checkout-session");
        if (!j.url) throw new Error("No checkout URL returned.");
        window.location.href = j.url;
      } catch (e) {
        alert(e.message || String(e));
        subscribeBtn.disabled = false;
      }
    });

    manageBtn.addEventListener("click", async () => {
      manageBtn.disabled = true;
      try {
        const j = await callFn("create-portal-session");
        if (!j.url) throw new Error("No portal URL returned.");
        window.location.href = j.url;
      } catch (e) {
        alert(e.message || String(e));
        manageBtn.disabled = false;
      }
    });

    const user = await requireUser();
    if (user) {
      await loadInquiry(user.email);

      try {
        await loadSubscription();
      } catch (e) {
        console.error("loadSubscription failed:", e);

        // Hard-fail UI so it doesn't sit on Loading forever
        subState.innerHTML = `<div class="muted">Subscription unavailable.</div>`;
        elSubStatus.textContent = "Status: Unknown";
        elPayStatus.textContent = "Payment: —";
        elPaidAmount.textContent = "Paid: —";
        elPeriodEnd.textContent = "Current Period End: —";
        manageBtn.style.display = "none";
      }
    }

  </script>
  </main>


  <script>
    // Mobile menu (consistent across your mobile pages)
    (function(){
      const menu = document.getElementById("menu");
      const scrim = document.getElementById("scrim");
      const openBtn = document.getElementById("openMenu");
      const closeBtn = document.getElementById("closeMenu");

      if(!menu || !scrim || !openBtn || !closeBtn) return;

      function open(){
        menu.classList.add("open");
        scrim.classList.add("open");
        menu.setAttribute("aria-hidden","false");
        scrim.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function close(){
        menu.classList.remove("open");
        scrim.classList.remove("open");
        menu.setAttribute("aria-hidden","true");
        scrim.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      openBtn.addEventListener("click", open);
      closeBtn.addEventListener("click", close);
      scrim.addEventListener("click", close);
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });
    })();
  </script>

  <script>
    // View Desktop Site preference
    (function(){
      const a = document.getElementById("viewDesktop");
      if (!a) return;
      a.addEventListener("click", function(e){
        e.preventDefault();
        localStorage.setItem("sns_force_desktop", "1");
        location.replace("/sns-dashboard/");
      });
    })();
  </script>

</body>
</html>
