<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS ¬∑ Admin Inquiries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <style>
        /* Prevent 100% width + padding from overflowing containers */
    *, *::before, *::after { box-sizing: border-box; }

    /* Make the login card able to place an X button */
    .login-card { position: relative; }

    /* Input sizing + extra right padding to ‚Äúmake room‚Äù for browser icons */
    .field input{
    box-sizing: border-box;
    max-width: 100%;
    padding-right: 3rem; /* space for browser/password-manager icons */
    }

    .top-actions{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:.6rem;
  flex-wrap:wrap;
}

.top-actions .pill{
  margin:0;
}


    /* Modern close button (top-right) */
    .login-close{
    position: absolute;
    top: 14px;
    right: 14px;
    width: 36px;
    height: 36px;
    border-radius: 999px;
    border: 1px solid rgba(129,118,255,.28);
    background: rgba(15, 10, 55, 0.55);
    color: #f4f0ff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform .08s ease, border-color .12s ease, filter .12s ease;
    }
    .login-close:hover{
    transform: translateY(-1px);
    border-color: rgba(179,124,255,.55);
    filter: brightness(1.08);
    }
    .login-close:active{ transform: translateY(1px); }
    .login-close svg{ width: 16px; height: 16px; opacity: .9; }

    body { margin:0; background: radial-gradient(circle at top, #342067, #050315 55%, #020010); color:#f4f0ff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap{
  width: min(1600px, calc(100% - 32px)); /* wider container, still centered */
  margin: 0 auto;
  padding: 3rem 0 4rem;                  /* remove extra left/right padding */
}

    .toprow { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    h1 { margin:0; letter-spacing:.18em; text-transform:uppercase; }
    .sub { color:#bdb7ff; margin-top:.6rem; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .95rem; border-radius:999px; border:1px solid rgba(129,118,255,.35); background: rgba(9,6,34,.65); color:#d9d3ff; font-size:.85rem; }

    .card {
      margin-top: 1.75rem;
      background: rgba(9, 6, 34, 0.9);
      border: 1px solid rgba(130, 106, 255, 0.3);
      border-radius: 28px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(16px);
      padding: 1.25rem 1.25rem 1.1rem;
      /* overflow removed so UI elements aren't clipped */
    }

    .toolbar { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; justify-content:space-between; margin-bottom: .8rem; }
    .toolbar-left, .toolbar-right { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }

/* Modern toolbar layout (tighter + cleaner) */
.toolbar-grid{
  display: grid;
  grid-template-columns: auto auto;   /* <-- no more giant 1fr gap */
  justify-content: space-between;     /* pushes left + right, but not ‚Äúmiles apart‚Äù */
  gap: .85rem 1rem;
  align-items: start;
  margin-bottom: 1rem;
  padding-bottom: .9rem;
  border-bottom: 1px solid rgba(129,118,255,.14);
}

/* Force the Sync group to always sit in the RIGHT column */
.toolgroup-sync { grid-column: 2; justify-self: end; text-align: right; }

.toolgroup{ display:flex; flex-direction:column; gap:.5rem; }
.toolgroup-right{ justify-self:end; text-align:right; }

/* Responsive: stack nicely on small screens */
@media (max-width: 780px){
  .toolbar-grid{ grid-template-columns: 1fr; }
  .toolgroup-right{ justify-self:start; text-align:left; }
}


/* Button variants */
.btn-soft{
  background: rgba(15, 10, 55, 0.55);
  border-color: rgba(129,118,255,.28);
}
.btn-primary{
  background: rgba(179,124,255,.18);
  border-color: rgba(179,124,255,.45);
}
.btn-primary:hover{
  border-color:#b37cff;
  box-shadow:0 0 0 1px rgba(179,124,255,.35);
}

.btn-chip{
  padding:.6rem .9rem;
}

/* Tiny color dots for flag buttons */
.dot{
  width:10px; height:10px; border-radius:999px;
  box-shadow: 0 0 0 2px rgba(255,255,255,.06);
  display:inline-block;
}
.dot-red{ background:#ff6262; }
.dot-yellow{ background:#ffd45a; }
.dot-green{ background:#6cffb0; }
.dot-none{ background: rgba(255,255,255,.18); }

/* Responsive: stack nicely on small screens */
@media (max-width: 780px){
  .toolbar-grid{ grid-template-columns: 1fr; }
  .toolgroup-right{ justify-self:start; text-align:left; }
}


    .btn {
      border-radius:999px;
      padding:.65rem 1.05rem;
      border:1px solid rgba(129,118,255,.35);
      background: rgba(15, 10, 55, 0.8);
      color:#f4f0ff;
      cursor:pointer;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.78rem;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
      white-space:nowrap;
    }
    .btn:hover { transform: translateY(-1px); border-color:#b37cff; box-shadow:0 0 0 1px rgba(179,124,255,.35); filter:brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn-danger { border-color: rgba(255,98,98,.45); }
    .btn-danger:hover { border-color:#ff6262; box-shadow:0 0 0 1px rgba(255,98,98,.25); }

    /* Minimal home icon button (matches SNS theme) */
.icon-btn{
  width: 38px;
  height: 38px;
  border-radius: 999px;
  border: 1px solid rgba(129,118,255,.35);
  background: rgba(15, 10, 55, 0.70);
  color: #d9d3ff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
  user-select: none;
}
.icon-btn:hover{
  transform: translateY(-1px);
  border-color:#b37cff;
  box-shadow:0 0 0 1px rgba(179,124,255,.35);
  filter:brightness(1.05);
}
.icon-btn:active{ transform: translateY(1px); }
.icon-btn svg{ width: 18px; height: 18px; opacity: .95; }



    table { width:100%; border-collapse: collapse; }
    th, td { padding: .85rem .6rem; border-bottom: 1px solid rgba(129,118,255,.18); color:#e9e5ff; font-size:.92rem; text-align:left; vertical-align: middle; }
    th { color:#cfc8ff; font-size:.78rem; letter-spacing:.12em; text-transform:uppercase; }
    .muted { color:#bdb7ff; font-size:.85rem; }

    .status { font-weight:700; font-size:.8rem; letter-spacing:.08em; text-transform:uppercase; }
    .s-assigned { color:#bdb7ff; }
    .s-working { color:#7bb8ff; }
    .s-completed { color:#7af9c4; }

    .flag { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; box-shadow: 0 0 0 2px rgba(255,255,255,.06); vertical-align: middle; }
    .f-red { background:#ff6262; }
    .f-yellow { background:#ffd45a; }
    .f-green { background:#6cffb0; }
    .f-none { background: rgba(255,255,255,.18); }

    .err { margin-top:.8rem; color:#ff9494; font-size:.9rem; display:none; }
    .ok { margin-top:.8rem; color:#7af9c4; font-size:.9rem; display:none; }

    /* Login overlay */
    .overlay {
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center;
      padding: 1rem;
      z-index: 9999;
    }
    .login-card {
      width: min(520px, 100%);
      background: rgba(9, 6, 34, 0.95);
      border: 1px solid rgba(130, 106, 255, 0.35);
      border-radius: 28px;
      box-shadow: 0 25px 90px rgba(0, 0, 0, 0.75);
      padding: 1.75rem 1.5rem 1.4rem;
    }
    .login-title { margin:0; letter-spacing:.16em; text-transform:uppercase; font-size:1.05rem; }
    .login-sub { margin:.6rem 0 1.1rem; color:#bdb7ff; line-height:1.45; font-size:.9rem; }
    .field label { display:block; margin:.7rem 0 .35rem; font-size:.78rem; color:#d5cffc; letter-spacing:.1em; text-transform:uppercase; }
    .field input {
      width:100%;
      border-radius: 999px;
      border: 1px solid rgba(129,118,255,.35);
      background: rgba(9,6,34,.95);
      color:#f4f0ff;
      padding:.75rem 1rem;
      outline:none;
    }
    .field input:focus { border-color:#9c88ff; box-shadow:0 0 0 1px rgba(156,136,255,.55); }
    .login-actions { display:flex; gap:.7rem; justify-content:space-between; align-items:center; margin-top: 1.1rem; flex-wrap:wrap; }
    .tiny { font-size:.8rem; color:#9ea0d7; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toprow">
      <div>
        <h1>SNS INQUIRIES</h1>
        <div class="sub">Internal dashboard</div>
      </div>
      <div class="top-actions">
        <span class="pill" id="whoami">Not signed in</span>

        <a class="icon-btn" href="/sns/index.html" title="Back to SNS Home" aria-label="Home">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5.5 10.5V20h13V10.5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>

      </div>

    <div class="card" id="adminCard" style="display:none;">
<div class="toolbar toolbar-grid">
  <div class="toolgroup">
    <div class="tooltitle">Status</div>
    <div class="toolrow">
      <button class="btn btn-soft" id="markWorkingBtn">Working</button>
      <button class="btn btn-soft" id="markCompletedBtn">Completed</button>
      <button class="btn btn-soft" id="resetAssignedBtn">Assigned</button>
    </div>
  </div>

  <div class="toolgroup toolgroup-right">
    <div class="tooltitle">Manage</div>
    <div class="toolrow">
      <button class="btn btn-danger" id="deleteSelectedBtn">Delete selected</button>
      <button class="btn btn-danger" id="resetWorkOrdersBtn" type="button">Reset WO #'s</button>
    </div>
  </div>

  <div class="toolgroup">
    <div class="tooltitle">Priority</div>
    <div class="toolrow">
      <button class="btn btn-chip" id="flagRedBtn"><span class="dot dot-red"></span>Red</button>
      <button class="btn btn-chip" id="flagYellowBtn"><span class="dot dot-yellow"></span>Yellow</button>
      <button class="btn btn-chip" id="flagGreenBtn"><span class="dot dot-green"></span>Green</button>
      <button class="btn btn-chip" id="flagNoneBtn"><span class="dot dot-none"></span>Clear</button>
    </div>
  </div>

  <div class="toolgroup toolgroup-right">
  <div class="tooltitle">Search</div>
  <div class="toolrow">
    <input id="searchBox" type="text" placeholder="Search"
      style="
        width:min(520px, 100%);
        padding:.7rem 1rem;
        border-radius:999px;
        border:1px solid rgba(129,118,255,.35);
        background: rgba(9,6,34,.95);
        color:#f4f0ff;
        outline:none;
      "
    />
  </div>
</div>


  <div class="toolgroup toolgroup-right toolgroup-sync">
    <div class="tooltitle">Sync</div>
    <div class="toolrow">
      <button class="btn btn-primary" id="refreshBtn">Refresh</button>
    </div>
  </div>
</div>


      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:42px;"><input type="checkbox" id="selectAll"></th>
              <th>Date</th>
              <th>Work Order</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Contact</th>
              <th>Business</th>
              <th>Services</th>
              <th style="width:230px; text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>



  <div class="muted" id="detailsMeta" style="margin-top:.7rem;"></div>


</div>


      <div class="muted" style="margin-top:.8rem;">
        ¬© 2025 kxsaku ¬∑ Built from the homelab.
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="overlay" id="loginOverlay" style="display:none;">
    <div class="login-card" style="position:relative;">
        <button class="login-close" id="loginCloseBtn" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
            </button>
        <h2 class="login-title">Admin login</h2>
      <p class="login-sub">
        Sign in to view and manage inquiries. This page can load publicly, but data is protected by Supabase policies.
      </p>

      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" placeholder="Email">
      </div>

      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <div class="login-actions">
        <span class="tiny" id="loginHint"></span>
        <button class="btn" id="loginBtn">Sign in</button>
      </div>

      <div class="err" id="loginErr" style="display:none;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Global Quick Look tooltip (floats above everything) -->
<div id="qlTooltip" style="
  position: fixed;
  z-index: 99999;
  display: none;
  pointer-events: none;
  max-width: 420px;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(129,118,255,.35);
  background: rgba(9, 6, 34, 0.98);
  color: #f4f0ff;
  box-shadow: 0 25px 80px rgba(0,0,0,.65);
  backdrop-filter: blur(16px);
">
</div>

  <script>
    /**************************************************************
     * REQUIRED: Paste your Supabase details below
     **************************************************************/
    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const ADMIN_EMAIL = "brandon.sns@pm.me";
    /**************************************************************/

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const searchBox = document.getElementById("searchBox");



let allInquiries = [];
let filteredInquiries = [];


function fmtWO(n){
  if (n == null) return "";
  return "WO-" + String(n).padStart(6, "0");
}

function includesCI(haystack, needle){
  return (haystack || "").toString().toLowerCase().includes((needle || "").toString().toLowerCase());
}
    const rowsEl = document.getElementById("rows");
    const errBox = document.getElementById("errBox");
    const okBox = document.getElementById("okBox");
    const whoami = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginCloseBtn = document.getElementById("loginCloseBtn");

    const loginOverlay = document.getElementById("loginOverlay");
    const loginBtn = document.getElementById("loginBtn");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const loginErr = document.getElementById("loginErr");
    const loginHint = document.getElementById("loginHint");

    const selectAll = document.getElementById("selectAll");
    const refreshBtn = document.getElementById("refreshBtn");
    const resetWorkOrdersBtn = document.getElementById("resetWorkOrdersBtn");

    function showErr(msg) { errBox.style.display = "block"; errBox.textContent = msg; }
    function clearErr() { errBox.style.display = "none"; errBox.textContent = ""; }
    function showOk(msg) { okBox.style.display = "block"; okBox.textContent = msg; setTimeout(() => okBox.style.display="none", 2000); }

    const adminCard = document.getElementById("adminCard");

    function getEmail(r){
      return (r?.contact_email ?? r?.email ?? r?.contactEmail ?? r?.contact_email_address ?? r?.contactEmailAddress ?? "");
    }
    function getPhone(r){
      return (r?.contact_phone ?? r?.phone ?? r?.contactPhone ?? r?.contact_phone_number ?? r?.contactPhoneNumber ?? "");
    }

    function setLocked(isLocked){
    if (isLocked){
        adminCard.style.display = "none";   // nothing visible behind overlay
    } else {
        adminCard.style.display = "block";
      }
    }

    function applySearchAndRender(){
  const q = (searchBox?.value || "").trim().toLowerCase();

  filteredInquiries = !q ? allInquiries : allInquiries.filter(r => {
    const wo = fmtWO(r.work_order);
    const services = Array.isArray(r.services) ? r.services.join(", ") : (r.services || "");
    return (
      includesCI(r.contact_name, q) ||
      includesCI(getEmail(r), q) ||
      includesCI(getPhone(r), q) ||
      includesCI(r.business_name, q) ||
      includesCI(services, q) ||
      includesCI(wo, q) ||
      includesCI(r.work_order, q)
    );
  });

  rowsEl.innerHTML = filteredInquiries.map(r => `
    <tr data-rowid="${sanitize(r.id)}">
      <td><input type="checkbox" data-id="${sanitize(r.id)}"></td>
      <td>${sanitize(fmtDate(r.created_at))}</td>
      <td>${sanitize(fmtWO(r.work_order))}</td>
      <td><span class="flag ${flagClass(r.priority_flag)}"></span>${sanitize(r.priority_flag || "none")}</td>
      <td class="status ${statusClass(r.status)}">${sanitize(r.status || "assigned")}</td>
      <td>${sanitize(r.contact_name || "")}</td>
      <td>${sanitize(r.business_name || "")}</td>
      <td>${sanitize(Array.isArray(r.services) ? r.services.join(", ") : (r.services || ""))}</td>
      <td style="text-align:right; white-space:nowrap;">
        <button class="btn btn-soft" data-eye="${sanitize(r.id)}" type="button" title="Quick look">üëÅ</button>
        <button class="btn btn-soft" data-view="${sanitize(r.id)}" type="button">View</button>
        <button class="btn btn-danger" data-del="${sanitize(r.id)}" type="button">Delete</button>
      </td>
    </tr>
  `).join("");

  // keep ‚Äúselect all‚Äù sane after rerender
  selectAll.checked = false;
}

    
if (resetWorkOrdersBtn) {
  resetWorkOrdersBtn.addEventListener("click", async () => {
    clearErr();

    const user = await requireAdminSession();
    if (!user) return;

    const ok1 = confirm("Are you sure you want to RESET ALL work order numbers? This will renumber every inquiry.");
    if (!ok1) return;

    const ok2 = confirm("Last warning: This cannot be undone. Proceed?");
    if (!ok2) return;

    resetWorkOrdersBtn.disabled = true;
    resetWorkOrdersBtn.style.opacity = "0.6";

    const { error } = await sb.rpc("reset_work_orders");

    resetWorkOrdersBtn.disabled = false;
    resetWorkOrdersBtn.style.opacity = "1";

    if (error) {
      showErr("Reset failed: " + error.message);
      return;
    }

    showOk("Work order numbers reset.");
    await loadInquiries();
  });
}

    loginCloseBtn.addEventListener("click", () => {
    hideLogin();

    // Go back to the page you were on before clicking Admin (best UX)
    if (history.length > 1) history.back();
    else window.location.href = "/"; // fallback
    });



    function showLogin(msg) {
    // Hide the admin UI entirely (no blurred ‚Äúleak‚Äù behind the modal)
    if (adminCard) adminCard.style.display = "none";

    loginOverlay.style.display = "flex";
    loginErr.style.display = "none";
    loginErr.textContent = "";
    loginHint.textContent = msg || "";

    // DO NOT prefill email
    loginEmail.value = "";
    loginPass.value = "";
    }

    function hideLogin() {
      loginOverlay.style.display = "none";
      loginErr.style.display = "none";
      loginErr.textContent = "";
      loginHint.textContent = "";
    }

    function sanitize(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    function fmtDate(iso) {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function flagClass(v) {
      if (v === "red") return "f-red";
      if (v === "yellow") return "f-yellow";
      if (v === "green") return "f-green";
      return "f-none";
    }

    function statusClass(v) {
      if (v === "working") return "s-working";
      if (v === "completed") return "s-completed";
      return "s-assigned";
    }

    function getSelectedIds() {
      return Array.from(document.querySelectorAll("input[data-id]:checked")).map(x => x.getAttribute("data-id"));
    }

    async function requireAdminSession() {
      const { data: { user } } = await sb.auth.getUser();

      if (!user) {
        whoami.textContent = "Not signed in";
        logoutBtn.style.display = "none";
        setLocked(true);
        showLogin("Sign in to load inquiries.");
        return null;
      }

      if ((user.email || "").toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
        await sb.auth.signOut();
        whoami.textContent = "Wrong account";
        logoutBtn.style.display = "none";
        setLocked(true);
        showLogin("Use your admin email to sign in.");
        return null;
      }

      whoami.textContent = "Signed in: " + user.email;
      logoutBtn.style.display = "inline-flex";
      setLocked(false);
      hideLogin();
      if (adminCard) adminCard.style.display = "block";
      return user;
    }

    // Prevent overlapping renders (this fixes the duplicates/refresh weirdness)
    let loadNonce = 0;

    async function loadInquiries() {
      const myNonce = ++loadNonce;
      clearErr();

      refreshBtn.disabled = true;
      refreshBtn.style.opacity = "0.6";

      // Require admin first
      const user = await requireAdminSession();
      if (!user) {
        refreshBtn.disabled = false;
        refreshBtn.style.opacity = "1";
        return;
      }

      // Query
      const { data, error } = await sb
        .from("inquiries")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(200);


      // If another load started after this one, ignore this result
      if (myNonce !== loadNonce) return;

      refreshBtn.disabled = false;
      refreshBtn.style.opacity = "1";

      if (error) {
        rowsEl.innerHTML = "";
        showErr("Could not load inquiries: " + error.message);
        return;
      }

      if (!data || data.length === 0) {
        rowsEl.innerHTML = `<tr><td colspan="9" class="muted" style="padding:1.2rem .6rem;">
          No inquiries returned.
        </td></tr>`;
        return;
      }


      // Build rows once (avoids duplicate append behavior)
      allInquiries = data;
      applySearchAndRender();

      

      selectAll.checked = false;
    }

    async function updateMany(patch) {
      clearErr();
      const ids = getSelectedIds();
      if (ids.length === 0) { showErr("Select at least one inquiry."); return; }

      const { error } = await sb.from("inquiries").update(patch).in("id", ids);
      if (error) { showErr(error.message); return; }

      showOk("Updated " + ids.length + " inquiry(s).");
      await loadInquiries();
    }

        async function deleteMany(ids) {
  clearErr();
  if (!ids || ids.length === 0) { showErr("Select at least one inquiry."); return; }

  const ok = confirm(`Delete ${ids.length} inquiry(s)? This cannot be undone.`);
  if (!ok) return;

  const { error, count } = await sb
    .from("inquiries")
    .delete({ count: "exact" })
    .in("id", ids);

  if (error) {
    showErr("Delete failed: " + error.message);
    return;
  }

  if (!count || count === 0) {
    showErr("Delete request returned 0 deleted rows. This usually means RLS is blocking DELETE.");
    return;
  }

  showOk(`${count} inquiry deleted.`);
  await loadInquiries();
}



    // Toolbar events

    // --- Tooltip helpers (global floating tooltip; not clipped) ---
const qlTooltip = document.getElementById("qlTooltip");

function showTooltip(html, x, y) {
  qlTooltip.innerHTML = html;
  qlTooltip.style.display = "block";

  const pad = 14;
  // Force layout so rect is accurate after innerHTML change
  const rect = qlTooltip.getBoundingClientRect();

  let left = x + 14;
  let top  = y + 14;

  if (left + rect.width + pad > window.innerWidth) left = window.innerWidth - rect.width - pad;
  if (top + rect.height + pad > window.innerHeight) top = window.innerHeight - rect.height - pad;

  qlTooltip.style.left = left + "px";
  qlTooltip.style.top  = top + "px";
}

function hideTooltip() {
  qlTooltip.style.display = "none";
  qlTooltip.innerHTML = "";
}

// --- Row-level actions + tooltip (event delegation) ---



document.addEventListener("click", async (e) => {
  const viewBtn = e.target.closest("[data-view]");
  if (viewBtn) {
    const id = viewBtn.getAttribute("data-view");
    window.location.href = `/sns-inquiry-view/index.html?id=${encodeURIComponent(id)}`;
    return;
  }

  const delBtn = e.target.closest("[data-del]");
  if (delBtn) {
    const id = delBtn.getAttribute("data-del");
    await deleteMany([id]);
    return;
  }
});

// Keep tooltip near cursor when visible
document.addEventListener("mousemove", (e) => {
  if (qlTooltip.style.display === "block") {
    showTooltip(qlTooltip.innerHTML, e.clientX, e.clientY);
  }
});

// IMPORTANT: use mouseover/mouseout (mouseenter doesn't bubble reliably for delegation)
document.addEventListener("mouseover", (e) => {
  const eyeBtn = e.target.closest("[data-eye]");
  if (!eyeBtn) return;

  const row = eyeBtn.closest("tr");
  if (!row) return;

  const tds = row.querySelectorAll("td");
  const date     = tds[1]?.textContent?.trim() || "";
  const workOrder= tds[2]?.textContent?.trim() || "";
  const priority = tds[3]?.textContent?.trim() || "";
  const status   = tds[4]?.textContent?.trim() || "";
  const contact  = tds[5]?.textContent?.trim() || "";
  const business = tds[6]?.textContent?.trim() || "";
  const services = tds[7]?.textContent?.trim() || "";

  const html = `
    <div style="letter-spacing:.14em; text-transform:uppercase; font-size:.78rem; color:#cfc8ff; margin-bottom:.5rem;">
      Quick Look
    </div>
    <div style="font-size:.92rem; line-height:1.45;">
      <div><span style="color:#bdb7ff;">Date:</span> ${sanitize(date)}</div>
      <div><span style="color:#bdb7ff;">Work Order:</span> ${sanitize(workOrder)}</div>
      <div><span style="color:#bdb7ff;">Status:</span> ${sanitize(status)}</div>
      <div><span style="color:#bdb7ff;">Priority:</span> ${sanitize(priority)}</div>
      <div style="margin-top:.45rem;"><span style="color:#bdb7ff;">Contact:</span> ${sanitize(contact)}</div>
      <div><span style="color:#bdb7ff;">Business:</span> ${sanitize(business)}</div>
      <div style="margin-top:.45rem;"><span style="color:#bdb7ff;">Services:</span> ${sanitize(services)}</div>
    </div>
  `;

  showTooltip(html, e.clientX, e.clientY);
});

// Search
searchBox.addEventListener("input", () => applySearchAndRender());




document.addEventListener("mouseout", (e) => {
  const eyeBtn = e.target.closest("[data-eye]");
  if (!eyeBtn) return;

  // If you're still inside the same eye button, ignore
  if (e.relatedTarget && eyeBtn.contains(e.relatedTarget)) return;

  hideTooltip();
});

    document.getElementById("refreshBtn").addEventListener("click", () => loadInquiries());
    document.getElementById("markWorkingBtn").addEventListener("click", () => updateMany({ status: "working" }));
    document.getElementById("markCompletedBtn").addEventListener("click", () => updateMany({ status: "completed" }));
    document.getElementById("resetAssignedBtn").addEventListener("click", () => updateMany({ status: "assigned" }));

    document.getElementById("flagRedBtn").addEventListener("click", () => updateMany({ priority_flag: "red" }));
    document.getElementById("flagYellowBtn").addEventListener("click", () => updateMany({ priority_flag: "yellow" }));
    document.getElementById("flagGreenBtn").addEventListener("click", () => updateMany({ priority_flag: "green" }));
    document.getElementById("flagNoneBtn").addEventListener("click", () => updateMany({ priority_flag: "none" }));


    document.getElementById("deleteSelectedBtn").addEventListener("click", () => deleteMany(getSelectedIds()));




    selectAll.addEventListener("change", (e) => {
      document.querySelectorAll("input[data-id]").forEach(cb => cb.checked = e.target.checked);
    });

    // Row-level delete (event delegation)

    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      showOk("Signed out.");
      await loadInquiries();
    });

    loginBtn.addEventListener("click", async () => {
      loginErr.style.display = "none";
      loginErr.textContent = "";

      try {
        const email = loginEmail.value.trim();
        const password = loginPass.value;

        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;

        await loadInquiries();
      } catch (e) {
        loginErr.style.display = "block";
        loginErr.textContent = e.message || "Login failed.";
      }
    });

    // Important: This can fire during session restore. With nonce guard above, it won‚Äôt duplicate rows.
    sb.auth.onAuthStateChange(() => { loadInquiries(); });

    loadInquiries();
  </script>
</body>
</html>
