<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS ¬∑ Admin Inquiries (Mobile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://esm.sh; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com; img-src 'self' data: blob: https://*.supabase.co; font-src 'self'; frame-src https://js.stripe.com;" />
  <link rel="stylesheet" href="/styles.css" />

  <style>
/* ============================================================
   Mobile Nav (scoped) ‚Äî matches your other mobile pages
   (scoped so it does NOT affect existing .btn styles here)
   ============================================================ */
.mnav-wrap{
  width: min(640px, calc(100% - 1.25rem));
  margin: 0 auto;
}
.mnav-topnav{
  position: sticky;
  top: 0;
  z-index: 6000;
  padding: .9rem 0;
  backdrop-filter: blur(14px);
  background: linear-gradient(180deg, rgba(3,1,11,.78), rgba(3,1,11,.22));
  border-bottom: 1px solid rgba(196,181,253,.10);
}
.mnav-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
}
.mnav-brand{
  display:flex;
  align-items:center;
  gap:.7rem;
  min-width:0;
}
.mnav-mark{
  width:42px;height:42px;border-radius:14px;
  display:grid;place-items:center;
  box-shadow: 0 18px 50px rgba(0,0,0,.45);
  flex:0 0 auto;
}
.mnav-mark img{
  width:100%;height:100%;
  object-fit:contain;
  border-radius:12px;
}
.mnav-brandText{ min-width:0; }
.mnav-brandText strong{
  display:block;
  font-size:.88rem;
  letter-spacing:.14em;
  text-transform:uppercase;
  line-height:1.05;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:70vw;
}
.mnav-brandText span{
  display:block;
  color: rgba(244,240,255,.56);
  font-size:.82rem;
  line-height:1.1;
  margin-top:.18rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:70vw;
}
.mnav-iconBtn{
  width:44px;height:44px;
  border-radius:14px;
  border:1px solid rgba(196,181,253,.18);
  background: rgba(0,0,0,.18);
  backdrop-filter: blur(10px);
  box-shadow: 0 12px 40px rgba(0,0,0,.28);
  display:grid;
  place-items:center;
  cursor:pointer;
  transition: transform .14s ease, border-color .14s ease, filter .14s ease;
  -webkit-tap-highlight-color: transparent;
}
.mnav-iconBtn:active{ filter: brightness(1.04); }
.mnav-iconBtn svg{ opacity:.92; }

.mnav-scrim{
  position: fixed;
  inset: 0;
  z-index: 7000;
  background: rgba(0,0,0,.55);
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease;
}
.mnav-scrim.open{ opacity:1; pointer-events:auto; }

.mnav-menu{
  position: fixed;
  left: 0; right: 0; top: 0;
  z-index: 8000;
  transform: translateY(-110%);
  transition: transform .24s cubic-bezier(.2,.9,.2,1);
  padding: .95rem 0 .9rem;
  backdrop-filter: blur(16px);
  background: linear-gradient(180deg, rgba(3,1,11,.92), rgba(3,1,11,.58));
  border-bottom: 1px solid rgba(196,181,253,.14);
}
.mnav-menu.open{ transform: translateY(0); }

.mnav-menuHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
  padding-bottom: .75rem;
  border-bottom: 1px solid rgba(196,181,253,.10);
}
.mnav-links{
  display:grid;
  gap:.55rem;
  padding-top:.85rem;
}
.mnav-links a{
  text-decoration:none;
  color: rgba(244,240,255,.72);
  font-size: .80rem;
  letter-spacing:.14em;
  text-transform: uppercase;
  padding: .8rem .95rem;
  border-radius: 16px;
  border: 1px solid rgba(196,181,253,.10);
  background: rgba(196,181,253,.04);
  transition: border-color .14s ease, filter .14s ease, background .14s ease, color .14s ease;
  -webkit-tap-highlight-color: transparent;
}
.mnav-links a:active{
  border-color: rgba(196,181,253,.22);
  filter: brightness(1.04);
  color: rgba(244,240,255,.92);
}
.mnav-links a.active{
  background: rgba(179,124,255,.16);
  border-color: rgba(179,124,255,.26);
  color: rgba(244,240,255,.92);
}

.mnav-actions{
  margin-top:.85rem;
  display:grid;
  gap:.65rem;
}
.mnav-btn{
  position: relative;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height: 42px;
  padding: 0 16px;
  border-radius: 999px;
  border: 1px solid rgba(196,181,253,.18);
  background: rgba(0,0,0,.18);
  color: rgba(244,240,255,.92);
  text-decoration:none;
  font-weight: 800;
  font-size: .78rem;
  letter-spacing: .12em;
  text-transform: uppercase;
  box-shadow: 0 12px 40px rgba(0,0,0,.32);
  backdrop-filter: blur(10px);
  transition: filter .14s ease, border-color .14s ease, background .14s ease;
  overflow:hidden;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}
.mnav-btn:active{ filter:brightness(1.03); }
.mnav-btn.primary{
  background: linear-gradient(90deg, rgba(179,124,255,.92), rgba(249,115,226,.72));
  border-color: rgba(255,255,255,.18);
}
.mnav-actions .mnav-btn{ width:100%; }

@media (prefers-reduced-motion: reduce){
  .mnav-menu, .mnav-scrim { transition:none !important; }
}


/* ============================================================
   Mobile fitting overrides for sns-admin
   ============================================================ */
@media (max-width: 820px){
  .wrap{
    width: min(640px, calc(100% - 1.25rem));
    padding: 1.4rem 0 2.4rem;
  }
  .toprow{
    flex-direction: column;
    align-items: stretch;
    gap: .85rem;
  }
  .top-actions{
    justify-content: flex-start;
  }
  h1{ font-size: 1.25rem; }
  .card{ border-radius: 22px; padding: 1.05rem .95rem 1rem; }
  /* Invite row: prevent overflow */
  #inviteEmail{
    min-width: 0 !important;
    width: 100% !important;
  }
  #inviteBtn{
    width: 100%;
  }
  /* Ensure any direct style min-width doesn't break */
  input[type="email"][id="inviteEmail"]{
    min-width: 0 !important;
  }
  /* Table scroll is OK; make it feel intentional */
  .tableScroll{
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 18px;
    border: 1px solid rgba(129,118,255,.18);
  }
  table{ min-width: 980px; }
}

</style>
</head>

<body>

  <!-- Mobile Nav (consistent) -->
  <div class="mnav-scrim" id="mnavScrim" aria-hidden="true"></div>

  <aside class="mnav-menu" id="mnavMenu" aria-label="Mobile Menu" aria-hidden="true">
    <div class="mnav-wrap">
      <div class="mnav-menuHeader">
        <div class="mnav-brand" style="gap:.65rem;">
          <div class="mnav-mark" style="width:40px;height:40px;border-radius:14px;">
            <img src="/assets/sns-logo-purple.png" alt="Saku Network Solutions logo">
          </div>
          <div class="mnav-brandText">
            <strong>SAKU NETWORK SOLUTIONS</strong>
            <span>Network infrastructure, done clean.</span>
          </div>
        </div>

        <button class="mnav-iconBtn" id="mnavClose" aria-label="Close menu" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="rgba(244,240,255,.92)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <nav class="mnav-links" aria-label="Primary">
        <a href="/home/">Home</a>
        <a href="/sns/">Services</a>
        <a href="/credibility/">Credibility</a>
        <a href="/resources/">Resources</a>
        <a href="/contact/">Contact</a>
      </nav>

      <div class="mnav-actions">
        <a class="mnav-btn" href="/sns-login/">Client Login</a>
        <a class="mnav-btn primary" href="/sns-inquiry/">Start an Inquiry</a>
        <a class="mnav-btn" href="#" id="mnavViewDesktop">View Desktop Site</a>
      </div>
    </div>
  </aside>

  <header class="mnav-topnav">
    <div class="mnav-wrap">
      <div class="mnav-row">
        <div class="mnav-brand">
          <div class="mnav-mark">
            <img src="/assets/sns-logo-purple.png" alt="Saku Network Solutions logo">
          </div>
          <div class="mnav-brandText">
            <strong>SAKU NETWORK SOLUTIONS</strong>
            <span>Network infrastructure, done clean.</span>
          </div>
        </div>

        <button class="mnav-iconBtn" id="mnavOpen" aria-label="Open menu" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(244,240,255,.92)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

<div class="wrap">
    <div class="toprow">
      <div>
        <h1>SNS INQUIRIES</h1>
        <div class="sub">Internal dashboard</div>
      </div>
      <div class="top-actions">
        <span class="pill" id="whoami">Not signed in</span>

        <a class="icon-btn" href="/sns/index.html" title="Back to SNS Home" aria-label="Home">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5.5 10.5V20h13V10.5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>

      </div>

    <div class="card" id="adminCard" style="display:none;">

      <div class="card" style="margin-top:14px;">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
    <div>
      <div style="letter-spacing:.08em; text-transform:uppercase; font-size:.85rem; color: rgba(244,240,255,.75);">Invite Client (Invite-only accounts)</div>
      <div class="muted" style="margin-top:6px;">Sends a secure one-time invite link to create a password and activate their dashboard.</div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <input id="inviteEmail" type="email" placeholder="client@email.com" style="min-width:260px;" />
      <button id="inviteBtn" class="btn">Send Invite</button>
    </div>
  </div>
  <div id="inviteMsg" class="muted" style="margin-top:10px;"></div>
</div>

<div class="toolbar toolbar-grid">
  <div class="toolgroup">
    <div class="tooltitle">Status</div>
    <div class="toolrow">
      <button class="btn btn-soft" id="markWorkingBtn">Working</button>
      <button class="btn btn-soft" id="markCompletedBtn">Completed</button>
      <button class="btn btn-soft" id="resetAssignedBtn">Assigned</button>
    </div>
  </div>

  <div class="toolgroup toolgroup-right">
    <div class="tooltitle">Manage</div>
    <div class="toolrow">
      <button class="btn btn-danger" id="deleteSelectedBtn">Delete selected</button>
      <button class="btn btn-danger" id="resetWorkOrdersBtn" type="button">Reset WO #'s</button>
      <a class="btn btn-primary" href="/sns-client-list/index.html">Client List</a>
    </div>
  </div>

  <div class="toolgroup">
    <div class="tooltitle">Priority</div>
    <div class="toolrow">
      <button class="btn btn-chip" id="flagRedBtn"><span class="dot dot-red"></span>Red</button>
      <button class="btn btn-chip" id="flagYellowBtn"><span class="dot dot-yellow"></span>Yellow</button>
      <button class="btn btn-chip" id="flagGreenBtn"><span class="dot dot-green"></span>Green</button>
      <button class="btn btn-chip" id="flagNoneBtn"><span class="dot dot-none"></span>Clear</button>
    </div>
  </div>

  <div class="toolgroup toolgroup-right">
  <div class="tooltitle">Search</div>
  <div class="toolrow">
    <input id="searchBox" type="text" placeholder="Search" class="input" style="width:min(520px, 100%);" />
  </div>
</div>


  <div class="toolgroup toolgroup-right toolgroup-sync">
    <div class="tooltitle">Sync</div>
    <div class="toolrow">
      <button class="btn btn-primary" id="refreshBtn">Refresh</button>
    </div>
  </div>
</div>


      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <div class="tableScroll">
        <table>
          <thead>
            <tr>
              <th style="width:42px;"><input type="checkbox" id="selectAll"></th>
              <th>Date</th>
              <th>Work Order</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Contact</th>
              <th>Business</th>
              <th>Services</th>
              <th style="width:230px; text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>



  <div class="muted" id="detailsMeta" style="margin-top:.7rem;"></div>


</div>


      <div class="muted" style="margin-top:.8rem;">
        ¬© 2025 kxsaku ¬∑ Built from the homelab.
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="overlay" id="loginOverlay" style="display:none;">
    <div class="login-card" style="position:relative;">
        <button class="login-close" id="loginCloseBtn" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
            </button>
        <h2 class="login-title">Admin login</h2>
      <p class="login-sub">
        Sign in to view and manage inquiries. This page can load publicly, but data is protected by Supabase policies.
      </p>

      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" placeholder="Email">
      </div>

      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <div class="login-actions">
        <span class="tiny" id="loginHint"></span>
        <button class="btn" id="loginBtn">Sign in</button>
      </div>

      <div class="err" id="loginErr" style="display:none;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" integrity="sha384-0cJhvyxOncqJDixLuJRbH99K17F1B6DH3D8aUBlsJlsgiqRZQpQ1EUFWdgscplLu" crossorigin="anonymous"></script>
<!-- Global Quick Look tooltip (floats above everything) -->
<div id="qlTooltip" style="
  position: fixed;
  z-index: 99999;
  display: none;
  pointer-events: none;
  max-width: 420px;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(129,118,255,.35);
  background: rgba(9, 6, 34, 0.98);
  color: #f4f0ff;
  box-shadow: 0 25px 80px rgba(0,0,0,.65);
  backdrop-filter: blur(16px);
">
</div>

  <script>
    /**************************************************************
     * REQUIRED: Paste your Supabase details below
     **************************************************************/
    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const ADMIN_EMAIL = "brandon.sns@pm.me";
    /**************************************************************/

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const inviteEmailEl = document.getElementById("inviteEmail");
const inviteBtn = document.getElementById("inviteBtn");
const inviteMsg = document.getElementById("inviteMsg");

async function callEdge(fnName, payload = {}) {
  const { data: sess } = await sb.auth.getSession();
  const token = sess?.session?.access_token;
  if (!token) throw new Error("Not logged in.");

  const res = await fetch(`${SUPABASE_URL}/functions/v1/${fnName}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });

  const j = await res.json();
  if (!res.ok) throw new Error(j?.error || "Request failed");
  return j;
}

inviteBtn?.addEventListener("click", async () => {
  inviteMsg.textContent = "";
  const email = (inviteEmailEl.value || "").trim().toLowerCase();
  if (!email) return (inviteMsg.textContent = "Enter an email.");

  inviteBtn.disabled = true;
  try {
    await callEdge("admin-invite", { email });
    inviteMsg.textContent = `Invite sent to ${email}`;
  } catch (e) {
    inviteMsg.textContent = e?.message || String(e);
  } finally {
    inviteBtn.disabled = false;
  }
});


    const searchBox = document.getElementById("searchBox");



let allInquiries = [];
let filteredInquiries = [];


function fmtWO(n){
  if (n == null) return "";
  return "WO-" + String(n).padStart(6, "0");
}

function includesCI(haystack, needle){
  return (haystack || "").toString().toLowerCase().includes((needle || "").toString().toLowerCase());
}
    const rowsEl = document.getElementById("rows");
    const errBox = document.getElementById("errBox");
    const okBox = document.getElementById("okBox");
    const whoami = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginCloseBtn = document.getElementById("loginCloseBtn");

    const loginOverlay = document.getElementById("loginOverlay");
    const loginBtn = document.getElementById("loginBtn");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const loginErr = document.getElementById("loginErr");
    const loginHint = document.getElementById("loginHint");

    const selectAll = document.getElementById("selectAll");
    const refreshBtn = document.getElementById("refreshBtn");
    const resetWorkOrdersBtn = document.getElementById("resetWorkOrdersBtn");

    function showErr(msg) { errBox.style.display = "block"; errBox.textContent = msg; }
    function clearErr() { errBox.style.display = "none"; errBox.textContent = ""; }
    function showOk(msg) { okBox.style.display = "block"; okBox.textContent = msg; setTimeout(() => okBox.style.display="none", 2000); }

    const adminCard = document.getElementById("adminCard");

    function getEmail(r){
      return (r?.contact_email ?? r?.email ?? r?.contactEmail ?? r?.contact_email_address ?? r?.contactEmailAddress ?? "");
    }
    function getPhone(r){
      return (r?.contact_phone ?? r?.phone ?? r?.contactPhone ?? r?.contact_phone_number ?? r?.contactPhoneNumber ?? "");
    }

    function setLocked(isLocked){
    if (isLocked){
        adminCard.style.display = "none";   // nothing visible behind overlay
    } else {
        adminCard.style.display = "block";
      }
    }

    function applySearchAndRender(){
  const q = (searchBox?.value || "").trim().toLowerCase();

  filteredInquiries = !q ? allInquiries : allInquiries.filter(r => {
    const wo = fmtWO(r.work_order);
    const services = Array.isArray(r.services) ? r.services.join(", ") : (r.services || "");
    return (
      includesCI(r.contact_name, q) ||
      includesCI(getEmail(r), q) ||
      includesCI(getPhone(r), q) ||
      includesCI(r.business_name, q) ||
      includesCI(services, q) ||
      includesCI(wo, q) ||
      includesCI(r.work_order, q)
    );
  });

  rowsEl.innerHTML = filteredInquiries.map(r => `
    <tr data-rowid="${sanitize(r.id)}">
      <td><input type="checkbox" data-id="${sanitize(r.id)}"></td>
      <td>${sanitize(fmtDate(r.created_at))}</td>
      <td>${sanitize(fmtWO(r.work_order))}</td>
      <td><span class="flag ${flagClass(r.priority_flag)}"></span>${sanitize(r.priority_flag || "none")}</td>
      <td class="status ${statusClass(r.status)}">${sanitize(r.status || "assigned")}</td>
      <td>${sanitize(r.contact_name || "")}</td>
      <td>${sanitize(r.business_name || "")}</td>
      <td>${sanitize(Array.isArray(r.services) ? r.services.join(", ") : (r.services || ""))}</td>
      <td style="text-align:right; white-space:nowrap;">
        <button class="btn btn-soft" data-eye="${sanitize(r.id)}" type="button" title="Quick look">üëÅÔ∏è</button>
        <button class="btn btn-soft" data-view="${sanitize(r.id)}" type="button">View</button>
        <button class="btn btn-danger" data-del="${sanitize(r.id)}" type="button">Delete</button>
      </td>
    </tr>
  `).join("");

  // keep ‚Äúselect all‚Äù sane after rerender
  selectAll.checked = false;
}

    
if (resetWorkOrdersBtn) {
  resetWorkOrdersBtn.addEventListener("click", async () => {
    clearErr();

    const user = await requireAdminSession();
    if (!user) return;

    const ok1 = confirm("Are you sure you want to RESET ALL work order numbers? This will renumber every inquiry.");
    if (!ok1) return;

    const ok2 = confirm("Last warning: This cannot be undone. Proceed?");
    if (!ok2) return;

    resetWorkOrdersBtn.disabled = true;
    resetWorkOrdersBtn.style.opacity = "0.6";

    const { error } = await sb.rpc("reset_work_orders");

    resetWorkOrdersBtn.disabled = false;
    resetWorkOrdersBtn.style.opacity = "1";

    if (error) {
      showErr("Reset failed: " + error.message);
      return;
    }

    showOk("Work order numbers reset.");
    await loadInquiries();
  });
}

    loginCloseBtn.addEventListener("click", () => {
    hideLogin();

    // Go back to the page you were on before clicking Admin (best UX)
    if (history.length > 1) history.back();
    else window.location.href = "/"; // fallback
    });



    function showLogin(msg) {
    // Hide the admin UI entirely (no blurred ‚Äúleak‚Äù behind the modal)
    if (adminCard) adminCard.style.display = "none";

    loginOverlay.style.display = "flex";
    loginErr.style.display = "none";
    loginErr.textContent = "";
    loginHint.textContent = msg || "";

    // DO NOT prefill email
    loginEmail.value = "";
    loginPass.value = "";
    }

    function hideLogin() {
      loginOverlay.style.display = "none";
      loginErr.style.display = "none";
      loginErr.textContent = "";
      loginHint.textContent = "";
    }

    function sanitize(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    function fmtDate(iso) {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function flagClass(v) {
      if (v === "red") return "f-red";
      if (v === "yellow") return "f-yellow";
      if (v === "green") return "f-green";
      return "f-none";
    }

    function statusClass(v) {
      if (v === "working") return "s-working";
      if (v === "completed") return "s-completed";
      return "s-assigned";
    }

    function getSelectedIds() {
      return Array.from(document.querySelectorAll("input[data-id]:checked")).map(x => x.getAttribute("data-id"));
    }

    async function requireAdminSession() {
      const { data: { user } } = await sb.auth.getUser();

      if (!user) {
        whoami.textContent = "Not signed in";
        logoutBtn.style.display = "none";
        setLocked(true);
        showLogin("Sign in to load inquiries.");
        return null;
      }

      if ((user.email || "").toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
        await sb.auth.signOut();
        whoami.textContent = "Wrong account";
        logoutBtn.style.display = "none";
        setLocked(true);
        showLogin("Use your admin email to sign in.");
        return null;
      }

      whoami.textContent = "Signed in: " + user.email;
      logoutBtn.style.display = "inline-flex";
      setLocked(false);
      hideLogin();
      if (adminCard) adminCard.style.display = "block";
      return user;
    }

    // Prevent overlapping renders (this fixes the duplicates/refresh weirdness)
    let loadNonce = 0;

    async function loadInquiries() {
      const myNonce = ++loadNonce;
      clearErr();

      refreshBtn.disabled = true;
      refreshBtn.style.opacity = "0.6";

      // Require admin first
      const user = await requireAdminSession();
      if (!user) {
        refreshBtn.disabled = false;
        refreshBtn.style.opacity = "1";
        return;
      }

      // Query
      const { data, error } = await sb
        .from("inquiries")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(200);


      // If another load started after this one, ignore this result
      if (myNonce !== loadNonce) return;

      refreshBtn.disabled = false;
      refreshBtn.style.opacity = "1";

      if (error) {
        rowsEl.innerHTML = "";
        showErr("Could not load inquiries: " + error.message);
        return;
      }

      if (!data || data.length === 0) {
        rowsEl.innerHTML = `<tr><td colspan="9" class="muted" style="padding:1.2rem .6rem;">
          No inquiries returned.
        </td></tr>`;
        return;
      }


      // Build rows once (avoids duplicate append behavior)
      allInquiries = data;
      applySearchAndRender();

      

      selectAll.checked = false;
    }

    async function updateMany(patch) {
      clearErr();
      const ids = getSelectedIds();
      if (ids.length === 0) { showErr("Select at least one inquiry."); return; }

      const { error } = await sb.from("inquiries").update(patch).in("id", ids);
      if (error) { showErr(error.message); return; }

      showOk("Updated " + ids.length + " inquiry(s).");
      await loadInquiries();
    }

        async function deleteMany(ids) {
  clearErr();
  if (!ids || ids.length === 0) { showErr("Select at least one inquiry."); return; }

  const ok = confirm(`Delete ${ids.length} inquiry(s)? This cannot be undone.`);
  if (!ok) return;

  const { error, count } = await sb
    .from("inquiries")
    .delete({ count: "exact" })
    .in("id", ids);

  if (error) {
    showErr("Delete failed: " + error.message);
    return;
  }

  if (!count || count === 0) {
    showErr("Delete request returned 0 deleted rows. This usually means RLS is blocking DELETE.");
    return;
  }

  showOk(`${count} inquiry deleted.`);
  await loadInquiries();
}



    // Toolbar events

    // --- Tooltip helpers (global floating tooltip; not clipped) ---
const qlTooltip = document.getElementById("qlTooltip");

function showTooltip(html, x, y) {
  qlTooltip.innerHTML = html;
  qlTooltip.style.display = "block";

  const pad = 14;
  // Force layout so rect is accurate after innerHTML change
  const rect = qlTooltip.getBoundingClientRect();

  let left = x + 14;
  let top  = y + 14;

  if (left + rect.width + pad > window.innerWidth) left = window.innerWidth - rect.width - pad;
  if (top + rect.height + pad > window.innerHeight) top = window.innerHeight - rect.height - pad;

  qlTooltip.style.left = left + "px";
  qlTooltip.style.top  = top + "px";
}

function hideTooltip() {
  qlTooltip.style.display = "none";
  qlTooltip.innerHTML = "";
}

// --- Row-level actions + tooltip (event delegation) ---



document.addEventListener("click", async (e) => {
  const viewBtn = e.target.closest("[data-view]");
  if (viewBtn) {
    const id = viewBtn.getAttribute("data-view");
    window.location.href = `/sns-inquiry-view/index.html?id=${encodeURIComponent(id)}`;
    return;
  }

  const delBtn = e.target.closest("[data-del]");
  if (delBtn) {
    const id = delBtn.getAttribute("data-del");
    await deleteMany([id]);
    return;
  }
});

// Keep tooltip near cursor when visible
document.addEventListener("mousemove", (e) => {
  if (qlTooltip.style.display === "block") {
    showTooltip(qlTooltip.innerHTML, e.clientX, e.clientY);
  }
});

// IMPORTANT: use mouseover/mouseout (mouseenter doesn't bubble reliably for delegation)
document.addEventListener("mouseover", (e) => {
  const eyeBtn = e.target.closest("[data-eye]");
  if (!eyeBtn) return;

  const row = eyeBtn.closest("tr");
  if (!row) return;

  const tds = row.querySelectorAll("td");
  const date     = tds[1]?.textContent?.trim() || "";
  const workOrder= tds[2]?.textContent?.trim() || "";
  const priority = tds[3]?.textContent?.trim() || "";
  const status   = tds[4]?.textContent?.trim() || "";
  const contact  = tds[5]?.textContent?.trim() || "";
  const business = tds[6]?.textContent?.trim() || "";
  const services = tds[7]?.textContent?.trim() || "";

  const html = `
    <div style="letter-spacing:.14em; text-transform:uppercase; font-size:.78rem; color:#cfc8ff; margin-bottom:.5rem;">
      Quick Look
    </div>
    <div style="font-size:.92rem; line-height:1.45;">
      <div><span style="color:#bdb7ff;">Date:</span> ${sanitize(date)}</div>
      <div><span style="color:#bdb7ff;">Work Order:</span> ${sanitize(workOrder)}</div>
      <div><span style="color:#bdb7ff;">Status:</span> ${sanitize(status)}</div>
      <div><span style="color:#bdb7ff;">Priority:</span> ${sanitize(priority)}</div>
      <div style="margin-top:.45rem;"><span style="color:#bdb7ff;">Contact:</span> ${sanitize(contact)}</div>
      <div><span style="color:#bdb7ff;">Business:</span> ${sanitize(business)}</div>
      <div style="margin-top:.45rem;"><span style="color:#bdb7ff;">Services:</span> ${sanitize(services)}</div>
    </div>
  `;

  showTooltip(html, e.clientX, e.clientY);
});

// Search
searchBox.addEventListener("input", () => applySearchAndRender());




document.addEventListener("mouseout", (e) => {
  const eyeBtn = e.target.closest("[data-eye]");
  if (!eyeBtn) return;

  // If you're still inside the same eye button, ignore
  if (e.relatedTarget && eyeBtn.contains(e.relatedTarget)) return;

  hideTooltip();
});

    document.getElementById("refreshBtn").addEventListener("click", () => loadInquiries());
    document.getElementById("markWorkingBtn").addEventListener("click", () => updateMany({ status: "working" }));
    document.getElementById("markCompletedBtn").addEventListener("click", () => updateMany({ status: "completed" }));
    document.getElementById("resetAssignedBtn").addEventListener("click", () => updateMany({ status: "assigned" }));

    document.getElementById("flagRedBtn").addEventListener("click", () => updateMany({ priority_flag: "red" }));
    document.getElementById("flagYellowBtn").addEventListener("click", () => updateMany({ priority_flag: "yellow" }));
    document.getElementById("flagGreenBtn").addEventListener("click", () => updateMany({ priority_flag: "green" }));
    document.getElementById("flagNoneBtn").addEventListener("click", () => updateMany({ priority_flag: "none" }));


    document.getElementById("deleteSelectedBtn").addEventListener("click", () => deleteMany(getSelectedIds()));




    selectAll.addEventListener("change", (e) => {
      document.querySelectorAll("input[data-id]").forEach(cb => cb.checked = e.target.checked);
    });

    // Row-level delete (event delegation)

    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      showOk("Signed out.");
      await loadInquiries();
    });

    loginBtn.addEventListener("click", async () => {
      loginErr.style.display = "none";
      loginErr.textContent = "";

      try {
        const email = loginEmail.value.trim();
        const password = loginPass.value;

        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;

        await loadInquiries();
      } catch (e) {
        loginErr.style.display = "block";
        loginErr.textContent = e.message || "Login failed.";
      }
    });

    // Important: This can fire during session restore. With nonce guard above, it won‚Äôt duplicate rows.
    sb.auth.onAuthStateChange(() => { loadInquiries(); });

    loadInquiries();
  </script>

  <script>
    // Mobile menu (scoped)
    (function(){
      const menu = document.getElementById("mnavMenu");
      const scrim = document.getElementById("mnavScrim");
      const openBtn = document.getElementById("mnavOpen");
      const closeBtn = document.getElementById("mnavClose");

      function open(){
        menu.classList.add("open");
        scrim.classList.add("open");
        menu.setAttribute("aria-hidden","false");
        scrim.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function close(){
        menu.classList.remove("open");
        scrim.classList.remove("open");
        menu.setAttribute("aria-hidden","true");
        scrim.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      openBtn?.addEventListener("click", open);
      closeBtn?.addEventListener("click", close);
      scrim?.addEventListener("click", close);
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });
    })();

    // View Desktop Site preference (same behavior as other mobile pages)
    (function(){
      const a = document.getElementById("mnavViewDesktop");
      if (!a) return;
      a.addEventListener("click", function(e){
        e.preventDefault();
        localStorage.setItem("sns_force_desktop", "1");
        location.replace("/sns-admin/");
      });
    })();
  </script>

</body>
</html>
