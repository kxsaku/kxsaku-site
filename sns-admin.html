<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Admin Inquiries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Keep your existing theme style — this just adds the login overlay + small utilities */
    body { margin:0; background: radial-gradient(circle at top, #342067, #050315 55%, #020010); color:#f4f0ff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 3rem 1rem 4rem; }
    .toprow { display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; }
    h1 { margin:0; letter-spacing:.18em; text-transform:uppercase; }
    .sub { color:#bdb7ff; margin-top:.6rem; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .95rem; border-radius:999px; border:1px solid rgba(129,118,255,.35); background: rgba(9,6,34,.65); color:#d9d3ff; font-size:.85rem; }

    .card {
      margin-top: 1.75rem;
      background: rgba(9, 6, 34, 0.9);
      border: 1px solid rgba(130, 106, 255, 0.3);
      border-radius: 28px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(16px);
      padding: 1.25rem 1.25rem 1.1rem;
      overflow:hidden;
    }

    .toolbar { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; justify-content:space-between; margin-bottom: .8rem; }
    .toolbar-left, .toolbar-right { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }

    .btn {
      border-radius:999px;
      padding:.65rem 1.05rem;
      border:1px solid rgba(129,118,255,.35);
      background: rgba(15, 10, 55, 0.8);
      color:#f4f0ff;
      cursor:pointer;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.78rem;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
    }
    .btn:hover { transform: translateY(-1px); border-color:#b37cff; box-shadow:0 0 0 1px rgba(179,124,255,.35); filter:brightness(1.05); }
    .btn:active { transform: translateY(1px); }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: .85rem .6rem; border-bottom: 1px solid rgba(129,118,255,.18); color:#e9e5ff; font-size:.92rem; text-align:left; }
    th { color:#cfc8ff; font-size:.78rem; letter-spacing:.12em; text-transform:uppercase; }
    .muted { color:#bdb7ff; font-size:.85rem; }
    .status { font-weight:700; font-size:.8rem; letter-spacing:.08em; text-transform:uppercase; }
    .s-assigned { color:#bdb7ff; }
    .s-working { color:#7bb8ff; }
    .s-completed { color:#7af9c4; }

    .flag { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; box-shadow: 0 0 0 2px rgba(255,255,255,.06); vertical-align: middle; }
    .f-red { background:#ff6262; }
    .f-yellow { background:#ffd45a; }
    .f-green { background:#6cffb0; }
    .f-none { background: rgba(255,255,255,.18); }

    .err { margin-top:.8rem; color:#ff9494; font-size:.9rem; display:none; }
    .ok { margin-top:.8rem; color:#7af9c4; font-size:.9rem; display:none; }

    /* Login overlay */
    .overlay {
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center;
      padding: 1rem;
      z-index: 9999;
    }
    .login-card {
      width: min(520px, 100%);
      background: rgba(9, 6, 34, 0.95);
      border: 1px solid rgba(130, 106, 255, 0.35);
      border-radius: 28px;
      box-shadow: 0 25px 90px rgba(0, 0, 0, 0.75);
      padding: 1.75rem 1.5rem 1.4rem;
    }
    .login-title { margin:0; letter-spacing:.16em; text-transform:uppercase; font-size:1.05rem; }
    .login-sub { margin:.6rem 0 1.1rem; color:#bdb7ff; line-height:1.45; font-size:.9rem; }
    .field label { display:block; margin:.7rem 0 .35rem; font-size:.78rem; color:#d5cffc; letter-spacing:.1em; text-transform:uppercase; }
    .field input {
      width:100%;
      border-radius: 999px;
      border: 1px solid rgba(129,118,255,.35);
      background: rgba(9,6,34,.95);
      color:#f4f0ff;
      padding:.75rem 1rem;
      outline:none;
    }
    .field input:focus { border-color:#9c88ff; box-shadow:0 0 0 1px rgba(156,136,255,.55); }
    .login-actions { display:flex; gap:.7rem; justify-content:space-between; align-items:center; margin-top: 1.1rem; flex-wrap:wrap; }
    .tiny { font-size:.8rem; color:#9ea0d7; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toprow">
      <div>
        <h1>SNS INQUIRIES</h1>
        <div class="sub">Internal dashboard · newest inquiries first</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:.6rem; align-items:flex-end;">
        <span class="pill" id="whoami">Not signed in</span>
        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <button class="btn" id="markWorkingBtn">Mark as Working</button>
          <button class="btn" id="markCompletedBtn">Mark as Completed</button>
          <button class="btn" id="resetAssignedBtn">Reset to Assigned</button>
        </div>
        <div class="toolbar-right">
          <button class="btn" id="flagRedBtn">Flag Red</button>
          <button class="btn" id="flagYellowBtn">Flag Yellow</button>
          <button class="btn" id="flagGreenBtn">Flag Green</button>
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:42px;"><input type="checkbox" id="selectAll"></th>
              <th>Date</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Contact</th>
              <th>Business</th>
              <th>Services</th>
              <th style="width:120px;">Quick</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:.8rem;">
        © 2025 kxsaku · Built from the homelab.
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="overlay" id="loginOverlay" style="display:none;">
    <div class="login-card">
      <h2 class="login-title">Admin login</h2>
      <p class="login-sub">
        Sign in to view and manage inquiries. This page can load publicly, but data is protected by Supabase policies.
      </p>

      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" placeholder="brandon.sns@pm.me">
      </div>

      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••">
      </div>

      <div class="login-actions">
        <span class="tiny" id="loginHint"></span>
        <button class="btn" id="loginBtn">Sign in</button>
      </div>

      <div class="err" id="loginErr" style="display:none;"></div>
    </div>
  </div>

  <!-- Supabase JS (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /**************************************************************
     * REQUIRED: Paste your Supabase details below
     **************************************************************/
    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";

    // Your admin email that is allowed by RLS
    const ADMIN_EMAIL = "brandon.sns@pm.me";

    /**************************************************************/
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const rowsEl = document.getElementById("rows");
    const errBox = document.getElementById("errBox");
    const okBox = document.getElementById("okBox");
    const whoami = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");

    const loginOverlay = document.getElementById("loginOverlay");
    const loginBtn = document.getElementById("loginBtn");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const loginErr = document.getElementById("loginErr");
    const loginHint = document.getElementById("loginHint");

    const selectAll = document.getElementById("selectAll");

    function showErr(msg) { errBox.style.display = "block"; errBox.textContent = msg; }
    function clearErr() { errBox.style.display = "none"; errBox.textContent = ""; }
    function showOk(msg) { okBox.style.display = "block"; okBox.textContent = msg; setTimeout(() => okBox.style.display="none", 2000); }

    function showLogin(msg) {
      loginOverlay.style.display = "flex";
      loginErr.style.display = "none";
      loginErr.textContent = "";
      loginHint.textContent = msg || "";
      loginEmail.value = ADMIN_EMAIL;
    }

    function hideLogin() {
      loginOverlay.style.display = "none";
      loginErr.style.display = "none";
      loginErr.textContent = "";
      loginHint.textContent = "";
    }

    function sanitize(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    function fmtDate(iso) {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function flagClass(v) {
      if (v === "red") return "f-red";
      if (v === "yellow") return "f-yellow";
      if (v === "green") return "f-green";
      return "f-none";
    }

    function statusClass(v) {
      if (v === "working") return "s-working";
      if (v === "completed") return "s-completed";
      return "s-assigned";
    }

    function getSelectedIds() {
      return Array.from(document.querySelectorAll("input[data-id]:checked")).map(x => x.getAttribute("data-id"));
    }

    async function requireAdminSession() {
      const { data: { user } } = await sb.auth.getUser();

      if (!user) {
        whoami.textContent = "Not signed in";
        logoutBtn.style.display = "none";
        showLogin("Sign in to load inquiries.");
        return null;
      }

      // Extra client-side check (RLS is the real protection)
      if ((user.email || "").toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
        await sb.auth.signOut();
        whoami.textContent = "Wrong account";
        logoutBtn.style.display = "none";
        showLogin("Use your admin email to sign in.");
        return null;
      }

      whoami.textContent = "Signed in: " + user.email;
      logoutBtn.style.display = "inline-flex";
      hideLogin();
      return user;
    }

    async function loadInquiries() {
      clearErr();
      rowsEl.innerHTML = "";

      const user = await requireAdminSession();
      if (!user) return;

      // IMPORTANT: if RLS blocks, you'll get an error here and we show it
      const { data, error } = await sb
        .from("inquiries")
        .select("id, created_at, priority_flag, status, contact_name, business_name, services")
        .order("created_at", { ascending: false })
        .limit(200);

      if (error) {
        showErr("Could not load inquiries: " + error.message);
        return;
      }

      if (!data || data.length === 0) {
        rowsEl.innerHTML = `<tr><td colspan="8" class="muted" style="padding:1.2rem .6rem;">
          No inquiries returned. If you KNOW one exists, this is almost always an auth/RLS issue.
        </td></tr>`;
        return;
      }

      for (const r of data) {
        const services = Array.isArray(r.services) ? r.services.join(", ") : (r.services || "");
        rowsEl.insertAdjacentHTML("beforeend", `
          <tr>
            <td><input type="checkbox" data-id="${sanitize(r.id)}"></td>
            <td>${sanitize(fmtDate(r.created_at))}</td>
            <td><span class="flag ${flagClass(r.priority_flag)}"></span>${sanitize(r.priority_flag || "none")}</td>
            <td class="status ${statusClass(r.status)}">${sanitize(r.status || "assigned")}</td>
            <td>${sanitize(r.contact_name || "")}</td>
            <td>${sanitize(r.business_name || "")}</td>
            <td>${sanitize(services)}</td>
            <td><button class="btn" data-quick="${sanitize(r.id)}">Quick look</button></td>
          </tr>
        `);
      }
    }

    async function updateMany(patch) {
      clearErr();
      const ids = getSelectedIds();
      if (ids.length === 0) { showErr("Select at least one inquiry."); return; }

      const { error } = await sb.from("inquiries").update(patch).in("id", ids);
      if (error) { showErr(error.message); return; }

      showOk("Updated " + ids.length + " inquiry(s).");
      await loadInquiries();
    }

    // Events
    document.getElementById("refreshBtn").addEventListener("click", loadInquiries);
    document.getElementById("markWorkingBtn").addEventListener("click", () => updateMany({ status: "working" }));
    document.getElementById("markCompletedBtn").addEventListener("click", () => updateMany({ status: "completed" }));
    document.getElementById("resetAssignedBtn").addEventListener("click", () => updateMany({ status: "assigned" }));

    document.getElementById("flagRedBtn").addEventListener("click", () => updateMany({ priority_flag: "red" }));
    document.getElementById("flagYellowBtn").addEventListener("click", () => updateMany({ priority_flag: "yellow" }));
    document.getElementById("flagGreenBtn").addEventListener("click", () => updateMany({ priority_flag: "green" }));

    selectAll.addEventListener("change", (e) => {
      document.querySelectorAll("input[data-id]").forEach(cb => cb.checked = e.target.checked);
    });

    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      showOk("Signed out.");
      await loadInquiries();
    });

    loginBtn.addEventListener("click", async () => {
      loginErr.style.display = "none";
      loginErr.textContent = "";

      try {
        const email = loginEmail.value.trim();
        const password = loginPass.value;

        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;

        await loadInquiries();
      } catch (e) {
        loginErr.style.display = "block";
        loginErr.textContent = e.message || "Login failed.";
      }
    });

    // If session changes (refresh, etc.), reload
    sb.auth.onAuthStateChange((_event, _session) => { loadInquiries(); });

    // Initial load
    loadInquiries();
  </script>
</body>
</html>
