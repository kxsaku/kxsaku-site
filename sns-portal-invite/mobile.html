<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Create Account (Mobile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/styles.css" rel="stylesheet"/>
  <style>

    :root{
      --bg0:#03010b;
      --bg1:#060214;
      --ink:#f4f0ff;
      --muted: rgba(244,240,255,.72);
      --muted2: rgba(244,240,255,.56);

      --stroke: rgba(196, 181, 253, .18);
      --stroke2: rgba(196, 181, 253, .28);

      --glass: rgba(10, 6, 28, .42);
      --glass2: rgba(12, 8, 34, .62);

      --accent:#b37cff;
      --accent2:#f973e2;
      --accent3:#5eead4;

      --r-xl: 26px;
      --r-lg: 18px;
      --r-sm: 14px;

      --shadow: 0 25px 90px rgba(0,0,0,.60);
      --shadow2: 0 18px 50px rgba(0,0,0,.38);

      --max: 640px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 25% 20%, rgba(179,124,255,.18), transparent 60%),
                  radial-gradient(900px 650px at 85% 10%, rgba(94,234,212,.10), transparent 55%),
                  radial-gradient(1100px 900px at 70% 80%, rgba(249,115,226,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* Full-bleed animated background */
    .bg{
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events:none;
      overflow:hidden;
    }
    .bg .glow{
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 20% 25%, rgba(179,124,255,.22), transparent 55%),
        radial-gradient(circle at 85% 15%, rgba(94,234,212,.12), transparent 55%),
        radial-gradient(circle at 60% 80%, rgba(249,115,226,.14), transparent 55%);
      filter: blur(10px);
      animation: glowFloat 16s ease-in-out infinite alternate;
      opacity:.9;
    }
    @keyframes glowFloat{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(-18px, 12px, 0) scale(1.03); }
    }
    .bg .lines{
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.045) 0px,
          rgba(255,255,255,.045) 1px,
          transparent 1px,
          transparent 90px
        );
      opacity:.18;
      -webkit-mask-image: linear-gradient(to bottom, #000 0%, #000 45%, transparent 100%);
      mask-image: linear-gradient(to bottom, #000 0%, #000 45%, transparent 100%);
      animation: lineDrift 22s linear infinite;
    }
    @keyframes lineDrift{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(-140px, 140px, 0); }
    }
    .bg .dots{
      position:absolute;
      inset:0;
      background-image:
        radial-gradient(rgba(255,255,255,.20) 1px, transparent 1px),
        radial-gradient(rgba(255,255,255,.10) 1px, transparent 1px);
      background-size: 140px 140px, 220px 220px;
      background-position: 0 0, 40px 80px;
      opacity:.20;
      -webkit-mask-image: linear-gradient(to bottom, #000 0%, #000 50%, transparent 100%);
      mask-image: linear-gradient(to bottom, #000 0%, #000 50%, transparent 100%);
      animation: dotFloat 28s ease-in-out infinite alternate;
    }
    @keyframes dotFloat{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(18px, -10px, 0); }
    }
    .bg .vignette{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 0%, rgba(0,0,0,.08), rgba(0,0,0,.64) 62%, rgba(0,0,0,.78));
      z-index: 1;
    }

    /* Layout */
    .wrap{
      width: min(var(--max), calc(100% - 1.25rem));
      margin: 0 auto;
    }

    /* Mobile sticky header */
    .topnav{
      position: sticky;
      top: 0;
      z-index: 60;
      padding: .9rem 0;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(3,1,11,.78), rgba(3,1,11,.22));
      border-bottom: 1px solid rgba(196,181,253,.10);
    }
    .navrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:.7rem;
      min-width: 0;
    }
    .mark{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      flex: 0 0 auto;
    }
    .mark img{
      width:100%;
      height:100%;
      object-fit: contain;
      border-radius: 12px;
    }
    .brandText{
      min-width: 0;
    }
    .brand strong{
      display:block;
      font-size:.88rem;
      letter-spacing:.14em;
      text-transform: uppercase;
      line-height:1.05;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }
    .brand span{
      display:block;
      color: var(--muted2);
      font-size:.82rem;
      line-height:1.1;
      margin-top:.18rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }

    /* Buttons (same feel) */
    .btn{
      position: relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 42px;
      padding: 0 16px;
      border-radius: 999px;
      border: 1px solid rgba(196,181,253,.18);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      text-decoration:none;
      font-weight: 800;
      font-size: .78rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      box-shadow: 0 12px 40px rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      transition: transform .14s ease, border-color .14s ease, filter .14s ease, background .14s ease;
      will-change: transform;
      overflow:hidden;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .btn::after{
      content:"";
      position:absolute;
      inset:-40% -60%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: translateX(-60%) rotate(10deg);
      opacity: 0;
      transition: transform .55s ease, opacity .18s ease;
    }
    .btn:active{
      transform: translateY(0);
      filter: brightness(1.03);
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(179,124,255,.92), rgba(249,115,226,.72));
      border-color: rgba(255,255,255,.18);
    }

    /* Icon button (hamburger) */
    .iconBtn{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(196,181,253,.18);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,.28);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .14s ease, border-color .14s ease, filter .14s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{ transform: translateY(0); filter: brightness(1.04); }
    .iconBtn svg{ opacity:.92; }

    /* Slide-down menu */
    .menu{
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      z-index: 80;
      transform: translateY(-110%);
      transition: transform .24s cubic-bezier(.2,.9,.2,1);
      padding: 0.95rem 0 .9rem;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(3,1,11,.92), rgba(3,1,11,.58));
      border-bottom: 1px solid rgba(196,181,253,.14);
    }
    .menu.open{ transform: translateY(0); }

    .menuHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid rgba(196,181,253,.10);
    }

    .menuLinks{
      display:grid;
      gap: .55rem;
      padding-top: .85rem;
    }
    .menuLinks a{
      text-decoration:none;
      color: var(--muted);
      font-size: .80rem;
      letter-spacing:.14em;
      text-transform: uppercase;
      padding: .8rem .95rem;
      border-radius: 16px;
      border: 1px solid rgba(196,181,253,.10);
      background: rgba(196,181,253,.04);
      transition: transform .14s ease, border-color .14s ease, filter .14s ease, background .14s ease, color .14s ease;
    }
    .menuLinks a:active{
      transform: translateY(0);
      border-color: rgba(196,181,253,.22);
      filter: brightness(1.04);
      color: var(--ink);
    }
    .menuLinks a.active{
      background: rgba(179,124,255,.16);
      border-color: rgba(179,124,255,.26);
      color: var(--ink);
    }

    .menuActions{
      margin-top: .85rem;
      display:grid;
      gap:.65rem;
    }
    .menuActions .btn{ width: 100%; }

    .scrim{
      position: fixed;
      inset: 0;
      z-index: 70;
      background: rgba(0,0,0,.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .scrim.open{
      opacity: 1;
      pointer-events: auto;
    }

    /* Hero + particles */
    .hero{ position: relative; overflow: hidden; padding: 3.7rem 0 2.5rem; text-align:center; }
    .hero .wrap{ position: relative; z-index: 2; }

    #particles{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
      opacity: .45;
      mix-blend-mode: screen;
    }

    .hero-mark{
      width: 56px;
      height: 56px;
      margin: 0 auto 1.05rem;
      border-radius: 18px;
      display: grid;
      place-items: center;
      position: relative;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
    }
    .hero-mark img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 14px;
    }
    .hero-mark::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 22px;
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.22), transparent 60%);
      filter: blur(8px);
      opacity: .38;
    }

    .eyebrow{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.35rem .75rem;
      border-radius: 999px;
      border: 1px solid rgba(196,181,253,.18);
      background: rgba(196,181,253,.06);
      color: var(--muted);
      font-size:.72rem;
      letter-spacing:.14em;
      text-transform: uppercase;
    }

    h1{
      margin: 1.05rem auto .85rem;
      max-width: 22ch;
      font-size: clamp(1.85rem, 6.2vw, 2.55rem);
      line-height: 1.08;
      letter-spacing: .01em;
    }
    .hero h1{
      background: linear-gradient(180deg,
        rgba(179,124,255,.60),
        rgba(244,240,255,.42) 60%,
        rgba(249,115,226,.32)
      );
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .lede{
      margin: 0 auto;
      max-width: 56ch;
      color: var(--muted);
      font-size: 1.00rem;
      line-height: 1.72;
    }

    .cta{
      margin-top: 1.25rem;
      display:grid;
      gap:.65rem;
    }
    .cta .btn{ width:100%; height: 46px; }

    /* Mobile “service modules” chips */
    .chips{
      margin-top: 1.25rem;
      display:flex;
      flex-wrap: wrap;
      gap: .55rem;
      justify-content:center;
    }
    .chip{
      padding: .55rem .75rem;
      border-radius: 999px;
      border: 1px solid rgba(196,181,253,.14);
      background: rgba(196,181,253,.06);
      color: var(--muted);
      font-size: .74rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      text-decoration:none;
      transition: transform .14s ease, border-color .14s ease, filter .14s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:active{
      transform: translateY(0);
      border-color: rgba(196,181,253,.26);
      filter: brightness(1.05);
      color: var(--ink);
    }

    /* Cards + panels (stacked) */
    .section{ padding: 2.2rem 0; }
    .card{
      border-radius: var(--r-xl);
      border: 1px solid rgba(196,181,253,.16);
      background: linear-gradient(180deg, rgba(10,6,28,.52), rgba(10,6,28,.30));
      box-shadow: var(--shadow2);
      padding: 1.15rem 1.05rem;
      text-align:left;
      transition: transform .16s ease, border-color .16s ease, filter .16s ease;
      will-change: transform;
    }
    .card:active{
      transform: translateY(0);
      border-color: rgba(196,181,253,.26);
      filter: brightness(1.03);
    }
    .card h3{
      margin:0;
      font-size: .90rem;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .card p{
      margin: .55rem 0 0;
      color: var(--muted);
      line-height: 1.65;
      font-size: .98rem;
    }

    .stack{
      display:grid;
      gap: .85rem;
    }

    .panel{
      border-radius: var(--r-xl);
      border: 1px solid rgba(196,181,253,.14);
      background: linear-gradient(180deg, rgba(10,6,28,.44), rgba(10,6,28,.24));
      box-shadow: var(--shadow2);
      padding: 1.2rem 1.1rem;
      text-align:left;
    }
    .panel h2{
      margin:0;
      font-size: 1.02rem;
      letter-spacing:.12em;
      text-transform: uppercase;
    }
    .panel p{
      margin:.7rem 0 0;
      color: var(--muted);
      line-height:1.7;
    }

    /* Footer */
    footer{
      padding: 2.6rem 0 2.2rem;
      border-top: 1px solid rgba(196,181,253,.10);
      color: var(--muted2);
      text-align:center;
    }
    footer a{
      color: var(--muted);
      text-decoration:none;
      border-bottom: 1px solid rgba(196,181,253,.22);
    }
    footer a:active{
      color: var(--ink);
      border-bottom-color: rgba(196,181,253,.38);
    }

    /* reveal */
    .reveal{
      opacity:0;
      transform: translateY(16px);
      transition: opacity .60s ease, transform .60s cubic-bezier(.2,.9,.2,1);
    }
    .reveal.in{ opacity:1; transform: translateY(0); }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .bg .glow, .bg .lines, .bg .dots{ animation:none; }
      .reveal{ opacity:1; transform:none; transition:none; }
      #particles{ display:none; }
      .menu, .scrim{ transition:none; }
    }
  
  </style>

  <style>

    body{ margin:0; background: radial-gradient(circle at top, #342067, #050315 55%, #020010); color:#f4f0ff; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .pageWrap{ max-width: 860px; margin: 0 auto; padding: 3rem 1rem 4rem; }
    .card{ background: rgba(7,4,25,.78); border: 1px solid rgba(129,118,255,.25); border-radius: 18px; padding: 18px; box-shadow: 0 18px 60px rgba(0,0,0,.5); backdrop-filter: blur(14px); }
    h1{ margin:0 0 .25rem; letter-spacing:.14em; text-transform:uppercase; font-size:1.1rem; }
    p{ margin:.4rem 0 1rem; color: rgba(244,240,255,.82); line-height:1.45; }
    label{ display:block; margin:.9rem 0 .35rem; font-size:.9rem; color: rgba(244,240,255,.9); }
    input, textarea, select{
      width:100%; padding: 12px 12px; border-radius: 12px;
      border:1px solid rgba(129,118,255,.25);
      background: rgba(10,6,35,.65);
      color:#f4f0ff; outline:none;
    }
    input:focus, textarea:focus, select:focus{ border-color: rgba(129,118,255,.55); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap: 14px; }
    @media (max-width: 720px){ .row{ grid-template-columns:1fr; } }
    .btn{
      margin-top: 14px;
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(129,118,255,.35);
      background: rgba(129,118,255,.18);
      color:#f4f0ff;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .msg{ margin-top: 12px; padding: 12px 14px; border-radius: 14px; border:1px solid rgba(255,255,255,.12); display:none; }
    .msg.err{ background: rgba(255,55,120,.10); border-color: rgba(255,55,120,.35); }
    .msg.ok{ background: rgba(80,255,180,.08); border-color: rgba(80,255,180,.28); }
    .meterWrap{ margin-top: 8px; }
    .meterBar{ height: 10px; border-radius: 999px; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.10); overflow:hidden; }
    .meterFill{ height:100%; width:0%; transition: width .2s ease; }
    .hint{ font-size:.85rem; color: rgba(244,240,255,.72); margin-top: 6px; }
  

    /* ===== Mobile fitting tweaks for Invite/Create Account ===== */
    .pageWrap{ max-width: 640px; padding: 2.0rem 1.0rem 3.0rem; }
    .card{ padding: 1.05rem 1.0rem; border-radius: 22px; }
    label{ font-size: .86rem; }
    input, textarea, select{ font-size: 16px; } /* prevent iOS zoom */
    .row{ display:grid !important; grid-template-columns: 1fr !important; gap: .75rem !important; }
    .btn{ width: 100%; }
    .toprow{ flex-direction: column; align-items: flex-start; gap: .9rem; }
    .topActions{ width: 100%; display:grid; grid-template-columns: 1fr; gap: .65rem; }

  </style>
</head>
<body>
<div class="bg">
<div class="glow"></div>
<div class="lines"></div>
<div class="dots"></div>
<div class="vignette"></div>
</div>
<div aria-hidden="true" class="scrim" id="scrim"></div>
<aside aria-hidden="true" aria-label="Mobile Menu" class="menu" id="menu">
<div class="wrap">
<div class="menuHeader">
<div class="brand" style="gap:.65rem;">
<div class="mark" style="width:40px;height:40px;border-radius:14px;">
<img alt="Saku Network Solutions logo" src="/assets/sns-logo-purple.png"/>
</div>
<div class="brandText">
<strong>SAKU NETWORK SOLUTIONS</strong>
<span>Network infrastructure, done clean.</span>
</div>
</div>
<button aria-label="Close menu" class="iconBtn" id="closeMenu">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M6 6l12 12M18 6L6 18" stroke="rgba(244,240,255,.92)" stroke-linecap="round" stroke-width="2"></path>
</svg>
</button>
</div>
<nav aria-label="Primary" class="menuLinks">
<a href="/home/">Home</a>
<a href="/sns/">Services</a>
<a href="/experience/">Credibility</a>
<a href="/other/">Resources</a>
<a href="/socials/">Contact</a>
</nav>
<div class="menuActions">
<a class="btn" href="/sns-login/">Client Login</a>
<!-- Desktop preference -->
<a class="btn" href="#" id="viewDesktop">View Desktop Site</a>
</div>
</div>
</aside>
<header class="topnav">
<div class="wrap">
<div class="navrow">
<div class="brand">
<div class="mark">
<img alt="Saku Network Solutions logo" src="/assets/sns-logo-purple.png"/>
</div>
<div class="brandText">
<strong>SAKU NETWORK SOLUTIONS</strong>
<span>Network infrastructure, done clean.</span>
</div>
</div>
<button aria-label="Open menu" class="iconBtn" id="openMenu">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(244,240,255,.92)" stroke-linecap="round" stroke-width="2"></path>
</svg>
</button>
</div>
</div>
</header>
<div class="pageWrap">
<div class="card">
<h1>Create Your SNS Account</h1>
<p>Set your password and confirm your business details. This account is invite-only.</p>
<div class="msg" id="msg"></div>
<form id="form">
<label>Email</label>
<input disabled="" id="email" type="email"/>
<div class="row">
<div>
<label>Password</label>
<input autocomplete="new-password" id="pw" placeholder="Create a password" type="password"/>
<div class="meterWrap">
<div class="meterBar"><div class="meterFill" id="meterFill"></div></div>
<div class="hint" id="meterText">Must be 7–30 chars and include: 1 uppercase, 1 number, 1 special.</div>
</div>
</div>
<div>
<label>Confirm Password</label>
<input autocomplete="new-password" id="pw2" placeholder="Re-type password" type="password"/>
</div>
</div>
<hr style="border:none;border-top:1px solid rgba(255,255,255,.10); margin: 18px 0;"/>
<div class="row">
<div>
<label>Contact Name</label>
<input id="contact_name"/>
</div>
<div>
<label>Business Name</label>
<input id="business_name"/>
</div>
</div>
<div class="row">
<div>
<label>Phone</label>
<input id="phone" placeholder="+1..."/>
</div>
<div>
<label>Business Location</label>
<input id="business_location" placeholder="City, State (or full address if you want)"/>
</div>
</div>
<label>Mailing Address</label>
<input id="mailing_address" placeholder="Street, City, State, ZIP"/>
<div style="margin-top:10px;">
<label style="display:flex; gap:10px; align-items:center; margin:0;">
<input checked="" id="billing_same" style="width:auto;" type="checkbox"/>
            Billing Address is the same as Mailing Address
          </label>
</div>
<div id="billingWrap" style="display:none;">
<label>Billing Address</label>
<input id="billing_address" placeholder="Street, City, State, ZIP"/>
</div>
<button class="btn" id="submitBtn" type="submit">Create Account</button>
</form>
</div>
</div><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script>

      async function bootstrapSessionFromUrl() {
    // 1) If we already have a session in storage, use it.
    const { data: s0, error: e0 } = await sb.auth.getSession();
    if (e0) console.warn("getSession error:", e0);
    if (s0?.session) return s0.session;

    const url = new URL(window.location.href);

    // 2) PKCE/code flow: ?code=...
    const code = url.searchParams.get("code");
    if (code) {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      if (error) throw error;

      // Clean the URL (removes code from address bar)
      url.searchParams.delete("code");
      url.searchParams.delete("type");
      url.searchParams.delete("token");
      window.history.replaceState({}, document.title, url.pathname + (url.searchParams.toString() ? `?${url.searchParams}` : ""));

      return data.session;
    }

    // 3) Implicit/token flow: #access_token=...&refresh_token=...
    // Note: some browsers/email clients move hash tokens into query params.
    const hash = new URLSearchParams(window.location.hash.slice(1));
    const qs = new URLSearchParams(window.location.search);

    const access_token = hash.get("access_token") || qs.get("access_token");
    const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");


    if (access_token && refresh_token) {
      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      if (error) throw error;

      // Clean hash so refreshes don't re-run weirdly
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
      return data.session;
    }

    return null;
  }

  function showMsg(text, type = "error") {
    // your existing UI message function
    const el = document.getElementById("msg");
    if (!el) return alert(text);
    el.textContent = text;
    el.style.display = "block";
    el.dataset.type = type;
  }

  function getEmailFromUrl() {
    // Optional: if you pass email in query/hash; otherwise ignore
    const url = new URL(window.location.href);
    return url.searchParams.get("email") || "";
  }

  async function initInvitePage() {
    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Prefill email field from the *actual* authed user
      const emailInput = document.getElementById("email");
      if (emailInput) {
        emailInput.value = session.user.email ?? "";
        emailInput.readOnly = true;
      }

      // Clear any old error message if we’re good
      showMsg("", "ok");
      const msg = document.getElementById("msg");
      if (msg) msg.style.display = "none";
    } catch (err) {
      console.error(err);
      showMsg("Invite link is invalid or expired. Please request a new invite.", "error");
    }
  }

  document.addEventListener("DOMContentLoaded", initInvitePage);

  // IMPORTANT: your submit handler must NOT call getUser() before initInvitePage runs.
  document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Now safe to do:
      // 1) sb.auth.updateUser({ password })
      // 2) insert/update your profile/business fields in DB using session.user.id
      // ...your existing logic...
    } catch (err) {
      console.error(err);
      showMsg(err?.message || "Failed to create account.", "error");
    }
  });

    (async () => {
        const msg = document.getElementById("msg");
        const emailEl = document.getElementById("email");
        const pwEl = document.getElementById("pw");
        const pw2El = document.getElementById("pw2");
        const submitBtn = document.getElementById("submitBtn");

        const meterFill = document.getElementById("meterFill");
        const meterText = document.getElementById("meterText");

        const billingSame = document.getElementById("billing_same");
        const billingWrap = document.getElementById("billingWrap");
        const billingAddr = document.getElementById("billing_address");

        function showMsg(text, ok = false) {
        msg.style.display = "block";
        msg.className = "msg " + (ok ? "ok" : "err");
        msg.textContent = text;
        }
        function clearMsg() {
        msg.style.display = "none";
        msg.textContent = "";
        }

        billingSame.addEventListener("change", () => {
        billingWrap.style.display = billingSame.checked ? "none" : "block";
        });

        // Supports hash (#access_token=...) AND query (?access_token=...)
        function parseTokens() {
        const hash = new URLSearchParams((location.hash || "").replace(/^#/, ""));
        const qs = new URLSearchParams(location.search || "");

        const access_token = hash.get("access_token") || qs.get("access_token");
        const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");

        return { access_token, refresh_token };
        }

        function pwPolicy(pw) {
        const lenOk = pw.length >= 7 && pw.length <= 30;
        const upperOk = /[A-Z]/.test(pw);
        const numOk = /[0-9]/.test(pw);
        const specialOk = /[!@#$%^&*()]/.test(pw);
        const allowedOk = /^[A-Za-z0-9!@#$%^&*()]+$/.test(pw);
        return { lenOk, upperOk, numOk, specialOk, allowedOk };
        }

        function updateMeter() {
        const pw = pwEl.value || "";
        const p = pwPolicy(pw);

        let score = 0;
        if (p.lenOk) score++;
        if (p.upperOk) score++;
        if (p.numOk) score++;
        if (p.specialOk) score++;
        if (p.allowedOk) score++;

        const percent = Math.min(100, (score / 5) * 100);
        meterFill.style.width = percent + "%";

        let color = "rgba(255,60,120,75)";
        let label = "Weak";
        if (score >= 4) { color = "rgba(80,255,180,70)"; label = "Strong"; }
        else if (score >= 3) { color = "rgba(255,210,90,70)"; label = "Fine"; }

        meterFill.style.background = color;
        meterText.textContent = `${label} — Must be 7–30 chars; include 1 uppercase, 1 number, 1 special (!@#$%^&*()).`;
        }

        pwEl.addEventListener("input", updateMeter);

        async function requireInviteSession() {
        const { access_token, refresh_token } = parseTokens();

        if (!access_token || !refresh_token) {
            showMsg("Auth session missing. Please open the invite email link again (tokens not found).");
            submitBtn.disabled = true;
            return null;
        }

        const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) {
            showMsg("Invite session failed. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        history.replaceState({}, document.title, location.pathname);


        const user = data?.user;
        if (!user?.email) {
            showMsg("No user email found. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        emailEl.value = user.email;
        return user;
        }

        async function autofillFromInquiry(email) {
        const { data, error } = await sb
            .from("inquiries")
            .select("contact_name,business_name,phone")
            .eq("email", email)
            .order("created_at", { ascending: false })
            .limit(1);

        if (!error && data && data[0]) {
            const row = data[0];
            document.getElementById("contact_name").value = row.contact_name || "";
            document.getElementById("business_name").value = row.business_name || "";
            document.getElementById("phone").value = row.phone || "";
        }
        }

        const inviteUser = await requireInviteSession();
        if (inviteUser) await autofillFromInquiry(inviteUser.email);

        document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearMsg();

        const pw = pwEl.value || "";
        const pw2 = pw2El.value || "";
        const p = pwPolicy(pw);

        if (pw !== pw2) return showMsg("Passwords do not match.");
        if (!p.allowedOk) return showMsg("Password has invalid characters. Use only letters, numbers, and !@#$%^&*().");
        if (!(p.lenOk && p.upperOk && p.numOk && p.specialOk)) return showMsg("Password does not meet requirements.");

        const contact_name = document.getElementById("contact_name").value.trim();
        const business_name = document.getElementById("business_name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const business_location = document.getElementById("business_location").value.trim();
        const mailing_address = document.getElementById("mailing_address").value.trim();
        const billing_address = billingSame.checked ? mailing_address : (billingAddr.value || "").trim();

        if (!contact_name || !business_name || !business_location || !mailing_address || !billing_address) {
            return showMsg("Please fill in all required fields (business + addresses).");
        }

        submitBtn.disabled = true;

        try {
            // Ensure session exists
            const { data: s, error: sErr } = await sb.auth.getSession();
            if (sErr) throw sErr;

            const session = s?.session;
            if (!session?.user) throw new Error("Auth session missing. Please use invite link again.");

            const user = session.user;


            // 1) Set password
            const { error: pwErr } = await sb.auth.updateUser({ password: pw });
            if (pwErr) throw pwErr;

            // 2) Save profile
            const { error: profErr } = await sb
            .from("client_profiles")
            .upsert({
                user_id: user.id,
                email: user.email,
                contact_name,
                business_name,
                phone,
                business_location,
                mailing_address,
                billing_address
            }, { onConflict: "user_id" });

            if (profErr) throw profErr;

            showMsg("Account created. Redirecting to dashboard…", true);
            setTimeout(() => { window.location.href = "/sns-dashboard/index.html"; }, 900);
        } catch (err) {
            console.error(err);
            showMsg(err?.message || "Failed to create account.");
            submitBtn.disabled = false;
        }
        });
    })();
    </script>


  <script>

  const { createClient } = supabase;

  const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function bootstrapSessionFromUrl() {
    // 1) If we already have a session in storage, use it.
    const { data: s0, error: e0 } = await sb.auth.getSession();
    if (e0) console.warn("getSession error:", e0);
    if (s0?.session) return s0.session;

    const url = new URL(window.location.href);

    // 2) PKCE/code flow: ?code=...
    const code = url.searchParams.get("code");
    if (code) {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      if (error) throw error;

      // Clean the URL (removes code from address bar)
      url.searchParams.delete("code");
      url.searchParams.delete("type");
      url.searchParams.delete("token");
      window.history.replaceState({}, document.title, url.pathname + (url.searchParams.toString() ? `?${url.searchParams}` : ""));

      return data.session;
    }

    // 3) Implicit/token flow: #access_token=...&refresh_token=...
    // Note: some browsers/email clients move hash tokens into query params.
    const hash = new URLSearchParams(window.location.hash.slice(1));
    const qs = new URLSearchParams(window.location.search);

    const access_token = hash.get("access_token") || qs.get("access_token");
    const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");


    if (access_token && refresh_token) {
      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      if (error) throw error;

      // Clean hash so refreshes don't re-run weirdly
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
      return data.session;
    }

    return null;
  }

  function showMsg(text, type = "error") {
    // your existing UI message function
    const el = document.getElementById("msg");
    if (!el) return alert(text);
    el.textContent = text;
    el.style.display = "block";
    el.dataset.type = type;
  }

  function getEmailFromUrl() {
    // Optional: if you pass email in query/hash; otherwise ignore
    const url = new URL(window.location.href);
    return url.searchParams.get("email") || "";
  }

  async function initInvitePage() {
    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Prefill email field from the *actual* authed user
      const emailInput = document.getElementById("email");
      if (emailInput) {
        emailInput.value = session.user.email ?? "";
        emailInput.readOnly = true;
      }

      // Clear any old error message if we’re good
      showMsg("", "ok");
      const msg = document.getElementById("msg");
      if (msg) msg.style.display = "none";
    } catch (err) {
      console.error(err);
      showMsg("Invite link is invalid or expired. Please request a new invite.", "error");
    }
  }

  document.addEventListener("DOMContentLoaded", initInvitePage);

  // IMPORTANT: your submit handler must NOT call getUser() before initInvitePage runs.
  document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Now safe to do:
      // 1) sb.auth.updateUser({ password })
      // 2) insert/update your profile/business fields in DB using session.user.id
      // ...your existing logic...
    } catch (err) {
      console.error(err);
      showMsg(err?.message || "Failed to create account.", "error");
    }
  });

    (async () => {
        const msg = document.getElementById("msg");
        const emailEl = document.getElementById("email");
        const pwEl = document.getElementById("pw");
        const pw2El = document.getElementById("pw2");
        const submitBtn = document.getElementById("submitBtn");

        const meterFill = document.getElementById("meterFill");
        const meterText = document.getElementById("meterText");

        const billingSame = document.getElementById("billing_same");
        const billingWrap = document.getElementById("billingWrap");
        const billingAddr = document.getElementById("billing_address");

        function showMsg(text, ok = false) {
        msg.style.display = "block";
        msg.className = "msg " + (ok ? "ok" : "err");
        msg.textContent = text;
        }
        function clearMsg() {
        msg.style.display = "none";
        msg.textContent = "";
        }

        billingSame.addEventListener("change", () => {
        billingWrap.style.display = billingSame.checked ? "none" : "block";
        });

        // Supports hash (#access_token=...) AND query (?access_token=...)
        function parseTokens() {
        const hash = new URLSearchParams((location.hash || "").replace(/^#/, ""));
        const qs = new URLSearchParams(location.search || "");

        const access_token = hash.get("access_token") || qs.get("access_token");
        const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");

        return { access_token, refresh_token };
        }

        function pwPolicy(pw) {
        const lenOk = pw.length >= 7 && pw.length <= 30;
        const upperOk = /[A-Z]/.test(pw);
        const numOk = /[0-9]/.test(pw);
        const specialOk = /[!@#$%^&*()]/.test(pw);
        const allowedOk = /^[A-Za-z0-9!@#$%^&*()]+$/.test(pw);
        return { lenOk, upperOk, numOk, specialOk, allowedOk };
        }

        function updateMeter() {
        const pw = pwEl.value || "";
        const p = pwPolicy(pw);

        let score = 0;
        if (p.lenOk) score++;
        if (p.upperOk) score++;
        if (p.numOk) score++;
        if (p.specialOk) score++;
        if (p.allowedOk) score++;

        const percent = Math.min(100, (score / 5) * 100);
        meterFill.style.width = percent + "%";

        let color = "rgba(255,60,120,75)";
        let label = "Weak";
        if (score >= 4) { color = "rgba(80,255,180,70)"; label = "Strong"; }
        else if (score >= 3) { color = "rgba(255,210,90,70)"; label = "Fine"; }

        meterFill.style.background = color;
        meterText.textContent = `${label} — Must be 7–30 chars; include 1 uppercase, 1 number, 1 special (!@#$%^&*()).`;
        }

        pwEl.addEventListener("input", updateMeter);

        async function requireInviteSession() {
        const { access_token, refresh_token } = parseTokens();

        if (!access_token || !refresh_token) {
            showMsg("Auth session missing. Please open the invite email link again (tokens not found).");
            submitBtn.disabled = true;
            return null;
        }

        const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) {
            showMsg("Invite session failed. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        history.replaceState({}, document.title, location.pathname);


        const user = data?.user;
        if (!user?.email) {
            showMsg("No user email found. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        emailEl.value = user.email;
        return user;
        }

        async function autofillFromInquiry(email) {
        const { data, error } = await sb
            .from("inquiries")
            .select("contact_name,business_name,phone")
            .eq("email", email)
            .order("created_at", { ascending: false })
            .limit(1);

        if (!error && data && data[0]) {
            const row = data[0];
            document.getElementById("contact_name").value = row.contact_name || "";
            document.getElementById("business_name").value = row.business_name || "";
            document.getElementById("phone").value = row.phone || "";
        }
        }

        const inviteUser = await requireInviteSession();
        if (inviteUser) await autofillFromInquiry(inviteUser.email);

        document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearMsg();

        const pw = pwEl.value || "";
        const pw2 = pw2El.value || "";
        const p = pwPolicy(pw);

        if (pw !== pw2) return showMsg("Passwords do not match.");
        if (!p.allowedOk) return showMsg("Password has invalid characters. Use only letters, numbers, and !@#$%^&*().");
        if (!(p.lenOk && p.upperOk && p.numOk && p.specialOk)) return showMsg("Password does not meet requirements.");

        const contact_name = document.getElementById("contact_name").value.trim();
        const business_name = document.getElementById("business_name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const business_location = document.getElementById("business_location").value.trim();
        const mailing_address = document.getElementById("mailing_address").value.trim();
        const billing_address = billingSame.checked ? mailing_address : (billingAddr.value || "").trim();

        if (!contact_name || !business_name || !business_location || !mailing_address || !billing_address) {
            return showMsg("Please fill in all required fields (business + addresses).");
        }

        submitBtn.disabled = true;

        try {
            // Ensure session exists
            const { data: s, error: sErr } = await sb.auth.getSession();
            if (sErr) throw sErr;

            const session = s?.session;
            if (!session?.user) throw new Error("Auth session missing. Please use invite link again.");

            const user = session.user;


            // 1) Set password
            const { error: pwErr } = await sb.auth.updateUser({ password: pw });
            if (pwErr) throw pwErr;

            // 2) Save profile
            const { error: profErr } = await sb
            .from("client_profiles")
            .upsert({
                user_id: user.id,
                email: user.email,
                contact_name,
                business_name,
                phone,
                business_location,
                mailing_address,
                billing_address
            }, { onConflict: "user_id" });

            if (profErr) throw profErr;

            showMsg("Account created. Redirecting to dashboard…", true);
            setTimeout(() => { window.location.href = "/sns-dashboard/index.html"; }, 900);
        } catch (err) {
            console.error(err);
            showMsg(err?.message || "Failed to create account.");
            submitBtn.disabled = false;
        }
        });
    })();
    
  </script>

  <script>
    (function(){
      const menu = document.getElementById("menu");
      const scrim = document.getElementById("scrim");
      const openBtn = document.getElementById("openMenu");
      const closeBtn = document.getElementById("closeMenu");
      if(!menu || !scrim || !openBtn || !closeBtn) return;

      function open(){
        menu.classList.add("open");
        scrim.classList.add("open");
        menu.setAttribute("aria-hidden","false");
        scrim.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function close(){
        menu.classList.remove("open");
        scrim.classList.remove("open");
        menu.setAttribute("aria-hidden","true");
        scrim.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      openBtn.addEventListener("click", open);
      closeBtn.addEventListener("click", close);
      scrim.addEventListener("click", close);
      window.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });
    })();
  </script>

  <script>
    (function(){
      const a = document.getElementById("viewDesktop");
      if (!a) return;
      a.addEventListener("click", function(e){
        e.preventDefault();
        localStorage.setItem("sns_force_desktop", "1");
        location.replace("/sns-portal-invite/");
      });
    })();
  </script>

</body>
</html>
