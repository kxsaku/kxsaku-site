<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Create Account (Mobile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://esm.sh; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com; img-src 'self' data: blob: https://*.supabase.co; font-src 'self'; frame-src https://js.stripe.com;" />
  <link href="/styles.css" rel="stylesheet"/>
  <style>
    /* =============================================
       Mobile Invite Page - Animated Background
       ============================================= */
    .bg {
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
      overflow: hidden;
    }
    .bg .glow {
      position: absolute;
      inset: -20%;
      background:
        radial-gradient(circle at 20% 25%, rgba(179,124,255,.22), transparent 55%),
        radial-gradient(circle at 85% 15%, rgba(94,234,212,.12), transparent 55%),
        radial-gradient(circle at 60% 80%, rgba(249,115,226,.14), transparent 55%);
      filter: blur(10px);
      animation: glowFloat 16s ease-in-out infinite alternate;
      opacity: .9;
    }
    @keyframes glowFloat {
      from { transform: translate3d(0,0,0) scale(1); }
      to { transform: translate3d(-18px, 12px, 0) scale(1.03); }
    }
    .bg .lines {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,.045) 0px, rgba(255,255,255,.045) 1px, transparent 1px, transparent 90px);
      opacity: .18;
      mask-image: linear-gradient(to bottom, #000 0%, #000 45%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, #000 0%, #000 45%, transparent 100%);
      animation: lineDrift 22s linear infinite;
    }
    @keyframes lineDrift {
      from { transform: translate3d(0,0,0); }
      to { transform: translate3d(-140px, 140px, 0); }
    }
    .bg .dots {
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,.20) 1px, transparent 1px), radial-gradient(rgba(255,255,255,.10) 1px, transparent 1px);
      background-size: 140px 140px, 220px 220px;
      background-position: 0 0, 40px 80px;
      opacity: .20;
      mask-image: linear-gradient(to bottom, #000 0%, #000 50%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, #000 0%, #000 50%, transparent 100%);
      animation: dotFloat 28s ease-in-out infinite alternate;
    }
    @keyframes dotFloat {
      from { transform: translate3d(0,0,0); }
      to { transform: translate3d(18px, -10px, 0); }
    }
    .bg .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 0%, rgba(0,0,0,.08), rgba(0,0,0,.64) 62%, rgba(0,0,0,.78));
      z-index: 1;
    }

    /* =============================================
       Mobile Header & Navigation
       ============================================= */
    .topnav {
      position: sticky;
      top: 0;
      z-index: 60;
      padding: .9rem 0;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(3,1,11,.78), rgba(3,1,11,.22));
      border-bottom: 1px solid var(--color-border-subtle);
    }
    .navrow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
    }
    .wrap {
      width: min(640px, calc(100% - 1.25rem));
      margin: 0 auto;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: .7rem;
      min-width: 0;
    }
    .mark {
      width: 42px;
      height: 42px;
      border-radius: var(--radius-sm);
      display: grid;
      place-items: center;
      box-shadow: var(--shadow-md);
      flex: 0 0 auto;
    }
    .mark img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
    }
    .brandText { min-width: 0; }
    .brand strong {
      display: block;
      font-size: .88rem;
      letter-spacing: .14em;
      text-transform: uppercase;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }
    .brand span {
      display: block;
      color: var(--color-text-muted2);
      font-size: .82rem;
      line-height: 1.1;
      margin-top: .18rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }

    /* Icon button (hamburger) */
    .iconBtn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border-subtle);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-sm);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform .14s ease, border-color .14s ease, filter .14s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active { transform: translateY(0); filter: brightness(1.04); }
    .iconBtn svg { opacity: .92; }

    /* Slide-down menu */
    .menu {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      z-index: 80;
      transform: translateY(-110%);
      transition: transform .24s cubic-bezier(.2,.9,.2,1);
      padding: 0.95rem 0 .9rem;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(3,1,11,.92), rgba(3,1,11,.58));
      border-bottom: 1px solid var(--color-border-subtle);
    }
    .menu.open { transform: translateY(0); }
    .menuHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid var(--color-border-subtle);
    }
    .menuLinks {
      display: grid;
      gap: .55rem;
      padding-top: .85rem;
    }
    .menuLinks a {
      text-decoration: none;
      color: var(--color-text-muted);
      font-size: .80rem;
      letter-spacing: .14em;
      text-transform: uppercase;
      padding: .8rem .95rem;
      border-radius: 16px;
      border: 1px solid var(--color-border-subtle);
      background: rgba(196,181,253,.04);
      transition: transform .14s ease, border-color .14s ease, filter .14s ease, background .14s ease, color .14s ease;
    }
    .menuLinks a:active {
      transform: translateY(0);
      border-color: var(--color-border);
      filter: brightness(1.04);
      color: var(--color-text-primary);
    }
    .menuLinks a.active {
      background: var(--color-accent-soft);
      border-color: var(--color-accent-border);
      color: var(--color-text-primary);
    }
    .menuActions {
      margin-top: .85rem;
      display: grid;
      gap: .65rem;
    }
    .menuActions .mobile-btn { width: 100%; }
    .scrim {
      position: fixed;
      inset: 0;
      z-index: 70;
      background: rgba(0,0,0,.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .scrim.open {
      opacity: 1;
      pointer-events: auto;
    }

    /* Mobile nav button style */
    .mobile-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      padding: 0 16px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--color-border-subtle);
      background: rgba(0,0,0,.18);
      color: var(--color-text-primary);
      text-decoration: none;
      font-weight: 800;
      font-size: .78rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      transition: transform .14s ease, border-color .14s ease, filter .14s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .mobile-btn:active {
      transform: translateY(0);
      filter: brightness(1.03);
    }

    /* =============================================
       Invite Form - Mobile Specific
       ============================================= */
    .pageWrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 2.0rem 1.0rem 3.0rem;
    }
    .invite-card {
      background: var(--color-surface-card);
      border: 1px solid var(--color-border-card);
      border-radius: var(--radius-xl);
      padding: 1.05rem 1.0rem;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(14px);
    }
    .invite-card h1 {
      margin: 0 0 .25rem;
      font-size: 1.1rem;
    }
    .invite-card p {
      margin: .4rem 0 1rem;
      color: var(--color-text-muted);
      line-height: 1.45;
    }
    .invite-card label {
      display: block;
      margin: .9rem 0 .35rem;
      font-size: .86rem;
      color: var(--color-text-label);
    }
    .invite-card input,
    .invite-card textarea,
    .invite-card select {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border-input);
      background: var(--color-surface-input);
      color: var(--color-text-primary);
      outline: none;
      font-size: 16px; /* prevent iOS zoom */
    }
    .invite-card input:focus,
    .invite-card textarea:focus,
    .invite-card select:focus {
      border-color: #9c88ff;
      box-shadow: 0 0 0 1px rgba(156, 136, 255, 0.55);
    }
    .invite-row {
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: .75rem !important;
    }
    .invite-btn {
      margin-top: 14px;
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-accent-soft);
      color: var(--color-text-primary);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      transition: transform 0.08s ease, border-color 0.12s ease, filter 0.12s ease;
    }
    .invite-btn:hover {
      border-color: var(--color-accent);
      filter: brightness(1.05);
    }
    .invite-btn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }
    .msg {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.12);
      display: none;
    }
    .msg.err {
      background: rgba(255,55,120,.10);
      border-color: rgba(255,55,120,.35);
    }
    .msg.ok {
      background: rgba(80,255,180,.08);
      border-color: rgba(80,255,180,.28);
    }
    .meterWrap { margin-top: 8px; }
    .meterBar {
      height: 10px;
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
    }
    .meterFill {
      height: 100%;
      width: 0%;
      transition: width .2s ease;
    }
    .hint {
      font-size: .85rem;
      color: var(--color-text-muted);
      margin-top: 6px;
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce) {
      .bg .glow, .bg .lines, .bg .dots { animation: none; }
      .menu, .scrim { transition: none; }
    }
  </style>
</head>
<body>
<div class="bg">
<div class="glow"></div>
<div class="lines"></div>
<div class="dots"></div>
<div class="vignette"></div>
</div>
<div aria-hidden="true" class="scrim" id="scrim"></div>
<aside aria-hidden="true" aria-label="Mobile Menu" class="menu" id="menu">
<div class="wrap">
<div class="menuHeader">
<div class="brand" style="gap:.65rem;">
<div class="mark" style="width:40px;height:40px;border-radius:14px;">
<img alt="Saku Network Solutions logo" src="/assets/sns-logo-purple.png"/>
</div>
<div class="brandText">
<strong>SAKU NETWORK SOLUTIONS</strong>
<span>Network infrastructure, done clean.</span>
</div>
</div>
<button aria-label="Close menu" class="iconBtn" id="closeMenu">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M6 6l12 12M18 6L6 18" stroke="rgba(244,240,255,.92)" stroke-linecap="round" stroke-width="2"></path>
</svg>
</button>
</div>
<nav aria-label="Primary" class="menuLinks">
<a href="/home/">Home</a>
<a href="/sns/">Services</a>
<a href="/credibility/">Credibility</a>
<a href="/resources/">Resources</a>
<a href="/contact/">Contact</a>
</nav>
<div class="menuActions">
<a class="mobile-btn" href="/sns-login/">Client Login</a>
<!-- Desktop preference -->
<a class="mobile-btn" href="#" id="viewDesktop">View Desktop Site</a>
</div>
</div>
</aside>
<header class="topnav">
<div class="wrap">
<div class="navrow">
<div class="brand">
<div class="mark">
<img alt="Saku Network Solutions logo" src="/assets/sns-logo-purple.png"/>
</div>
<div class="brandText">
<strong>SAKU NETWORK SOLUTIONS</strong>
<span>Network infrastructure, done clean.</span>
</div>
</div>
<button aria-label="Open menu" class="iconBtn" id="openMenu">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(244,240,255,.92)" stroke-linecap="round" stroke-width="2"></path>
</svg>
</button>
</div>
</div>
</header>
<div class="pageWrap">
<div class="invite-card">
<h1>Create Your SNS Account</h1>
<p>Set your password and confirm your business details. This account is invite-only.</p>
<div class="msg" id="msg"></div>
<form id="form">
<label>Email</label>
<input disabled="" id="email" type="email"/>
<div class="invite-row">
<div>
<label>Password</label>
<input autocomplete="new-password" id="pw" placeholder="Create a password" type="password"/>
<div class="meterWrap">
<div class="meterBar"><div class="meterFill" id="meterFill"></div></div>
<div class="hint" id="meterText">Must be 7–30 chars and include: 1 uppercase, 1 number, 1 special.</div>
</div>
</div>
<div>
<label>Confirm Password</label>
<input autocomplete="new-password" id="pw2" placeholder="Re-type password" type="password"/>
</div>
</div>
<hr style="border:none;border-top:1px solid rgba(255,255,255,.10); margin: 18px 0;"/>
<div class="invite-row">
<div>
<label>Contact Name</label>
<input id="contact_name"/>
</div>
<div>
<label>Business Name</label>
<input id="business_name"/>
</div>
</div>
<div class="invite-row">
<div>
<label>Phone</label>
<input id="phone" placeholder="+1..."/>
</div>
<div>
<label>Business Location</label>
<input id="business_location" placeholder="City, State (or full address if you want)"/>
</div>
</div>
<label>Mailing Address</label>
<input id="mailing_address" placeholder="Street, City, State, ZIP"/>
<div style="margin-top:10px;">
<label style="display:flex; gap:10px; align-items:center; margin:0;">
<input checked="" id="billing_same" style="width:auto;" type="checkbox"/>
            Billing Address is the same as Mailing Address
          </label>
</div>
<div id="billingWrap" style="display:none;">
<label>Billing Address</label>
<input id="billing_address" placeholder="Street, City, State, ZIP"/>
</div>
<button class="invite-btn" id="submitBtn" type="submit">Create Account</button>
</form>
</div>
</div><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" integrity="sha384-0cJhvyxOncqJDixLuJRbH99K17F1B6DH3D8aUBlsJlsgiqRZQpQ1EUFWdgscplLu" crossorigin="anonymous"></script><script>

      async function bootstrapSessionFromUrl() {
    // 1) If we already have a session in storage, use it.
    const { data: s0, error: e0 } = await sb.auth.getSession();
    if (e0) console.warn("getSession error:", e0);
    if (s0?.session) return s0.session;

    const url = new URL(window.location.href);

    // 2) PKCE/code flow: ?code=...
    const code = url.searchParams.get("code");
    if (code) {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      if (error) throw error;

      // Clean the URL (removes code from address bar)
      url.searchParams.delete("code");
      url.searchParams.delete("type");
      url.searchParams.delete("token");
      window.history.replaceState({}, document.title, url.pathname + (url.searchParams.toString() ? `?${url.searchParams}` : ""));

      return data.session;
    }

    // 3) Implicit/token flow: #access_token=...&refresh_token=...
    // Note: some browsers/email clients move hash tokens into query params.
    const hash = new URLSearchParams(window.location.hash.slice(1));
    const qs = new URLSearchParams(window.location.search);

    const access_token = hash.get("access_token") || qs.get("access_token");
    const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");


    if (access_token && refresh_token) {
      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      if (error) throw error;

      // Clean hash so refreshes don't re-run weirdly
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
      return data.session;
    }

    return null;
  }

  function showMsg(text, type = "error") {
    // your existing UI message function
    const el = document.getElementById("msg");
    if (!el) return alert(text);
    el.textContent = text;
    el.style.display = "block";
    el.dataset.type = type;
  }

  function getEmailFromUrl() {
    // Optional: if you pass email in query/hash; otherwise ignore
    const url = new URL(window.location.href);
    return url.searchParams.get("email") || "";
  }

  async function initInvitePage() {
    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Prefill email field from the *actual* authed user
      const emailInput = document.getElementById("email");
      if (emailInput) {
        emailInput.value = session.user.email ?? "";
        emailInput.readOnly = true;
      }

      // Clear any old error message if we’re good
      showMsg("", "ok");
      const msg = document.getElementById("msg");
      if (msg) msg.style.display = "none";
    } catch (err) {
      console.error(err);
      showMsg("Invite link is invalid or expired. Please request a new invite.", "error");
    }
  }

  document.addEventListener("DOMContentLoaded", initInvitePage);

  // IMPORTANT: your submit handler must NOT call getUser() before initInvitePage runs.
  document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Now safe to do:
      // 1) sb.auth.updateUser({ password })
      // 2) insert/update your profile/business fields in DB using session.user.id
      // ...your existing logic...
    } catch (err) {
      console.error(err);
      showMsg(err?.message || "Failed to create account.", "error");
    }
  });

    (async () => {
        const msg = document.getElementById("msg");
        const emailEl = document.getElementById("email");
        const pwEl = document.getElementById("pw");
        const pw2El = document.getElementById("pw2");
        const submitBtn = document.getElementById("submitBtn");

        const meterFill = document.getElementById("meterFill");
        const meterText = document.getElementById("meterText");

        const billingSame = document.getElementById("billing_same");
        const billingWrap = document.getElementById("billingWrap");
        const billingAddr = document.getElementById("billing_address");

        function showMsg(text, ok = false) {
        msg.style.display = "block";
        msg.className = "msg " + (ok ? "ok" : "err");
        msg.textContent = text;
        }
        function clearMsg() {
        msg.style.display = "none";
        msg.textContent = "";
        }

        billingSame.addEventListener("change", () => {
        billingWrap.style.display = billingSame.checked ? "none" : "block";
        });

        // Supports hash (#access_token=...) AND query (?access_token=...)
        function parseTokens() {
        const hash = new URLSearchParams((location.hash || "").replace(/^#/, ""));
        const qs = new URLSearchParams(location.search || "");

        const access_token = hash.get("access_token") || qs.get("access_token");
        const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");

        return { access_token, refresh_token };
        }

        function pwPolicy(pw) {
        const lenOk = pw.length >= 7 && pw.length <= 30;
        const upperOk = /[A-Z]/.test(pw);
        const numOk = /[0-9]/.test(pw);
        const specialOk = /[!@#$%^&*()]/.test(pw);
        const allowedOk = /^[A-Za-z0-9!@#$%^&*()]+$/.test(pw);
        return { lenOk, upperOk, numOk, specialOk, allowedOk };
        }

        function updateMeter() {
        const pw = pwEl.value || "";
        const p = pwPolicy(pw);

        let score = 0;
        if (p.lenOk) score++;
        if (p.upperOk) score++;
        if (p.numOk) score++;
        if (p.specialOk) score++;
        if (p.allowedOk) score++;

        const percent = Math.min(100, (score / 5) * 100);
        meterFill.style.width = percent + "%";

        let color = "rgba(255,60,120,75)";
        let label = "Weak";
        if (score >= 4) { color = "rgba(80,255,180,70)"; label = "Strong"; }
        else if (score >= 3) { color = "rgba(255,210,90,70)"; label = "Fine"; }

        meterFill.style.background = color;
        meterText.textContent = `${label} — Must be 7–30 chars; include 1 uppercase, 1 number, 1 special (!@#$%^&*()).`;
        }

        pwEl.addEventListener("input", updateMeter);

        async function requireInviteSession() {
        const { access_token, refresh_token } = parseTokens();

        if (!access_token || !refresh_token) {
            showMsg("Auth session missing. Please open the invite email link again (tokens not found).");
            submitBtn.disabled = true;
            return null;
        }

        const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) {
            showMsg("Invite session failed. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        history.replaceState({}, document.title, location.pathname);


        const user = data?.user;
        if (!user?.email) {
            showMsg("No user email found. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        emailEl.value = user.email;
        return user;
        }

        async function autofillFromInquiry(email) {
        const { data, error } = await sb
            .from("inquiries")
            .select("contact_name,business_name,phone")
            .eq("email", email)
            .order("created_at", { ascending: false })
            .limit(1);

        if (!error && data && data[0]) {
            const row = data[0];
            document.getElementById("contact_name").value = row.contact_name || "";
            document.getElementById("business_name").value = row.business_name || "";
            document.getElementById("phone").value = row.phone || "";
        }
        }

        const inviteUser = await requireInviteSession();
        if (inviteUser) await autofillFromInquiry(inviteUser.email);

        document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearMsg();

        const pw = pwEl.value || "";
        const pw2 = pw2El.value || "";
        const p = pwPolicy(pw);

        if (pw !== pw2) return showMsg("Passwords do not match.");
        if (!p.allowedOk) return showMsg("Password has invalid characters. Use only letters, numbers, and !@#$%^&*().");
        if (!(p.lenOk && p.upperOk && p.numOk && p.specialOk)) return showMsg("Password does not meet requirements.");

        const contact_name = document.getElementById("contact_name").value.trim();
        const business_name = document.getElementById("business_name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const business_location = document.getElementById("business_location").value.trim();
        const mailing_address = document.getElementById("mailing_address").value.trim();
        const billing_address = billingSame.checked ? mailing_address : (billingAddr.value || "").trim();

        if (!contact_name || !business_name || !business_location || !mailing_address || !billing_address) {
            return showMsg("Please fill in all required fields (business + addresses).");
        }

        submitBtn.disabled = true;

        try {
            // Ensure session exists
            const { data: s, error: sErr } = await sb.auth.getSession();
            if (sErr) throw sErr;

            const session = s?.session;
            if (!session?.user) throw new Error("Auth session missing. Please use invite link again.");

            const user = session.user;


            // 1) Set password
            const { error: pwErr } = await sb.auth.updateUser({ password: pw });
            if (pwErr) throw pwErr;

            // 2) Save profile
            const { error: profErr } = await sb
            .from("client_profiles")
            .upsert({
                user_id: user.id,
                email: user.email,
                contact_name,
                business_name,
                phone,
                business_location,
                mailing_address,
                billing_address
            }, { onConflict: "user_id" });

            if (profErr) throw profErr;

            showMsg("Account created. Redirecting to dashboard…", true);
            setTimeout(() => { window.location.href = "/sns-dashboard/index.html"; }, 900);
        } catch (err) {
            console.error(err);
            showMsg(err?.message || "Failed to create account.");
            submitBtn.disabled = false;
        }
        });
    })();
    </script>


  <script>

  const { createClient } = supabase;

  const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function bootstrapSessionFromUrl() {
    // 1) If we already have a session in storage, use it.
    const { data: s0, error: e0 } = await sb.auth.getSession();
    if (e0) console.warn("getSession error:", e0);
    if (s0?.session) return s0.session;

    const url = new URL(window.location.href);

    // 2) PKCE/code flow: ?code=...
    const code = url.searchParams.get("code");
    if (code) {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      if (error) throw error;

      // Clean the URL (removes code from address bar)
      url.searchParams.delete("code");
      url.searchParams.delete("type");
      url.searchParams.delete("token");
      window.history.replaceState({}, document.title, url.pathname + (url.searchParams.toString() ? `?${url.searchParams}` : ""));

      return data.session;
    }

    // 3) Implicit/token flow: #access_token=...&refresh_token=...
    // Note: some browsers/email clients move hash tokens into query params.
    const hash = new URLSearchParams(window.location.hash.slice(1));
    const qs = new URLSearchParams(window.location.search);

    const access_token = hash.get("access_token") || qs.get("access_token");
    const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");


    if (access_token && refresh_token) {
      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      if (error) throw error;

      // Clean hash so refreshes don't re-run weirdly
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
      return data.session;
    }

    return null;
  }

  function showMsg(text, type = "error") {
    // your existing UI message function
    const el = document.getElementById("msg");
    if (!el) return alert(text);
    el.textContent = text;
    el.style.display = "block";
    el.dataset.type = type;
  }

  function getEmailFromUrl() {
    // Optional: if you pass email in query/hash; otherwise ignore
    const url = new URL(window.location.href);
    return url.searchParams.get("email") || "";
  }

  async function initInvitePage() {
    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Prefill email field from the *actual* authed user
      const emailInput = document.getElementById("email");
      if (emailInput) {
        emailInput.value = session.user.email ?? "";
        emailInput.readOnly = true;
      }

      // Clear any old error message if we’re good
      showMsg("", "ok");
      const msg = document.getElementById("msg");
      if (msg) msg.style.display = "none";
    } catch (err) {
      console.error(err);
      showMsg("Invite link is invalid or expired. Please request a new invite.", "error");
    }
  }

  document.addEventListener("DOMContentLoaded", initInvitePage);

  // IMPORTANT: your submit handler must NOT call getUser() before initInvitePage runs.
  document.getElementById("inviteForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const session = await bootstrapSessionFromUrl();
      if (!session?.user) {
        showMsg("Auth session missing. Please open a fresh invite link.", "error");
        return;
      }

      // Now safe to do:
      // 1) sb.auth.updateUser({ password })
      // 2) insert/update your profile/business fields in DB using session.user.id
      // ...your existing logic...
    } catch (err) {
      console.error(err);
      showMsg(err?.message || "Failed to create account.", "error");
    }
  });

    (async () => {
        const msg = document.getElementById("msg");
        const emailEl = document.getElementById("email");
        const pwEl = document.getElementById("pw");
        const pw2El = document.getElementById("pw2");
        const submitBtn = document.getElementById("submitBtn");

        const meterFill = document.getElementById("meterFill");
        const meterText = document.getElementById("meterText");

        const billingSame = document.getElementById("billing_same");
        const billingWrap = document.getElementById("billingWrap");
        const billingAddr = document.getElementById("billing_address");

        function showMsg(text, ok = false) {
        msg.style.display = "block";
        msg.className = "msg " + (ok ? "ok" : "err");
        msg.textContent = text;
        }
        function clearMsg() {
        msg.style.display = "none";
        msg.textContent = "";
        }

        billingSame.addEventListener("change", () => {
        billingWrap.style.display = billingSame.checked ? "none" : "block";
        });

        // Supports hash (#access_token=...) AND query (?access_token=...)
        function parseTokens() {
        const hash = new URLSearchParams((location.hash || "").replace(/^#/, ""));
        const qs = new URLSearchParams(location.search || "");

        const access_token = hash.get("access_token") || qs.get("access_token");
        const refresh_token = hash.get("refresh_token") || qs.get("refresh_token");

        return { access_token, refresh_token };
        }

        function pwPolicy(pw) {
        const lenOk = pw.length >= 7 && pw.length <= 30;
        const upperOk = /[A-Z]/.test(pw);
        const numOk = /[0-9]/.test(pw);
        const specialOk = /[!@#$%^&*()]/.test(pw);
        const allowedOk = /^[A-Za-z0-9!@#$%^&*()]+$/.test(pw);
        return { lenOk, upperOk, numOk, specialOk, allowedOk };
        }

        function updateMeter() {
        const pw = pwEl.value || "";
        const p = pwPolicy(pw);

        let score = 0;
        if (p.lenOk) score++;
        if (p.upperOk) score++;
        if (p.numOk) score++;
        if (p.specialOk) score++;
        if (p.allowedOk) score++;

        const percent = Math.min(100, (score / 5) * 100);
        meterFill.style.width = percent + "%";

        let color = "rgba(255,60,120,75)";
        let label = "Weak";
        if (score >= 4) { color = "rgba(80,255,180,70)"; label = "Strong"; }
        else if (score >= 3) { color = "rgba(255,210,90,70)"; label = "Fine"; }

        meterFill.style.background = color;
        meterText.textContent = `${label} — Must be 7–30 chars; include 1 uppercase, 1 number, 1 special (!@#$%^&*()).`;
        }

        pwEl.addEventListener("input", updateMeter);

        async function requireInviteSession() {
        const { access_token, refresh_token } = parseTokens();

        if (!access_token || !refresh_token) {
            showMsg("Auth session missing. Please open the invite email link again (tokens not found).");
            submitBtn.disabled = true;
            return null;
        }

        const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) {
            showMsg("Invite session failed. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        history.replaceState({}, document.title, location.pathname);


        const user = data?.user;
        if (!user?.email) {
            showMsg("No user email found. Please request a new invite.");
            submitBtn.disabled = true;
            return null;
        }

        emailEl.value = user.email;
        return user;
        }

        async function autofillFromInquiry(email) {
        const { data, error } = await sb
            .from("inquiries")
            .select("contact_name,business_name,phone")
            .eq("email", email)
            .order("created_at", { ascending: false })
            .limit(1);

        if (!error && data && data[0]) {
            const row = data[0];
            document.getElementById("contact_name").value = row.contact_name || "";
            document.getElementById("business_name").value = row.business_name || "";
            document.getElementById("phone").value = row.phone || "";
        }
        }

        const inviteUser = await requireInviteSession();
        if (inviteUser) await autofillFromInquiry(inviteUser.email);

        document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearMsg();

        const pw = pwEl.value || "";
        const pw2 = pw2El.value || "";
        const p = pwPolicy(pw);

        if (pw !== pw2) return showMsg("Passwords do not match.");
        if (!p.allowedOk) return showMsg("Password has invalid characters. Use only letters, numbers, and !@#$%^&*().");
        if (!(p.lenOk && p.upperOk && p.numOk && p.specialOk)) return showMsg("Password does not meet requirements.");

        const contact_name = document.getElementById("contact_name").value.trim();
        const business_name = document.getElementById("business_name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const business_location = document.getElementById("business_location").value.trim();
        const mailing_address = document.getElementById("mailing_address").value.trim();
        const billing_address = billingSame.checked ? mailing_address : (billingAddr.value || "").trim();

        if (!contact_name || !business_name || !business_location || !mailing_address || !billing_address) {
            return showMsg("Please fill in all required fields (business + addresses).");
        }

        submitBtn.disabled = true;

        try {
            // Ensure session exists
            const { data: s, error: sErr } = await sb.auth.getSession();
            if (sErr) throw sErr;

            const session = s?.session;
            if (!session?.user) throw new Error("Auth session missing. Please use invite link again.");

            const user = session.user;


            // 1) Set password
            const { error: pwErr } = await sb.auth.updateUser({ password: pw });
            if (pwErr) throw pwErr;

            // 2) Save profile
            const { error: profErr } = await sb
            .from("client_profiles")
            .upsert({
                user_id: user.id,
                email: user.email,
                contact_name,
                business_name,
                phone,
                business_location,
                mailing_address,
                billing_address
            }, { onConflict: "user_id" });

            if (profErr) throw profErr;

            showMsg("Account created. Redirecting to dashboard…", true);
            setTimeout(() => { window.location.href = "/sns-dashboard/index.html"; }, 900);
        } catch (err) {
            console.error(err);
            showMsg(err?.message || "Failed to create account.");
            submitBtn.disabled = false;
        }
        });
    })();
    
  </script>

  <script>
    (function(){
      const menu = document.getElementById("menu");
      const scrim = document.getElementById("scrim");
      const openBtn = document.getElementById("openMenu");
      const closeBtn = document.getElementById("closeMenu");
      if(!menu || !scrim || !openBtn || !closeBtn) return;

      function open(){
        menu.classList.add("open");
        scrim.classList.add("open");
        menu.setAttribute("aria-hidden","false");
        scrim.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function close(){
        menu.classList.remove("open");
        scrim.classList.remove("open");
        menu.setAttribute("aria-hidden","true");
        scrim.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      openBtn.addEventListener("click", open);
      closeBtn.addEventListener("click", close);
      scrim.addEventListener("click", close);
      window.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });
    })();
  </script>

  <script>
    (function(){
      const a = document.getElementById("viewDesktop");
      if (!a) return;
      a.addEventListener("click", function(e){
        e.preventDefault();
        localStorage.setItem("sns_force_desktop", "1");
        location.replace("/sns-portal-invite/");
      });
    })();
  </script>

</body>
</html>
