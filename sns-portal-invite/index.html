<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SNS · Create Account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body{ margin:0; background: radial-gradient(circle at top, #342067, #050315 55%, #020010); color:#f4f0ff; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width: 860px; margin: 0 auto; padding: 3rem 1rem 4rem; }
    .card{ background: rgba(7,4,25,.78); border: 1px solid rgba(129,118,255,.25); border-radius: 18px; padding: 18px; box-shadow: 0 18px 60px rgba(0,0,0,.5); backdrop-filter: blur(14px); }
    h1{ margin:0 0 .25rem; letter-spacing:.14em; text-transform:uppercase; font-size:1.1rem; }
    p{ margin:.4rem 0 1rem; color: rgba(244,240,255,.82); line-height:1.45; }
    label{ display:block; margin:.9rem 0 .35rem; font-size:.9rem; color: rgba(244,240,255,.9); }
    input, textarea, select{
      width:100%; padding: 12px 12px; border-radius: 12px;
      border:1px solid rgba(129,118,255,.25);
      background: rgba(10,6,35,.65);
      color:#f4f0ff; outline:none;
    }
    input:focus, textarea:focus, select:focus{ border-color: rgba(129,118,255,.55); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap: 14px; }
    @media (max-width: 720px){ .row{ grid-template-columns:1fr; } }
    .btn{
      margin-top: 14px;
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(129,118,255,.35);
      background: rgba(129,118,255,.18);
      color:#f4f0ff;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .msg{ margin-top: 12px; padding: 12px 14px; border-radius: 14px; border:1px solid rgba(255,255,255,.12); display:none; }
    .msg.err{ background: rgba(255,55,120,.10); border-color: rgba(255,55,120,.35); }
    .msg.ok{ background: rgba(80,255,180,.08); border-color: rgba(80,255,180,.28); }
    .meterWrap{ margin-top: 8px; }
    .meterBar{ height: 10px; border-radius: 999px; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.10); overflow:hidden; }
    .meterFill{ height:100%; width:0%; transition: width .2s ease; }
    .hint{ font-size:.85rem; color: rgba(244,240,255,.72); margin-top: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Create Your SNS Account</h1>
      <p>Set your password and confirm your business details. This account is invite-only.</p>

      <div id="msg" class="msg"></div>

      <form id="form">
        <label>Email</label>
        <input id="email" type="email" disabled />

        <div class="row">
          <div>
            <label>Password</label>
            <input id="pw" type="password" autocomplete="new-password" placeholder="Create a password" />
            <div class="meterWrap">
              <div class="meterBar"><div id="meterFill" class="meterFill"></div></div>
              <div id="meterText" class="hint">Must be 7–30 chars and include: 1 uppercase, 1 number, 1 special.</div>
            </div>
          </div>
          <div>
            <label>Confirm Password</label>
            <input id="pw2" type="password" autocomplete="new-password" placeholder="Re-type password" />
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.10); margin: 18px 0;" />

        <div class="row">
          <div>
            <label>Contact Name</label>
            <input id="contact_name" />
          </div>
          <div>
            <label>Business Name</label>
            <input id="business_name" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Phone</label>
            <input id="phone" placeholder="+1..." />
          </div>
          <div>
            <label>Business Location</label>
            <input id="business_location" placeholder="City, State (or full address if you want)" />
          </div>
        </div>

        <label>Mailing Address</label>
        <input id="mailing_address" placeholder="Street, City, State, ZIP" />

        <div style="margin-top:10px;">
          <label style="display:flex; gap:10px; align-items:center; margin:0;">
            <input id="billing_same" type="checkbox" style="width:auto;" checked />
            Billing Address is the same as Mailing Address
          </label>
        </div>

        <div id="billingWrap" style="display:none;">
          <label>Billing Address</label>
          <input id="billing_address" placeholder="Street, City, State, ZIP" />
        </div>

        <button id="submitBtn" class="btn" type="submit">Create Account</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://jgvxmpsjtkedzgygynbl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpndnhtcHNqdGtlZHpneWd5bmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzgxMjYsImV4cCI6MjA4MTA1NDEyNn0.OCh23RWm8COtxWuumYvKUmfMOLOW01B1zrbtzcr3w6Y";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const msg = document.getElementById("msg");
    const emailEl = document.getElementById("email");
    const pwEl = document.getElementById("pw");
    const pw2El = document.getElementById("pw2");
    const submitBtn = document.getElementById("submitBtn");

    const meterFill = document.getElementById("meterFill");
    const meterText = document.getElementById("meterText");

    const billingSame = document.getElementById("billing_same");
    const billingWrap = document.getElementById("billingWrap");
    const billingAddr = document.getElementById("billing_address");

    billingSame.addEventListener("change", () => {
      billingWrap.style.display = billingSame.checked ? "none" : "block";
    });

    function showMsg(text, ok=false){
      msg.style.display = "block";
      msg.className = "msg " + (ok ? "ok" : "err");
      msg.textContent = text;
    }

    function clearMsg(){ msg.style.display="none"; msg.textContent=""; }

    function parseHashTokens(){
      // Supabase puts access_token / refresh_token in URL hash after verify redirect
      const h = new URLSearchParams((location.hash || "").replace(/^#/, ""));
      const access_token = h.get("access_token");
      const refresh_token = h.get("refresh_token");
      return { access_token, refresh_token };
    }

    function pwPolicy(pw){
      // 7-30, at least 1 uppercase, 1 number, 1 special, allowed: letters/numbers/normal specials
      const lenOk = pw.length >= 7 && pw.length <= 30;
      const upperOk = /[A-Z]/.test(pw);
      const numOk = /[0-9]/.test(pw);
      const specialOk = /[!@#$%^&*()]/.test(pw);
      const allowedOk = /^[A-Za-z0-9!@#$%^&*()]+$/.test(pw);
      return { lenOk, upperOk, numOk, specialOk, allowedOk };
    }

    function updateMeter(){
      const pw = pwEl.value || "";
      const p = pwPolicy(pw);

      // Simple scoring
      let score = 0;
      if (p.lenOk) score++;
      if (p.upperOk) score++;
      if (p.numOk) score++;
      if (p.specialOk) score++;
      if (p.allowedOk) score++;

      const percent = Math.min(100, (score/5)*100);
      meterFill.style.width = percent + "%";

      // Color: red (weak), yellow (fine), green (strong)
      let color = "rgba(255,60,120,.75)";
      let label = "Weak";
      if (score >= 4) { color = "rgba(80,255,180,.70)"; label = "Strong"; }
      else if (score >= 3) { color = "rgba(255,210,90,.70)"; label = "Fine"; }
      meterFill.style.background = color;
      meterText.textContent = `${label} — Must be 7–30 chars; include 1 uppercase, 1 number, 1 special (!@#$%^&*()).`;
    }

    pwEl.addEventListener("input", updateMeter);

    async function requireInviteSession(){
      const { access_token, refresh_token } = parseHashTokens();
      if (!access_token || !refresh_token) {
        showMsg("This invite link is missing login tokens. Please use the invite email link again.");
        submitBtn.disabled = true;
        return null;
      }

      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      if (error) {
        showMsg("Invite session failed. Please request a new invite.");
        submitBtn.disabled = true;
        return null;
      }

      const user = data?.user;
      if (!user?.email) {
        showMsg("No user email found. Please request a new invite.");
        submitBtn.disabled = true;
        return null;
      }

      emailEl.value = user.email;
      return user;
    }

    async function autofillFromInquiry(email){
      // Pull most recent inquiry for same email to prefill basics
      const { data, error } = await sb
        .from("inquiries")
        .select("contact_name,business_name,phone")
        .eq("email", email)
        .order("created_at", { ascending:false })
        .limit(1);

      if (!error && data && data[0]) {
        const row = data[0];
        document.getElementById("contact_name").value = row.contact_name || "";
        document.getElementById("business_name").value = row.business_name || "";
        document.getElementById("phone").value = row.phone || "";
      }
    }

    const user = await requireInviteSession();
    if (user) await autofillFromInquiry(user.email);

    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();

      const pw = pwEl.value || "";
      const pw2 = pw2El.value || "";
      const p = pwPolicy(pw);

      if (pw !== pw2) return showMsg("Passwords do not match.");
      if (!p.allowedOk) return showMsg("Password has invalid characters. Use only letters, numbers, and !@#$%^&*().");
      if (!(p.lenOk && p.upperOk && p.numOk && p.specialOk)) return showMsg("Password does not meet requirements.");

      const contact_name = document.getElementById("contact_name").value.trim();
      const business_name = document.getElementById("business_name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const business_location = document.getElementById("business_location").value.trim();
      const mailing_address = document.getElementById("mailing_address").value.trim();
      const billing_address = billingSame.checked ? mailing_address : billingAddr.value.trim();

      if (!contact_name || !business_name || !business_location || !mailing_address || !billing_address) {
        return showMsg("Please fill in all required fields (business + addresses).");
      }

      submitBtn.disabled = true;

      try {
        // 1) Set password for invited user
        const { error: pwErr } = await sb.auth.updateUser({ password: pw });
        if (pwErr) throw pwErr;

        // 2) Save profile details (assumes your SQL created these columns)
        const { error: profErr } = await sb
          .from("client_profiles")
          .upsert({
            user_id: user.id,
            email: user.email,
            contact_name,
            business_name,
            phone,
            business_location,
            mailing_address,
            billing_address
          }, { onConflict: "user_id" });

        if (profErr) throw profErr;

        showMsg("Account created. Redirecting to dashboard…", true);
        setTimeout(() => { window.location.href = "/sns-dashboard/index.html"; }, 900);
      } catch (err) {
        console.error(err);
        showMsg(err?.message || "Failed to create account.");
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
